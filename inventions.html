<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<meta name="robots" content="noindex, nofollow"/>
<title>BeAwarely – Inventions</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{
    --bg:#0b0d14; --panel:#0f1424; --panel2:#0c1222; --text:#eaf0ff; --muted:#aab2d5;
    --b1:#1a2236; --b2:#24304b; --chip:#0e1a33; --chip-b:#2a3b6a; --accent:#5aa8ff;
    --shadow:0 10px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial;background:var(--bg);color:var(--text)}
  header{position:sticky;top:0;z-index:5;background:rgba(11,13,20,.7);backdrop-filter:blur(8px);border-bottom:1px solid rgba(255,255,255,.06)}
  .bar{max-width:1100px;margin:0 auto;padding:14px 16px;display:flex;gap:12px;align-items:center}
  .back{appearance:none;border:1px solid rgba(255,255,255,.1);background:transparent;color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
  .back:hover{border-color:rgba(255,255,255,.25);transform:translateY(-1px)}
  .title{font-weight:800;letter-spacing:.2px}
  .sp{flex:1}

  .wrap{max-width:1100px;margin:18px auto 70px;padding:0 16px}
  .lead{color:var(--muted);margin-top:6px}
  .controls{display:grid;grid-template-columns:1fr;gap:10px;margin:16px 0}
  @media (min-width:760px){.controls{grid-template-columns:1fr auto}}

  .search{display:flex;align-items:center;gap:10px;padding:12px 14px;border-radius:12px;background:var(--panel);border:1px solid var(--b1);box-shadow:var(--shadow)}
  .search input{flex:1;background:transparent;border:0;outline:0;color:var(--text);font-size:15px}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{background:var(--chip);border:1px solid var(--chip-b);color:var(--text);padding:8px 12px;border-radius:999px;cursor:pointer;font-size:13px}
  .chip.active{border-color:var(--accent);box-shadow:0 0 0 2px rgba(90,168,255,.2) inset}
  .chip:hover{border-color:rgba(255,255,255,.25)}

  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px}
  .card{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--b1);border-radius:16px;padding:16px;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:10px;min-height:190px}
  .muted{color:var(--muted)}
  .badge{display:inline-block;padding:4px 8px;border-radius:999px;background:var(--chip);border:1px solid var(--chip-b);font-size:.8rem}
  .catline{display:flex;flex-wrap:wrap;gap:6px}
  .peek{white-space:pre-wrap;background:var(--panel2);border:1px solid var(--b2);border-radius:12px;padding:10px;max-height:180px;overflow:auto}
  .foot{display:flex;justify-content:space-between;align-items:center;margin-top:auto}
  .btn{appearance:none;background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.12);padding:8px 12px;border-radius:10px;cursor:not-allowed;opacity:.7}

  .sk{height:190px;padding:16px;border-radius:16px;border:1px solid var(--b1);background:var(--panel);position:relative;overflow:hidden}
  .sk::after{content:"";position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.06),transparent);animation:sh 1.1s infinite}
  @keyframes sh{from{transform:translateX(-100%)}to{transform:translateX(100%)}}
  .sk1{height:18px;width:70%;background:rgba(255,255,255,.06);border-radius:8px}
  .sk2{height:12px;width:45%;background:rgba(255,255,255,.06);border-radius:8px;margin-top:8px}
  .sk3{height:12px;width:90%;background:rgba(255,255,255,.06);border-radius:8px;margin-top:16px}
  .sk4{height:12px;width:85%;background:rgba(255,255,255,.06);border-radius:8px;margin-top:6px}

  .state{margin:24px 0;padding:14px;border-radius:12px;border:1px dashed rgba(255,255,255,.18);background:rgba(255,255,255,.03);text-align:center;color:var(--muted)}
  .load-wrap{display:flex;justify-content:center;margin-top:16px}
  .load{padding:10px 16px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:var(--panel);color:var(--text);cursor:pointer}
  .load[disabled]{opacity:.6;cursor:not-allowed}
</style>
</head>
<body>
<header>
  <div class="bar">
    <button class="back" onclick="location.href='index.html'">← Back to Home</button>
    <div class="title">Public Inventions</div>
    <div class="sp"></div>
  </div>
</header>

<main class="wrap">
  <h1 style="margin:0 0 6px">BeAwarely – Inventions</h1>
  <p class="lead">Approved ideas. “Partial” = redacted public version.</p>

  <section class="controls">
    <div class="search">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M21 21l-3.9-3.9M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
      <input id="q" type="search" placeholder="Search… (title, summary, category)"/>
    </div>
    <div class="chips" id="chips"></div>
  </section>

  <section id="grid" class="grid" aria-live="polite"></section>
  <div id="empty" class="state" hidden>No inventions to show yet.</div>
  <div id="err" class="state" hidden>Could not load inventions. Please try again.</div>

  <div class="load-wrap">
    <button id="loadMore" class="load" hidden>Load more</button>
  </div>
</main>

<script>
  // Supabase client (zachowuję Twoje wartości)
  const SB_URL='https://xzwpqyomqjzmiqsszwkg.supabase.co';
  const SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh6d3BxeW9tcWp6bWlxc3N6d2tnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0MjIxMTYsImV4cCI6MjA2OTk5ODExNn0.QbjDO1xifFkDuIAZZ9WHfGomgxwhanP9BQtgMrFqDgg';
  const sb = window.supabase.createClient(SB_URL, SB_KEY, {
  auth: {
    persistSession: true,
    autoRefreshToken: true,
    detectSessionInUrl: true
  }
});


  const state = { q:"", category:"All", page:0, size:12, total:0, cats:new Set() };
  const els = {
    grid: document.getElementById('grid'),
    empty: document.getElementById('empty'),
    err: document.getElementById('err'),
    load: document.getElementById('loadMore'),
    q: document.getElementById('q'),
    chips: document.getElementById('chips'),
  };

  const esc = s => (s??"").toString().replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#39;");
  const peekJSON = (obj, max=500) => {
    try{ const str = JSON.stringify(obj, null, 2); return str.length>max ? str.slice(0,max)+"…" : str; }
    catch{ return "—"; }
  };

  function skels(n=state.size){
    els.grid.innerHTML = "";
    for(let i=0;i<n;i++){
      const c = document.createElement('div');
      c.className='sk';
      c.innerHTML = `<div class="sk1"></div><div class="sk2"></div><div class="sk3"></div><div class="sk4"></div>`;
      els.grid.appendChild(c);
    }
    els.empty.hidden = true; els.err.hidden = true; els.load.hidden = true;
  }

  function card(r){
    const title = r.public_title || 'Untitled concept';
    const sum = r.public_summary || '—';
    const cats = Array.isArray(r.categories) ? r.categories : (r.categories ? [r.categories] : []);
    cats.forEach(c => state.cats.add(c));
    const isPartial = r.visibility==='partial';
    const shown = isPartial ? (r.redacted_outputs || {}) : (r.outputs || {});
    const preview = peekJSON(shown, 400);

    return `
      <article class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
          <h3 style="margin:0;font-size:16px;line-height:1.3">${esc(title)}</h3>
          <span class="badge" title="visibility">${esc(r.visibility||'')}</span>
        </div>
        <div class="muted" style="margin:6px 0">${esc(sum)}</div>
        <div class="catline">
          ${cats.slice(0,6).map(c=>`<span class="badge">${esc(c)}</span>`).join('')}
        </div>
        <pre class="peek">${esc(preview)}</pre>
        <div class="foot">
          <span class="muted" style="font-size:12px">${isPartial?'redacted preview':'full preview'}</span>
          <button class="btn" disabled>Details soon</button>
        </div>
      </article>
    `;
  }

  function render(data, append=false){
    if(!append) els.grid.innerHTML = "";
    (data||[]).forEach(r => els.grid.insertAdjacentHTML('beforeend', card(r)));

    // chips
    const cats = ['All', ...Array.from(state.cats).filter(Boolean).sort((a,b)=>a.localeCompare(b))];
    els.chips.innerHTML = cats.map(c=>`<button class="chip ${c===state.category?'active':''}" data-cat="${esc(c)}">${esc(c)}</button>`).join('');
    els.chips.querySelectorAll('.chip').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        state.category = btn.dataset.cat;
        state.page=0; state.total=0;
        fetchPage({reset:true});
      });
    });

    els.empty.hidden = (data && data.length) || els.grid.children.length;
  }

  async function fetchPage({reset=false}={}){
    try{
      if(reset) skels();
      const from = state.page * state.size;
      const to = from + state.size - 1;

      let q = sb.from('inventor_ideas')
        .select('id,public_title,public_summary,categories,visibility,outputs,redacted_outputs', { count:'exact' })
        .eq('status','approved')
        .in('visibility',['public','partial'])
        .order('created_at',{ascending:false})
        .range(from, to);

      if(state.q){
        const like = `%${state.q}%`;
        q = q.or([
          `public_title.ilike.${like}`,
          `public_summary.ilike.${like}`,
          `categories.cs.{${state.q}}` // jeśli categories to text[], dopasuje zawartość
        ].join(','));
      }
      if(state.category && state.category!=='All'){
        // gdy categories to array → contains
        q = q.contains('categories', [state.category]);
      }

      const { data, error, count } = await q;
      if(error) throw error;

      state.total = count ?? 0;
      render(data, !reset);

      const shown = Math.min((state.page+1)*state.size, state.total);
      els.load.hidden = shown >= state.total;
      els.err.hidden = true;
    }catch(e){
      console.error(e);
      els.err.hidden = false;
      els.load.hidden = true;
      if(reset){ els.grid.innerHTML=""; }
    }
  }

  // search (debounce)
  let t=null;
  els.q.addEventListener('input', ()=>{
    clearTimeout(t);
    t = setTimeout(()=>{
      state.q = els.q.value.trim();
      state.page=0; state.total=0;
      fetchPage({reset:true});
    }, 250);
  });

  // pagination
  els.load.addEventListener('click', ()=>{
    state.page += 1;
    fetchPage();
  });

  // boot
  (async ()=>{
    skels();
    await fetchPage({reset:true});
  })();
</script>
</body>
</html>
