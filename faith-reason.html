<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="robots" content="noindex, nofollow"/>
  <title>Faith & Reason — BeAwarely</title>
  <link rel="stylesheet" href="css/style.css"/>


  <style>
        :root{
      /* Dark navy palette */
      --bg:#0b1220;              /* page background (deep navy) */
      --panel:#101a33;           /* panels / cards (navy) */
      --muted:#a7b4d9;           /* secondary text */
      --text:#eaf2ff;            /* primary text */
      --accent:#7bb0ff;          /* links / accents (soft blue) */
      --ok:#4ade80; --warn:#fbbf24; --bad:#fb7185;
      --ring: rgba(123,176,255,.45);
    }

    *{box-sizing:border-box}
        body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial;background:var(--bg);color:var(--text)}

    header.topbar{
  position:sticky;top:0;z-index:50;background:rgba(12,20,36,.72);backdrop-filter:saturate(140%) blur(8px);
  border-bottom:1px solid rgba(126,156,210,.16);display:flex;align-items:center;gap:.75rem;padding:.8rem 1rem;
  box-shadow:0 8px 24px rgba(0,0,0,.18);
}

    .back-btn{appearance:none;border:1px solid rgba(255,255,255,.15);padding:.45rem .75rem;border-radius:.75rem;color:#fff;background:transparent;cursor:pointer}
    .back-btn:hover{border-color:rgba(255,255,255,.3)}
    main{max-width:1100px;margin:0 auto;padding:1.1rem}
    h1{font-size:1.6rem;margin:.15rem 0 0}
    h2{font-size:1.05rem;color:var(--muted);margin:.2rem 0 .2rem}
    .card{
  background:linear-gradient(180deg,#101a33,#0c162b);
  border:1px solid rgba(126,156,210,.16);
  border-radius:16px;padding:1rem;margin:.8rem 0;
  box-shadow:0 12px 28px rgba(2,8,20,.28);
}

    .row{display:grid;grid-template-columns:1fr 1fr;gap:.8rem}
    @media (max-width:900px){ .row{grid-template-columns:1fr} }
    label{display:block;font-size:.9rem;color:#cbd5ff;margin:.25rem 0}
      input[type="text"], textarea, select{
  width:100%;
  background:#0b1426; color:var(--text);
  border:1px solid rgba(126,156,210,.18);
  border-radius:10px; padding:.6rem .7rem; outline:none;
  transition:border-color .15s ease, box-shadow .15s ease, background .15s ease;
}
input[type="text"]:focus-visible, textarea:focus-visible, select:focus-visible{
  border-color:rgba(123,176,255,.6);
  box-shadow:0 0 0 3px var(--ring);
}


    textarea{min-height:120px;resize:vertical}
    .chips{display:flex;flex-wrap:wrap;gap:.4rem}
        .chip{
  font-size:.8rem;border:1px solid rgba(126,156,210,.28);border-radius:999px;
  padding:.25rem .6rem;color:#cfd6ff;cursor:pointer;
  transition:border-color .15s ease, background .15s ease;
}
.chip:hover{ border-color:rgba(126,156,210,.45); background:#0b1426; }

    .chip.active{background:#0b1426;border-color:rgba(126,156,210,.5)}
    html.light .chip.active{background:#eef2f9;border-color:#bfc9e2}

    .pill{
  display:inline-block;border:1px solid rgba(126,156,210,.26);border-radius:999px;
  padding:.2rem .55rem;margin:.15rem .25rem 0 0;font-size:.8rem;color:#cfd6ff
}
/* status coloring for item badges */
.pill.pending{ border-color:rgba(251,191,36,.55); background:rgba(251,191,36,.10); color:#fbd38d; }
.pill.confirmed{ border-color:rgba(74,222,128,.55); background:rgba(74,222,128,.10); color:#9cf3c1; }
.pill.disputed{ border-color:rgba(251,113,133,.6); background:rgba(251,113,133,.10); color:#feb2c0; }

    .muted{color:#aab2d5}
      .btn{
  appearance:none;border:1px solid rgba(126,156,210,.26);background:#13203a;color:var(--text);border-radius:10px;
  padding:.55rem .9rem;cursor:pointer;transition:transform .12s ease, border-color .15s ease, box-shadow .15s ease;
  will-change:transform;
}
.btn:hover{ transform:translateY(-1px); border-color:rgba(126,156,210,.4); }
.btn:active{ transform:translateY(0); }
.btn:focus-visible{ box-shadow:0 0 0 3px var(--ring); }

    .btn[disabled]{opacity:.6;cursor:not-allowed;filter:saturate(.7)}

    .btn.primary{border-color:rgba(90,168,255,.5);box-shadow:0 0 0 3px transparent}
    .btn.primary:focus{box-shadow:0 0 0 3px var(--ring)}
    .btn.warn{border-color:rgba(251,191,36,.5)}
    .btn.bad{border-color:rgba(251,113,133,.5)}
    .tools{display:flex;gap:.5rem;flex-wrap:wrap}
    .status-dot{display:inline-flex;align-items:center;gap:.4rem}
        .dot{width:8px;height:8px;border-radius:50%}
    .dot.pending{background:var(--warn)}
    .dot.confirmed{background:var(--ok)}
    .dot.disputed{background:var(--bad)}
    .dot.online{background:var(--ok)}

    .grid{display:grid;grid-template-columns:2fr 1fr;gap:.9rem}
    @media (max-width:1000px){ .grid{grid-template-columns:1fr} }
        .item{
  border:1px solid rgba(126,156,210,.16);border-radius:14px;padding:.8rem;background:#0e1830;
  transition:border-color .15s ease, transform .12s ease;
}
.item:hover{ border-color:rgba(126,156,210,.32); transform:translateY(-1px); }


    .item h4{margin:.1rem 0 .4rem}
    .meta{font-size:.8rem;color:#aab2d5}
        .evidence a{color:#8fb7ff;text-decoration:none;border-bottom:1px dotted rgba(143,183,255,.45)}

    .evidence a:hover{border-bottom-color:transparent}
.evidence ul{ list-style:disc; margin:.2rem 0 0 1.1rem; padding:0; }

    .filters{display:flex;gap:.5rem;flex-wrap:wrap}
    .reaction-bar{display:flex;gap:.4rem;flex-wrap:wrap;margin-top:.4rem}
    .reaction-bar .btn{font-size:.85rem}
    .small{font-size:.85rem}
    .danger{color:#feb2c0}
    .good{color:#9cf3c1}
        .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;background:#0b1426;border:1px solid rgba(126,156,210,.2);border-radius:6px;padding:.06rem .4rem}

    .help{font-size:.85rem;color:#c9d1ff}
   /* ——— Light mode overrides (light grays + soft blue) ——— */
html.light body{background:#f6f8fc;color:#0b1220}
html.light header.topbar{background:rgba(255,255,255,.82);border-bottom:1px solid rgba(0,32,64,.08)}
html.light .back-btn{color:#0b1220;border-color:rgba(0,32,64,.18)}
html.light .back-btn:hover{border-color:rgba(0,32,64,.32)}
html.light .card{background:linear-gradient(180deg,#ffffff,#eef3fb);border:1px solid #d5dbea}
html.light label{color:#2b3b55}
html.light .muted{color:#5b6475}
html.light input[type="text"],html.light textarea,html.light select{background:#ffffff;color:#0b1220;border:1px solid #d5dbea}
html.light .chip,html.light .pill{border-color:#cfd7e6;color:#3b4a66}
html.light .btn{background:#eef2f9;color:#0b1220;border-color:#d5dbea}
html.light .btn.primary{border-color:rgba(43,95,214,.5)}
html.light .item{background:#ffffff;border:1px solid #d5dbea}
html.light .evidence a{color:#1d4ed8;border-bottom-color:rgba(29,78,216,.35)}
html.light .kbd{background:#ffffff;border:1px solid #d5dbea}

/* AI dock (jak w WorkVerify, z zielonym akcentem) */
.ai-dock{
  position:fixed; right:18px; bottom:18px; width:min(360px, 92vw);
  background: linear-gradient(180deg, #0d1f14, #12361f);
  border:1px solid rgba(88,196,140,.25); border-radius:14px; padding:12px;
  box-shadow: 0 10px 24px rgba(12,20,40,.45); z-index: 10001; color:#DFF7EA;
}
.ai-dock .muted, .ai-dock small{ color:#9DD7B8; }
.ai-dock textarea{ color:#DFF7EA; background: rgba(255,255,255,.03); border:1px solid rgba(88,196,140,.25); }
.ai-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px; }
.ai-toggle{ padding:4px 10px; }
.ai-dock .actions{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
.ai-dock .btn{
  background: linear-gradient(135deg, #2FA36B, #70D39A);
  border:1px solid rgba(88,196,140,.25);
  box-shadow: 0 6px 16px rgba(63,173,118,.35);
}
.ai-dock .btn.secondary{
  background: transparent; color: #DFF7EA;
  border:1px solid rgba(88,196,140,.25); box-shadow: none;
}
.ai-dock.collapsed textarea, .ai-dock.collapsed .actions, .ai-dock.collapsed .ai-notes{ display:none; }
.ai-notes{ font-size:12px; line-height:1.35; margin-top:8px; }
.ai-notes ul{ margin:6px 0 0 18px; padding:0; }
.ai-notes li{ margin:4px 0; }

html.light .ai-dock{
  background: linear-gradient(180deg, #ECF5EF, #E3F0E8);
  border-color: rgba(29,105,76,.18); color:#103322;
}
html.light .ai-dock .muted, html.light .ai-dock small{ color:#3a6a52; }
html.light .ai-dock textarea{ background: rgba(14,23,48,.025); border-color: rgba(29,105,76,.18); color:#103322; }


</style>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // --- Supabase bootstrap (twarde fallbacki dla bezpośredniego wejścia na stronę) ---
    const SUPABASE_URL =
      window.SUPABASE_URL ||
      localStorage.getItem('BA_SUPABASE_URL') ||
      'https://xzwpqyomqjzmiqsszwkg.supabase.co';

    const SUPABASE_ANON_KEY =
      window.SUPABASE_ANON_KEY ||
      localStorage.getItem('BA_SUPABASE_ANON') ||
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh6d3BxeW9tcWp6bWlxc3N6d2tnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0MjIxMTYsImV4cCI6MjA2OTk5ODExNn0.QbjDO1xifFkDuIAZZ9WHfGomgxwhanP9BQtgMrFqDgg';

    // utrwal fallbacki, by kolejne strony miały te same wartości
    if (!localStorage.getItem('BA_SUPABASE_URL')) localStorage.setItem('BA_SUPABASE_URL', SUPABASE_URL);
    if (!localStorage.getItem('BA_SUPABASE_ANON')) localStorage.setItem('BA_SUPABASE_ANON', SUPABASE_ANON_KEY);

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    async function waitForInitialSession() {
      const { data } = await supabaseClient.auth.getSession();
      if (data?.session) return data.session;
      return new Promise(resolve => {
        const { data: sub } = supabaseClient.auth.onAuthStateChange((_e, session) => {
          sub.subscription?.unsubscribe?.();
          resolve(session || null);
        });
      });
    }

    // Brama: wymagaj zalogowania
    (async () => {
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (!session) {
        localStorage.setItem('ba_redirect', 'faith-reason.html');
        location.replace('index.html?login=1');
        return;
      }
      window.BA_SESSION = session;
    })();
  </script>

<script>
  // Theme init + toggle (persists in localStorage)
  (function(){
    const saved = localStorage.getItem('ba_theme');
    const prefers = window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';
    const mode = saved || prefers;
    document.documentElement.classList.toggle('light', mode === 'light');

    function setIcon(){
      const b = document.getElementById('themeToggle');
      if(!b) return;
      const isLight = document.documentElement.classList.contains('light');
      b.textContent = isLight ? '🌙' : '☀️';
      b.title = isLight ? 'Switch to dark' : 'Switch to light';
    }

    window.addEventListener('DOMContentLoaded', ()=>{
      setIcon();
      const btn = document.getElementById('themeToggle');
      if(btn){
        btn.addEventListener('click', ()=>{
          const isLight = document.documentElement.classList.toggle('light');
          localStorage.setItem('ba_theme', isLight ? 'light' : 'dark');
          setIcon();
        });
      }
    });
  })();
</script>
</head>

<body>
  <header class="topbar">
    <button class="back-btn" onclick="location.href='index.html'">← Back</button>
    <div>
      <h1>Faith & Reason</h1>
      <h2 class="muted">Religions, rules, absurdities, manipulation — and the good you can keep without any institution.</h2>
    </div>
    <div style="margin-left:auto;display:flex;gap:.5rem;align-items:center">
    <span class="dot online" style="margin-right:.25rem"></span><span id="userBadge" class="pill">…</span>

      <button id="logoutBtn" class="btn" style="display:none">Logout</button>
      <button id="themeToggle" class="btn">🌙</button>
    </div>
  </header>

  <main>
    <!-- Submit new item -->
    <section class="card">
      <h3>Contribute a Finding</h3>
      <p class="help">Logged-in users can add items. AI pre-check will block spam/porn/hate and estimate confidence. Community can later vote and add evidence.</p>

      <div class="row">
        <div>
          <label>Religion / Tradition</label>
          <div class="chips" id="presetReligions"></div>
          <input id="religion" type="text" placeholder="e.g., Christianity/Catholic, Islam/Sunni, Buddhism, Other…"/>

          <label style="margin-top:.6rem">Category</label>
          <select id="category">
            <option value="absurdity">Absurdity</option>
            <option value="manipulation">Manipulation/Abuse</option>
            <option value="positive">Positive/Value to keep</option>
            <option value="history">Historical context</option>
            <option value="claim">Unconfirmed claim</option>
          </select>

          <label style="margin-top:.6rem">Title</label>
          <input id="title" type="text" placeholder="Short, clear headline of the case"/>
        </div>
        <div>
          <label>Summary / Description</label>
          <textarea id="summary" placeholder="Describe what happened, who, when, why it matters. Avoid insults; stick to facts."></textarea>

          <label style="margin-top:.6rem">Evidence links (one per line)</label>
          <textarea id="evidence" class="small" placeholder="https://...&#10;https://..."></textarea>

          <div class="tools" style="margin-top:.6rem">
            <button id="btnSubmit" class="btn primary">Submit for AI pre-check →</button>
            <span id="submitMsg" class="muted" aria-live="polite"></span>
          </div>
        </div>
      </div>
    </section>

    <!-- Filters -->
    <section class="card">
      <div class="filters">
        <select id="filterReligion">
          <option value="">All religions</option>
          <option>Christianity/Catholic</option>
          <option>Christianity/Protestant</option>
          <option>Christianity/Orthodox</option>
          <option>Islam/Sunni</option>
          <option>Islam/Shia</option>
          <option>Judaism</option>
          <option>Hinduism</option>
          <option>Buddhism</option>
          <option>Taoism</option>
          <option>Confucianism</option>
          <option>Indigenous/Folk</option>
          <option>New Religious Movements</option>
          <option>Other</option>
        </select>
        <select id="filterCategory">
          <option value="">All categories</option>
          <option value="absurdity">Absurdity</option>
          <option value="manipulation">Manipulation/Abuse</option>
          <option value="positive">Positive</option>
          <option value="history">Historical</option>
          <option value="claim">Unconfirmed</option>
        </select>
        <select id="filterStatus">
          <option value="">Any status</option>
          <option value="pending_ai">AI check pending</option>
          <option value="ai_flagged">AI flagged</option>
          <option value="awaiting_confirmation">Awaiting confirmation</option>
          <option value="confirmed">Confirmed</option>
          <option value="disputed">Disputed</option>
        </select>
        <button id="btnRefresh" class="btn">Refresh</button>
      </div>
    </section>

    <!-- AI Assist dock — Faith & Reason -->
<div id="aiDockFR" class="ai-dock collapsed">
  <div class="ai-head">
    <strong>AI Assist — Faith & Reason</strong>
    <button class="pill ai-toggle" type="button"
      onclick="document.getElementById('aiDockFR').classList.toggle('collapsed')">Toggle</button>
  </div>
  <textarea id="aiInputFR" rows="3" placeholder="Ask for neutrality check, missing evidence, or a concise rewrite…"></textarea>
  <div class="actions">
    <button id="aiUseDraftBtnFR" class="btn secondary" type="button">Use my draft</button>
    <button id="aiReviewBtnFR" class="btn" type="button">Review draft</button>
    <button id="aiAskBtnFR" class="btn" type="button">Ask AI</button>
    <button id="aiAddNoteBtnFR" class="btn secondary" type="button">Add note</button>
    <button id="aiClearNotesBtnFR" class="btn secondary" type="button">Clear notes</button>
  </div>
  <div id="aiNotesFR" class="ai-notes muted"></div>
</div>


    <!-- List -->

    <section class="grid">
      <div id="items"></div>
      <aside>
        <div class="card">
          <h3>Status legend</h3>
          <p class="status-dot"><span class="dot pending"></span>Pending (AI/Confirmation)</p>
          <p class="status-dot"><span class="dot confirmed"></span>Confirmed</p>
          <p class="status-dot"><span class="dot disputed"></span>Disputed/Flagged</p>
          <hr style="border-color:rgba(255,255,255,.08)"/>
          <p class="small">Reactions:</p>
          <div class="chips">
            <span class="chip">“True”</span>
            <span class="chip">“Likely”</span>
            <span class="chip">“Uncertain”</span>
            <span class="chip">“False”</span>
            <span class="chip">“Misleading”</span>
          </div>
          <p class="help" style="margin-top:.4rem">Edits require justification and new evidence; AI screens edits for abuse.</p>
          <p class="help">Report content to moderators with a clear reason.</p>
        </div>
      </aside>
    </section>
  </main>

  <template id="itemTpl">
    <div class="item">
      <div class="meta">
        <span class="pill __religion"></span>
        <span class="pill __category"></span>
        <span class="pill __status"></span>
        <span class="pill">AI: <span class="__aiscore">0</span>%</span>
      </div>
      <h4 class="__title">Title</h4>
      <p class="muted __summary">Summary...</p>
      <div class="evidence __evidence"></div>

      <div class="reaction-bar">
        <button class="btn" data-verdict="true">True</button>
        <button class="btn" data-verdict="likely">Likely</button>
        <button class="btn" data-verdict="uncertain">Uncertain</button>
        <button class="btn warn" data-verdict="misleading">Misleading</button>
        <button class="btn bad" data-verdict="false">False</button>
        <button class="btn" data-action="edit">Suggest edit</button>
        <button class="btn bad" data-action="flag">Report</button>
      </div>

      <div class="small muted __agg" style="margin-top:.35rem"></div>
    </div>
  </template>

  <template id="editDlgTpl">
    <div class="card">
      <h4>Edit proposal</h4>
      <label>New title (optional)</label>
      <input type="text" class="e-title"/>
      <label style="margin-top:.4rem">New summary (optional)</label>
      <textarea class="e-summary"></textarea>
      <label style="margin-top:.4rem">New evidence links (one per line, optional)</label>
      <textarea class="e-evidence small" placeholder="https://...&#10;https://..."></textarea>
      <label style="margin-top:.4rem">Justification (required)</label>
      <textarea class="e-why" placeholder="Explain why this change is needed; add references."></textarea>
      <div class="tools" style="margin-top:.5rem">
        <button class="btn primary e-submit">Submit edit</button>
        <button class="btn e-cancel">Cancel</button>
        <span class="muted e-msg"></span>
      </div>
    </div>
  </template>

  <template id="flagDlgTpl">
    <div class="card">
      <h4>Report item</h4>
      <label>Reason</label>
      <select class="f-reason">
        <option value="spam">Spam</option>
        <option value="porn">Porn/NSFW</option>
        <option value="hate">Hate/Harassment</option>
        <option value="privacy">Privacy violation</option>
        <option value="other">Other</option>
      </select>
      <label style="margin-top:.4rem">Details</label>
      <textarea class="f-details" placeholder="What is wrong? Provide specifics."></textarea>
      <div class="tools" style="margin-top:.5rem">
        <button class="btn bad f-submit">Send report</button>
        <button class="btn f-cancel">Cancel</button>
        <span class="muted f-msg"></span>
      </div>
    </div>
  </template>

  <script>
    const PRESET_RELIGIONS = [
      "Christianity/Catholic","Christianity/Protestant","Christianity/Orthodox",
      "Islam/Sunni","Islam/Shia","Judaism","Hinduism","Buddhism",
      "Taoism","Confucianism","Indigenous/Folk","New Religious Movements","Other"
    ];

    function el(tag, cls){ const n = document.createElement(tag); if (cls) n.className = cls; return n; }

        function renderPresetChips(){
      const box = document.getElementById('presetReligions');
      const input = document.getElementById('religion');
      PRESET_RELIGIONS.forEach(r => {
        const c = el('span','chip'); c.textContent = r;
        c.onclick = () => {
          input.value = r;
          // visual select
          box.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
          c.classList.add('active');
        };
        box.appendChild(c);
      });
      // sync when user types manually (clear visual)
      input.addEventListener('input', ()=> box.querySelectorAll('.chip').forEach(x=>x.classList.remove('active')));
    }


    function statusLabel(s){
      if (s === 'confirmed') return 'Confirmed';
      if (s === 'awaiting_confirmation') return 'Awaiting confirmation';
      if (s === 'ai_flagged') return 'AI flagged';
      if (s === 'disputed') return 'Disputed';
      return 'AI pending';
    }

    function statusClass(s){
      if (s === 'confirmed') return 'confirmed';
      if (s === 'disputed' || s === 'ai_flagged') return 'disputed';
      return 'pending';
    }

    function linkifyEvidence(arr){
  if (!Array.isArray(arr)) return [];
  return arr.filter(Boolean).map(u=>{
    const a = document.createElement('a');
    a.href = u; a.target = '_blank'; a.rel = 'noopener noreferrer'; a.textContent = u;
    return a;
  });
}

    async function submitNewItem(){
  const btn = document.getElementById('btnSubmit');
  const out = document.getElementById('submitMsg');
  btn.disabled = true; out.textContent = 'Submitting…';

  const religion = document.getElementById('religion').value.trim();
  const category = document.getElementById('category').value;
  const title = document.getElementById('title').value.trim();
  const summary = document.getElementById('summary').value.trim();
  const evidenceRaw = document.getElementById('evidence').value.split('\n').map(s=>s.trim()).filter(Boolean);
  if (!religion || !category || !title || !summary){
    out.textContent = 'Fill religion, category, title, summary.'; btn.disabled = false; return;
  }

  // ensure session
  const sess = window.BA_SESSION || (await supabaseClient.auth.getSession()).data?.session;
  if (!sess){ out.textContent = 'Login required.'; btn.disabled = false; return; }

  // INSERT new item (z autorem dla RLS)
  const { data: ins, error: insErr } = await supabaseClient
    .from('faith_items')
    .insert({
      author: sess.user.id,
      religion, category, title, summary,
      evidence_links: evidenceRaw, status: 'pending_ai'
    })
    .select().single();

  if (insErr){
    out.textContent = 'Save error: '+ (insErr.message || insErr); btn.disabled = false; return;
  }

  // Kolejka AI (jeśli RPC istnieje)
  try {
    await supabaseClient.rpc('ai_queue_verify_faith_item', { p_item_id: ins.id });
    out.textContent = 'Item saved. AI pre-check queued. It will appear after refresh.';
  } catch(e){
    out.textContent = 'Item saved. (AI queue not configured yet).';
  }

  // reset & refresh
  document.getElementById('title').value='';
  document.getElementById('summary').value='';
  document.getElementById('evidence').value='';
  await refreshList();
  btn.disabled = false;
}

    async function fetchItems(){
      const r = document.getElementById('filterReligion').value;
      const c = document.getElementById('filterCategory').value;
      const s = document.getElementById('filterStatus').value;

      let q = supabaseClient.from('faith_items').select('*').order('created_at',{ascending:false}).limit(100);
      if (r) q = q.eq('religion', r);
      if (c) q = q.eq('category', c);
      if (s) q = q.eq('status', s);

      const { data, error } = await q;
      if (error){ console.warn(error); return []; }
      return data || [];
    }

    async function fetchAggVotes(itemId){
      const { data, error } = await supabaseClient
        .from('faith_votes')
        .select('verdict')
        .eq('item_id', itemId);
      if (error || !data) return {};
      const agg = { true:0, likely:0, uncertain:0, false:0, misleading:0 };
      data.forEach(v => { if (agg[v.verdict] !== undefined) agg[v.verdict]++; });
      return agg;
    }

    async function castVote(itemId, verdict){
      const { data: sess } = await supabaseClient.auth.getSession();
      if (!sess?.session){ alert('Login required'); return; }

      // upsert by UNIQUE(item_id, voter)
      const { error } = await supabaseClient.from('faith_votes').upsert({
        item_id: itemId, voter: sess.session.user.id, verdict
      }, { onConflict: 'item_id,voter' });

      if (error){ alert('Vote error: '+error.message); }
      await refreshList();
    }

    function openEditDialog(item){
      const t = document.getElementById('editDlgTpl').content.cloneNode(true);
      const dlg = el('div'); dlg.appendChild(t);
      Object.assign(dlg.style,{position:'fixed',inset:'0',background:'rgba(0,0,0,.6)',display:'grid',placeItems:'center',padding:'1rem',zIndex:80});
      document.body.appendChild(dlg);

      const title = dlg.querySelector('.e-title');
      const summary = dlg.querySelector('.e-summary');
      const evidence = dlg.querySelector('.e-evidence');
      const why = dlg.querySelector('.e-why');
      const msg = dlg.querySelector('.e-msg');

      title.value = item.title;
      summary.value = item.summary;
      evidence.value = (item.evidence_links||[]).join('\n');

           dlg.querySelector('.e-cancel').onclick = ()=> dlg.remove();
      dlg.querySelector('.e-submit').onclick = async ()=>{
  const new_title = title.value.trim();
  const new_summary = summary.value.trim();
  const new_evidence_links = evidence.value.split('\n').map(s=>s.trim()).filter(Boolean);
  const justification = why.value.trim();
  if (!justification){ msg.textContent = 'Justification required.'; return; }

  const sess = window.BA_SESSION || (await supabaseClient.auth.getSession()).data?.session;
  if (!sess){ msg.textContent = 'Login required.'; return; }

  const { data: ins, error } = await supabaseClient.from('faith_edits').insert({
    item_id: item.id,
    editor: sess.user.id,
    new_title, new_summary, new_evidence_links, justification
  }).select('id').single();

  if (error){ msg.textContent = 'Error: '+error.message; return; }
  try { await supabaseClient.rpc('ai_queue_verify_faith_edit', { p_edit_id: ins.id }); } catch(_){}
  msg.textContent = 'Edit submitted. Awaiting review/AI.';
  setTimeout(()=> dlg.remove(), 900);
};

    }

    function openFlagDialog(item){
      const t = document.getElementById('flagDlgTpl').content.cloneNode(true);
      const dlg = el('div'); dlg.appendChild(t);
      Object.assign(dlg.style,{position:'fixed',inset:'0',background:'rgba(0,0,0,.6)',display:'grid',placeItems:'center',padding:'1rem',zIndex:80});
      document.body.appendChild(dlg);

      const reason = dlg.querySelector('.f-reason');
      const details = dlg.querySelector('.f-details');
      const msg = dlg.querySelector('.f-msg');

      dlg.querySelector('.f-cancel').onclick = ()=> dlg.remove();
      dlg.querySelector('.f-submit').onclick = async ()=>{
  const r = reason.value; const det = details.value.trim();
  const sess = window.BA_SESSION || (await supabaseClient.auth.getSession()).data?.session;
  if (!sess){ msg.textContent = 'Login required.'; return; }
  const { error } = await supabaseClient.from('faith_flags').insert({
    item_id: item.id,
    reporter: sess.user.id,
    reason: r, details: det
  });
  if (error){ msg.textContent = 'Error: '+error.message; return; }
  msg.textContent = 'Report sent to moderators.';
  setTimeout(()=> dlg.remove(), 800);
};

    }

    function mountItemCard(item){
      const tpl = document.getElementById('itemTpl').content.cloneNode(true);
      tpl.querySelector('.__religion').textContent = item.religion;
      tpl.querySelector('.__category').textContent = item.category;
      const sLbl = statusLabel(item.status);
      tpl.querySelector('.__status').textContent = sLbl;
      tpl.querySelector('.__status').classList.add(statusClass(item.status));
      tpl.querySelector('.__aiscore').textContent = Math.round(item.ai_score || 0);
      tpl.querySelector('.__title').textContent = item.title;
      tpl.querySelector('.__summary').textContent = item.summary;

      const evBox = tpl.querySelector('.__evidence');
      const links = linkifyEvidence(item.evidence_links);
      if (links && links.length){
        const ul = el('ul'); ul.style.margin = '.2rem 0 0 1rem';
        links.forEach(a => { const li = el('li'); li.appendChild(a); ul.appendChild(li); });
        evBox.appendChild(ul);
      } else {
        evBox.innerHTML = '<span class="muted small">No evidence provided yet.</span>';
      }

      // wire votes
      tpl.querySelectorAll('[data-verdict]').forEach(btn=>{
        btn.onclick = () => castVote(item.id, btn.dataset.verdict);
      });
      // edit
      tpl.querySelector('[data-action="edit"]').onclick = ()=> openEditDialog(item);
      // flag
      tpl.querySelector('[data-action="flag"]').onclick = ()=> openFlagDialog(item);

      const container = el('div');
      container.appendChild(tpl);

      // fetch aggregates
      fetchAggVotes(item.id).then(agg=>{
        const aggBox = container.querySelector('.__agg');
        const parts = [];
        Object.entries(agg).forEach(([k,v])=> { if (v>0) parts.push(`${k}:${v}`); });
        aggBox.textContent = parts.length ? `Votes — ${parts.join(' · ')}` : 'No votes yet';
      });

      return container.firstElementChild;
    }

    async function refreshList(){
      const box = document.getElementById('items');
      box.innerHTML = '';
      const items = await fetchItems();
      if (!items.length){
        const empty = el('div','card'); empty.innerHTML = '<span class="muted">No items match filters.</span>';
        box.appendChild(empty); return;
      }
      items.forEach(item => box.appendChild(mountItemCard(item)));
        }

    // --- AI dock (Faith & Reason, styl WorkVerify) ---
let _lastUserId = 'anon';

function getFaithContext(){
  const religion = (document.getElementById('religion')?.value || '').trim();
  const category = (document.getElementById('category')?.value || '').trim();
  const title = (document.getElementById('title')?.value || '').trim();
  const summary = (document.getElementById('summary')?.value || '').trim();
  const evidence = (document.getElementById('evidence')?.value || '')
    .split('\n').map(s=>s.trim()).filter(Boolean);
  return { religion, category, title, summary, evidence };
}

function escapeHTML(s){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[m])); }

const NOTES_KEY_FR = ()=> `fr_notes_${_lastUserId}`;
function readNotesFR(){ try{ return JSON.parse(localStorage.getItem(NOTES_KEY_FR())||'[]'); }catch(e){ return []; } }
function writeNotesFR(arr){ localStorage.setItem(NOTES_KEY_FR(), JSON.stringify(arr)); }
function renderNotesFR(){
  const el = document.getElementById('aiNotesFR'); if(!el) return;
  const notes = readNotesFR();
  if(!notes.length){ el.innerHTML = '<small>No notes yet.</small>'; return; }
  el.innerHTML = '<small>Notes:</small><ul>' + notes.map(n=>`<li>${escapeHTML(n)}</li>`).join('') + '</ul>';
}
function addNoteFR(text){
  const notes = readNotesFR();
  notes.unshift(text);
  writeNotesFR(notes.slice(0,30));
  renderNotesFR();
}

function buildFRContext(){
  const ctx = getFaithContext();
  return `Faith & Reason context
Religion: ${ctx.religion || '—'}
Category: ${ctx.category || '—'}
Title: ${ctx.title || '—'}
Summary:
${ctx.summary || '(no summary)'}
Evidence:
${(ctx.evidence||[]).length ? ctx.evidence.map(x=>'- '+x).join('\n') : '(none)'}
---
Task: ${(document.getElementById('aiInputFR')?.value || 'Review neutrality and bias, suggest missing evidence, and provide a concise neutral rewrite.').trim()}`;
}

// Lokalny „review” (bez sieci) – heurystyki dopasowane do tej karty
function reviewDraftLocallyFR(){
  const ctx = getFaithContext();
  const issues = [];

  if ((ctx.summary||'').length < 60) issues.push('Summary is short — add who/what/when/where and outcome.');
  if (!(ctx.evidence||[]).length) issues.push('No evidence links — add at least one reputable source.');
  if ((ctx.title||'').length > 90) issues.push('Title is long — aim for under ~80 characters.');

  const generalizations = /\b(always|never|all|everyone|nobody|every|wszyscy|zawsze|nigdy)\b/i;
  if (generalizations.test(ctx.summary)) issues.push('Avoid blanket generalizations (“always/never/all”). Be specific and contextual.');

  const flagged = ['idiot','debil','stupid','sekta','heretic','infidel','nienawi','hate','idiota','oszust'];
  const found = flagged.filter(w => new RegExp(`\\b${w}\\w*\\b`, 'i').test(ctx.summary));
  if (found.length) issues.push(`Inflammatory language detected (${found.join(', ')}) — use neutral wording.`);

  if (!issues.length) addNoteFR('No obvious tone/privacy issues found. Ensure fairness and cite sources.');
  else issues.forEach(addNoteFR);

  const aiIn = document.getElementById('aiInputFR');
  if (aiIn) aiIn.value = 'Please help me rewrite my draft to be neutral and respectful. Keep facts, avoid generalizations, and list suggested evidence types.';
  alert('Draft reviewed. See notes in the dock.');
}

// Połączenie z Edge Function (opcjonalnie — „Ask AI”)
async function askAI_FR(){
  const input = document.getElementById('aiInputFR');
  const btn = document.getElementById('aiAskBtnFR');
  if(!input) return;
  const prompt = (input.value||'').trim();
  if(!prompt){ input.focus(); return; }
  btn && (btn.disabled = true);
  try{
    const context = getFaithContext();
    const { data, error } = await supabaseClient.functions.invoke('faith-chat', {
      body: { prompt, context, page: 'faith-reason' }
    });
    if (error) throw error;
    const reply = (data && (data.reply || data.text)) || 'No reply';
    addNoteFR('AI: ' + reply);
    input.value = '';
  }catch(e){
    addNoteFR('AI error: ' + (e?.message || e));
  }finally{
    btn && (btn.disabled = false);
  }
}

function initAIDockFR(){
  const useDraft = document.getElementById('aiUseDraftBtnFR');
  const review   = document.getElementById('aiReviewBtnFR');
  const addBtn   = document.getElementById('aiAddNoteBtnFR');
  const clearBtn = document.getElementById('aiClearNotesBtnFR');
  const askBtn   = document.getElementById('aiAskBtnFR');
  const input    = document.getElementById('aiInputFR');

  renderNotesFR();

  if(useDraft) useDraft.onclick = ()=>{ input.value = buildFRContext(); input.focus(); };
  if(review)   review.onclick   = reviewDraftLocallyFR;
  if(addBtn)   addBtn.onclick   = ()=>{ const v=(input.value||'').trim(); if(!v) return alert('Type a note first.'); addNoteFR(v); input.value=''; };
  if(clearBtn) clearBtn.onclick = ()=>{ writeNotesFR([]); renderNotesFR(); };
  if(askBtn)   askBtn.onclick   = askAI_FR;
}


        function wireUI(){

      renderPresetChips();
      document.getElementById('btnSubmit').onclick = submitNewItem;
      document.getElementById('btnRefresh').onclick = refreshList;
      document.getElementById('filterReligion').onchange = refreshList;
      document.getElementById('filterCategory').onchange = refreshList;
      document.getElementById('filterStatus').onchange = refreshList;

      // ——— Logged-in user badge + logout ———
      const badge = document.getElementById('userBadge');
      const logout = document.getElementById('logoutBtn');

      function setUser(session){
  if (!badge) return;
  if (session?.user){
    const u = session.user;
    const name = (u.user_metadata && (u.user_metadata.full_name || u.user_metadata.name)) || u.email || (u.id || '').slice(0,8);
    badge.textContent = `Logged in: ${name}`;
    if (logout) logout.style.display = '';
    _lastUserId = u.id || 'anon';
  } else {
    badge.textContent = 'Not logged in';
    if (logout) logout.style.display = 'none';
    _lastUserId = 'anon';
  }
  if (typeof renderNotesFR === 'function') renderNotesFR();
}

      // Initial state + subscribe to changes
      supabaseClient.auth.getSession().then(({ data }) => setUser(data?.session));
      supabaseClient.auth.onAuthStateChange((_e, session) => setUser(session));

      if (logout){
        logout.onclick = async () => {
          try { await supabaseClient.auth.signOut(); } finally { location.replace('index.html'); }
        };
      }

     initAIDockFR();
refreshList();

    }



    document.addEventListener('DOMContentLoaded', wireUI);
  </script>
</body>
</html>
