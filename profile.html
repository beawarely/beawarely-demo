<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Your Profile ‚Äì BeAwarely</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 40px 20px;
      background: radial-gradient(ellipse at top, #0d0d2b 0%, #000000 100%);
      color: #fff;
      text-align: center;
    }

    .profile-box {
      max-width: 600px;
      margin: 0 auto;
      background-color: rgba(30, 30, 30, 0.9);
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 0 25px rgba(0, 0, 0, 0.6);
    }

    .profile-pic {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid #007bff;
      margin-bottom: 10px;
    }

    h1 {
      font-size: 2.2rem;
      margin-bottom: 10px;
    }

    .email {
      font-size: 1rem;
      color: #ccc;
      margin-bottom: 25px;
    }

    .stats {
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      margin-bottom: 20px;
      font-size: 0.95rem;
    }

    .stat {
      flex: 1;
      min-width: 120px;
      margin: 10px;
    }

    .stat strong {
      display: block;
      font-size: 1.3rem;
      margin-top: 4px;
    }

    .badges {
      margin: 15px 0 25px;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 12px;
    }

    .badge {
      background: rgba(0, 123, 255, 0.1);
      border: 1px solid #007bff;
      color: #66b2ff;
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 0.85rem;
    }

    .btn-group {
      display: flex;
      justify-content: center;
      gap: 14px;
      flex-wrap: wrap;
    }

    .btn {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.95rem;
      transition: background-color 0.3s, transform 0.2s;
    }

    .btn:hover {
      background-color: #005fcc;
      transform: scale(1.05);
    }

    .btn.secondary {
      background-color: #444;
    }

    .trust-bar {
      background-color: #333;
      border-radius: 20px;
      height: 10px;
      width: 80%;
      margin: 5px auto 10px;
      position: relative;
    }

    .trust-fill {
      background-color: #00cc66;
      height: 100%;
      border-radius: 20px;
    }

    @media (max-width: 500px) {
      .stats {
        flex-direction: column;
        align-items: center;
      }

      .stat {
        margin-bottom: 16px;
      }

      .btn-group {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <!-- üîô Back to Homepage button -->
<button onclick="window.location.href='index.html'" 
        style="position: absolute; top: 20px; left: 20px; 
               background-color: #007bff; color: white; 
               padding: 8px 16px; border: none; border-radius: 6px; 
               font-size: 0.9rem; cursor: pointer; 
               transition: background-color 0.3s;">
  ‚Üê Back to Homepage
</button>

  <div class="profile-box">
    <img id="profile-pic" src="images/default-avatar.png" alt="Profile Photo" class="profile-pic" />
    <h1 id="user-name">Loading‚Ä¶</h1>
    <div class="email" id="user-email">Loading‚Ä¶</div>

    <div class="stats">
      <div class="stat">
        Role
        <strong>Specialist</strong>
      </div>
      <div class="stat">
        Trust Score
        <div class="trust-bar">
          <div class="trust-fill" style="width: 87%;"></div>
        </div>
        <strong>87 / 100</strong>
      </div>
      <div class="stat">
        Activity Points
        <strong>320</strong>
      </div>
    </div>

    <div class="badges">
      <div class="badge">üéì Verified Expert</div>
      <div class="badge">üí¨ 100+ Posts</div>
      <div class="badge">ü§ñ 15 AI-Verified Answers</div>
    </div>

    <div class="btn-group">
      <button class="btn secondary" onclick="alert('Edit profile ‚Äì coming soon')">Edit Profile</button>
      <button class="btn secondary" onclick="alert('Report ‚Äì coming soon')">Report Issue</button>
      <button class="btn" onclick="logoutUser()">Log Out</button>
    </div>

    <!-- Upload avatar -->
<div style="margin-top: 30px;">
  <label for="avatar-upload">Upload your photo:</label><br><br>
  <input type="file" id="avatar-upload" accept="image/*" style="margin-bottom: 10px;" />
  <button class="btn" onclick="uploadAvatar()">Upload</button>
</div>

  </div>

  <script>
    const SUPABASE_URL = "https://xzwpqyomqjzmiqsszwkg.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh6d3BxeW9tcWp6bWlxc3N6d2tnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0MjIxMTYsImV4cCI6MjA2OTk5ODExNn0.QbjDO1xifFkDuIAZZ9WHfGomgxwhanP9BQtgMrFqDgg";

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    document.addEventListener('DOMContentLoaded', async () => {
  const { data, error } = await supabaseClient.auth.getUser();
  const user = data?.user;

  if (!user) {
    alert("You are not logged in.");
    window.location.href = "index.html";
    return;
  }

  // Metadane u≈ºytkownika
  const meta = user.user_metadata || {};
  
  const profilePic = document.getElementById("profile-pic");
if (meta.avatar_url) {
  profilePic.src = meta.avatar_url;
}


  // Wype≈Çnij dane w HTML
  document.getElementById("user-name").textContent = meta.name || "BeAwarely User";
  document.getElementById("user-email").textContent = user.email || "Unknown";
  document.querySelector(".stats .stat:nth-child(1) strong").textContent = meta.role || "User";
  document.querySelector(".stats .stat:nth-child(2) strong").textContent = `${meta.trust_score || 0} / 100`;
  document.querySelector(".trust-fill").style.width = `${meta.trust_score || 0}%`;
  document.querySelector(".stats .stat:nth-child(3) strong").textContent = meta.points || 0;

  // Odznaki
  const badgeContainer = document.querySelector(".badges");
  badgeContainer.innerHTML = "";
  const badges = meta.badges || [];
  badges.forEach(text => {
    const badge = document.createElement("div");
    badge.className = "badge";
    badge.textContent = text;
    badgeContainer.appendChild(badge);
  });

  // Je≈õli brak metadanych ‚Äî ustaw domy≈õlne TYLKO gdy pole nie istnieje (null/undefined)
if (meta.role == null || meta.points == null || meta.trust_score == null) {
  const updates = {
    data: {
      role: meta.role ?? "Specialist",
      points: meta.points ?? 320,
      trust_score: meta.trust_score ?? 87,
      badges: Array.isArray(meta.badges) ? meta.badges : [
        "Verified Expert",
        "100+ Posts",
        "15 AI-Verified Answers"
      ]
    }
  };
  const { error: updateError } = await supabaseClient.auth.updateUser(updates);
  if (updateError) {
    console.error("‚ùå B≈ÇƒÖd aktualizacji metadanych:", updateError.message);
  } else {
    console.log("‚úÖ Metadane uzupe≈Çnione");
    location.reload();
  }
}


});

    async function logoutUser() {
      const { error } = await supabaseClient.auth.signOut();
      if (error) {
        alert("Error signing out");
        console.error(error.message);
      } else {
        window.location.href = "index.html";
      }
    }
  </script>

  <script>
  async function uploadAvatar() {
    const fileInput = document.getElementById('avatar-upload');
    const file = fileInput.files[0];
    if (!file) {
      alert("Please select a file.");
      return;
    }

    const maxSize = 2 * 1024 * 1024; // 2 MB
if (!file.type.startsWith('image/')) {
  alert("Please select an image file.");
  return;
}
if (file.size > maxSize) {
  alert("Image is too large (max 2MB).");
  return;
}

    const { data: sessionData, error: sessionError } = await supabaseClient.auth.getSession();
    const user = sessionData?.session?.user;
    if (!user) {
      alert("User not logged in.");
      return;
    }

    const fileExt = file.name.split('.').pop();
    const fileName = `${user.id}.${fileExt}`;
    const filePath = `avatars/${fileName}`;

    const { error: uploadError } = await supabaseClient.storage
      .from('avatars')
      .upload(filePath, file, { upsert: true });

    if (uploadError) {
      alert("Upload failed.");
      console.error(uploadError.message);
      return;
    }

    const { data: urlData } = supabaseClient.storage
      .from('avatars')
      .getPublicUrl(filePath);

    const avatarUrl = urlData.publicUrl;

    const { error: updateError } = await supabaseClient.auth.updateUser({
      data: { avatar_url: avatarUrl }
    });

    if (updateError) {
      alert("Failed to update profile.");
      console.error(updateError.message);
      return;
    }

    document.getElementById('profile-pic').src = avatarUrl;

    alert("Photo uploaded!");
    location.reload();
  }
</script>

</body>
</html>

