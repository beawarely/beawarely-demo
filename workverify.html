<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <meta name="robots" content="noindex, nofollow"/>
  <title>WorkVerify ‚Äì BeAwarely</title>
  <link rel="stylesheet" href="css/style.css"/>

    <style>
    /* --- Design tokens (dark navy by default, light = cool grey/blue) --- */
    :root{
  --safe-top: env(safe-area-inset-top, 0px);
  /* BeAwarely dark gradient background */
  --bg-gradient: linear-gradient(180deg, #060b14 0%, #133e86 100%);
}
    /* === BeAwarely Background Theme (Dark + Light) === */

/* DARK (default) */
body {
  --bg: #0b0d14;
  --bg-gradient: linear-gradient(180deg, #060b14 0%, #133e86 100%);
  --text: #eaf0ff;
  --muted: #8aa4c8;
  --border: rgba(255,255,255,0.12);
  --accent: #3af2d9;
  --accent-2: #a24dff;
  --pill: rgba(255,255,255,.08);
  --pill-hover: rgba(255,255,255,.14);
  --input-bg: rgba(255,255,255,.02);
  --shadow: 0 6px 16px rgba(12,20,40,.32);

  /* AI dock (DARK): deep greens */
  --ai-bg: #0d1f14;
  --ai-bg-2:#12361f;
  --ai-border: rgba(88,196,140,.25);
  --ai-text:#DFF7EA;
  --ai-muted:#9DD7B8;

  margin: 0;
  font-family: 'Segoe UI', system-ui, Arial, sans-serif;
  background: linear-gradient(180deg, #060b14 0%, #133e86 100%);
  color: var(--text);
  transition: background 0.3s ease, color 0.3s ease;
}

/* LIGHT */
body.light-mode {
  --bg: #f6f8ff;
  --bg-gradient: linear-gradient(180deg, #b5e0ff 0%, #ffffff 100%);
  --text: #0E1730;
  --muted: #5A6B89;
  --border: rgba(14,23,48,0.28);
  --accent: #2F54EB;
  --accent-2: #69A1FF;
  --pill: rgba(14,23,48,.06);
  --pill-hover: rgba(14,23,48,.10);
  --input-bg: rgba(14,23,48,.025);
  --shadow: 0 6px 14px rgba(18,30,60,.08);

  /* AI dock (LIGHT): soft grey-greens */
  --ai-bg:#ECF5EF;
  --ai-bg-2:#E3F0E8;
  --ai-border: rgba(29,105,76,.18);
  --ai-text:#103322;
  --ai-muted:#3a6a52;

  background: var(--bg-gradient);
  color: var(--text);
  transition: background 0.3s ease, color 0.3s ease;
}

    /* Optional helper if you want to target explicitly */
/*    body.dark-mode{ background: var(--bg); }*/

    /* Topbar */
    #topbar{
      position:fixed; top:calc(14px + var(--safe-top)); left:20px; right:20px; z-index:10000;
      display:flex; justify-content:space-between; align-items:center; pointer-events:none;
    }
    #topbar .grp{ display:flex; gap:12px; align-items:center; pointer-events:auto; }
    .pill{
      background: var(--pill); color: inherit; font-weight:700; text-decoration:none;
      padding:7px 14px; border-radius:12px; border:1px solid var(--border);
      display:inline-flex; align-items:center; gap:8px; cursor:pointer;
      backdrop-filter: saturate(160%) blur(4px);
      transition: background .2s ease, transform .15s ease, border-color .2s ease;
    }
    .pill:hover{ background: var(--pill-hover); transform: translateY(-1px); }

    header{ text-align:center; padding: calc(120px + var(--safe-top)) 16px 12px; }
    header h1{ font-family:'Sriracha', cursive; font-size:56px; margin:0 0 8px; letter-spacing:.3px; }
    header p.sub{ color: var(--muted); margin:0; }

    main{ max-width:1100px; margin:0 auto; padding:24px 16px 60px; display:grid; gap:16px; }

    .panel{
      background: linear-gradient(180deg, var(--card), var(--card));
      border:1px solid var(--border);
      border-radius:18px; padding:20px;
      box-shadow: var(--shadow);
    }

    .panel h2{ margin:0 0 8px; font-size:20px; letter-spacing:.2px; }
    .muted{ color: var(--muted); }

    .actions{ display:flex; gap:8px; justify-content:flex-end; }
    .btn{
      border:none; padding:10px 14px; border-radius:12px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color:#fff; font-weight:800; cursor:pointer;
      transition: transform .12s ease, filter .2s ease, box-shadow .2s ease;
      box-shadow: 0 4px 12px rgba(48,92,255,.28);
    }
    .btn:hover{ transform: translateY(-1px); filter: brightness(1.05); }
    .btn:active{ transform: translateY(0); }

    .btn.secondary{
      background: transparent; color: inherit;
      border:1px solid var(--border);
      box-shadow: none;
    }

    textarea, input[type="text"]{
      width:100%; box-sizing:border-box; padding:12px 14px; border-radius:12px;
      border:1px solid var(--border); background: var(--input-bg); color:inherit; outline:none;
      font-size:15px; line-height:1.5;
      transition: border-color .15s ease, box-shadow .15s ease, background .15s ease;
    }
    textarea::placeholder, input::placeholder{ color: color-mix(in oklab, var(--muted) 65%, transparent); }
    textarea:focus, input[type="text"]:focus{
      border-color: color-mix(in oklab, var(--accent) 70%, white 30%);
      box-shadow: 0 0 0 3px color-mix(in oklab, var(--accent) 22%, transparent);
      background: color-mix(in oklab, var(--input-bg) 70%, white 30%);
    }

    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:20px; }
    @media (max-width:900px){ .grid{ grid-template-columns:1fr; } }

    .badge{
      font-size:12px; padding:4px 8px; border-radius:999px;
      background: color-mix(in oklab, var(--accent) 16%, transparent);
      border:1px solid var(--border); color: inherit; display:inline-block;
    }
      /* Smooth theme transitions (1) */
    @media (prefers-reduced-motion: no-preference){
      body, .panel, .pill, .btn,
      input[type="text"], textarea, header, #topbar{
        transition:
          background-color .25s ease,
          color .25s ease,
          border-color .25s ease,
          box-shadow .25s ease,
          filter .25s ease;
      }
      /* shorten & synchronize transitions podczas prze≈ÇƒÖczania trybu */
      body.theme-anim *{ transition-duration:.25s !important; }
    }

    /* Enhanced header title (3) */
    header h1{
  font-family:'Sriracha', cursive; font-size:56px; margin:0 0 8px; letter-spacing:.3px;
  background: linear-gradient(90deg, #3af2d9, #a24dff, #ff47b7);
  -webkit-background-clip:text; background-clip:text; color:transparent;
  text-shadow: 0 2px 16px rgba(162,77,255,0.4);
}
  /* Recent list */
    .recent-list{ display:grid; grid-template-columns:1fr; gap:10px; }
    .recent-card{
      padding:12px 14px; border:1px solid var(--border); border-radius:14px;
      background: color-mix(in oklab, var(--card) 96%, transparent);
    }
    .recent-meta{ display:flex; gap:8px; align-items:center; font-size:12px; color:var(--muted); margin-bottom:6px; }
    .recent-content{ margin:0; color:var(--text); opacity:.95; }

  </style>
<style>
  /* --- Toolbar (zostaje) --- */
.toolbar{ display:flex; flex-wrap:wrap; gap:8px; justify-content:flex-end; margin-top:10px; }

/* --- Statyczny mini-chat AI jako panel --- */
.ai-panel textarea{
  width:100%; box-sizing:border-box; margin-top:8px;
}

/* --- Formularz + prawa kolumna z draftami --- */
.form-and-drafts{
  display:grid; grid-template-columns: 1fr 340px; gap:16px; align-items:start;
}
@media (max-width: 1100px){
  .form-and-drafts{ grid-template-columns: 1fr; }
}

/* Role + From + To: kr√≥tsze daty */
.dates-grid{
  display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin-top:10px;
}
@media (max-width: 600px){
  .dates-grid{ grid-template-columns: 1fr; }
}

/* My Drafts panel */
.drafts-panel{ padding:16px; }
.drafts-panel .muted small{ opacity:.9; }

</style>

  <script>
    // light/dark toggle (sp√≥jne z innymi)
    document.addEventListener('DOMContentLoaded', async ()=> {
  // Default: respect saved choice; if none, follow system preference
  const saved = localStorage.getItem('mode');
  const prefersLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
  const isLight = saved ? (saved === 'light') : prefersLight;
  document.body.classList.toggle('light-mode', isLight);
  document.body.classList.toggle('dark-mode', !isLight);

  // üîß Tylko ustawienie trybu kolor√≥w ‚Äì resztƒô inicjalizuje modu≈Ç ni≈ºej

  // üîß Draft buttons
  if(saveDraftBtn) saveDraftBtn.addEventListener('click', saveDraftFromForm);
  if(loadDraftBtn) loadDraftBtn.addEventListener('click', loadDraftIntoForm);
  if(clearDraftBtn) clearDraftBtn.addEventListener('click', () => {
    localStorage.removeItem(draftKey());
    alert('Draft cleared.');
  });

  // üîß AI Dock buttons
  if(aiReviewBtn) aiReviewBtn.addEventListener('click', reviewDraftLocally);
  if(aiAddNoteBtn) aiAddNoteBtn.addEventListener('click', () => {
    const note = prompt('Add a note:');
    if(note && note.trim()) addNote(note.trim());
  });
  if(aiClearNotesBtn) aiClearNotesBtn.addEventListener('click', () => {
    localStorage.removeItem(NOTES_KEY());
    renderNotes();
  });
  if(aiUseDraftBtn) aiUseDraftBtn.addEventListener('click', () => {
    const d = readDraft();
    if(!d){ alert('No draft.'); return; }
    aiInputEl.value = buildAIContext();
  });
});

    function toggleLightDarkMode(){
  // Smooth theme switch (1) ‚Äì dodaj kr√≥tkƒÖ klasƒô animujƒÖcƒÖ
  document.body.classList.add('theme-anim');

  const isLight = document.body.classList.toggle('light-mode');
  document.body.classList.toggle('dark-mode', !isLight);
  localStorage.setItem('mode', isLight ? 'light' : 'dark');

  // usu≈Ñ klasƒô po animacji
  setTimeout(()=> document.body.classList.remove('theme-anim'), 280);
}

    /* wrapper ‚Äì prawdziwa implementacja w module poni≈ºej */
    function submitExperience(){
      if (window._submitExperienceImpl) return window._submitExperienceImpl();
      alert('Loading‚Ä¶');
    }
  </script>
</head>
<body>
  <!-- Topbar -->
  <div id="topbar">
    <div class="grp">
  <a href="index.html" class="pill">‚Üê Back</a>
    <a href="satire.html" class="pill" title="View existing satires (read-only)">Satire</a>
</div>

    <div class="grp">
      <button class="pill" onclick="toggleLightDarkMode()">üåì</button>
      <a href="profile.html" class="pill">Your Profile</a>
    </div>
  </div>

  <header>
    <h1>WorkVerify</h1>
    <p class="sub">Balanced job verification. Real experiences, fair checks, clear signals.</p>
  </header>

  <main>
    <!-- Intro / scope -->
    <section class="panel ai-panel">
  <h2>AI Assist ‚Äî WorkVerify</h2>
  <textarea id="aiInput" rows="3" placeholder="Ask about tone, legality, or red/green flags‚Ä¶"></textarea>
  <div class="toolbar">
    <button id="aiUseDraftBtn" class="btn secondary" type="button">Use my draft</button>
    <button id="aiReviewBtn" class="btn" type="button">Review draft</button>
    <button id="aiAddNoteBtn" class="btn secondary" type="button">Add note</button>
    <button id="aiClearNotesBtn" class="btn secondary" type="button">Clear notes</button>
  </div>
  <div id="aiNotes" class="muted" style="font-size:13px; margin-top:8px;"></div>
</section>

    <!-- Quick submit (placeholder) -->
    <section class="panel">
  <h2>Share an experience ‚Äî <span class="muted">FAKTY (neutral)</span></h2>

  <div class="form-and-drafts">
    <!-- LEWA KOLUMNA: formularz -->
    <div>
      <div class="grid">
        <div>
          <label class="muted">Company (optional)</label>
          <input id="companyName" type="text" placeholder="e.g., ACME Sp. z o.o."/>
        </div>
        <div>
          <!-- From przeniesione w miejsce Role -->
          <label class="muted">From</label>
          <input id="periodFrom" type="text" placeholder="e.g., 2022-03"/>
        </div>
      </div>

      <div class="dates-grid">
        <!-- Role przeniesione w miejsce From -->
        <div>
          <label class="muted">Role (optional)</label>
          <input id="roleName" type="text" placeholder="e.g., Warehouse Worker / HR Manager"/>
        </div>
        <div>
          <label class="muted">To</label>
          <input id="periodTo" type="text" placeholder="e.g., 2023-07 or present"/>
        </div>
      </div>

      <div style="margin-top:10px;">
        <label class="muted">Experience (facts only)</label>
        <textarea id="expText" rows="5" placeholder="Describe the situation. Neutral, factual, no personal data."></textarea>
        <div id="charCount" class="muted" style="font-size: 13px; margin-top:4px;">0 / 8000 characters</div>
      </div>

      <div class="toolbar">
        <button id="saveDraftBtn" class="btn secondary" type="button">Save draft</button>
        <button id="clearDraftBtn" class="btn secondary" type="button">Clear</button>
        <button id="submitBtn" class="btn" type="button" onclick="submitExperience()">Publish</button>
      </div>
    </div>

    <!-- PRAWA KOLUMNA: My Drafts (statyczne) -->
    <aside class="panel drafts-panel">
      <h3 style="margin:0 0 8px;">üìÇ My Drafts</h3>
      <div id="draftList" class="muted small" style="font-size:13px;"></div>
    </aside>
  </div>
</section>

    <!-- Recent (approved) -->
    <section class="panel">
      <h2>Recent experiences (approved)</h2>
      <div id="recentList" class="recent-list"></div>
    </section>

    <!-- Roadmap / coming next -->
    <section class="panel">
      <h2>Coming next</h2>
      <ul class="muted" style="margin:8px 0 0 18px;">
        <li>AI roles: evidence checker, bias detector, legal/ethics lens.</li>
        <li>Company dossiers: timelines, signals, and patterns.</li>
        <li>Balanced inputs: both employees and employers.</li>
        <li>Privacy & moderation pipeline.</li>
      </ul>
    </section>
    </main>

<!-- Supabase + funkcjonalno≈õƒá strony -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // KONFIGURACJA: podmie≈Ñ na swoje warto≈õci lub zdefiniuj globalnie window.__SUPABASE_URL / __SUPABASE_ANON_KEY
        const SUPABASE_URL = window.__SUPABASE_URL || "https://xzwpqyomqjzmiqsszwkg.supabase.co";
    const SUPABASE_ANON_KEY = window.__SUPABASE_ANON_KEY || "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh6d3BxeW9tcWp6bWlxc3N6d2tnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0MjIxMTYsImV4cCI6MjA2OTk5ODExNn0.QbjDO1xifFkDuIAZZ9WHfGomgxwhanP9BQtgMrFqDgg";

    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    window.sb = sb;

        const $ = (sel)=> document.querySelector(sel);
    const companyEl = $('#companyName');
    const roleEl = $('#roleName');
    const textEl = $('#expText');
    const charCountEl = $('#charCount');
    const submitBtn = $('#submitBtn');
    const recentList = $('#recentList');

    // Draft & AI controls
    const saveDraftBtn = $('#saveDraftBtn');
    const loadDraftBtn = $('#loadDraftBtn');
    const clearDraftBtn = $('#clearDraftBtn');
    const aiInputEl = $('#aiInput');
    const aiUseDraftBtn = $('#aiUseDraftBtn');
    const aiReviewBtn = $('#aiReviewBtn');
    const aiAddNoteBtn = $('#aiAddNoteBtn');
    const aiClearNotesBtn = $('#aiClearNotesBtn');
    const aiNotesEl = $('#aiNotes');

    // helper: per-user draft key
    let _lastUserId = 'anon';
    const draftBaseKey = () => `wv_draft_${_lastUserId}`;
const draftKey = () => `${draftBaseKey()}_${Date.now()}`;

        function escapeHTML(s){
      return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
    }

       /* ------- Drafts (local-only) ------- */
    // klucz bazowy: wv_draft_${_lastUserId}
    function listDraftKeys(){
      const prefix = `${draftBaseKey()}_`;
      const out = [];
      for (let i=0;i<localStorage.length;i++){
        const k = localStorage.key(i);
        if (!k || !k.startsWith(prefix)) continue;
        try {
          const v = JSON.parse(localStorage.getItem(k) || 'null');
          const ts = (v && v.ts) ? Number(v.ts) : Number(k.slice(prefix.length));
          out.push([k, v || null, ts]);
        } catch(_) {
          // uszkodzony wpis pomijamy
        }
      }
      // najnowsze na g√≥rze
      out.sort((a,b)=> (b[2]||0) - (a[2]||0));
      return out;
    }

    function readDraft(){
      try{
        const arr = listDraftKeys();
        return arr[0]?.[1] || null;
      }catch(_){ return null; }
    }

    function writeDraft(obj){
      const now = Date.now();
      localStorage.setItem(`${draftBaseKey()}_${now}`, JSON.stringify({ ...obj, ts: now }));
      renderDraftList(); // od≈õwie≈º listƒô po zapisie
    }

    function loadDraftByKey(key){
      try{
        const d = JSON.parse(localStorage.getItem(key) || 'null');
        if(!d) return alert('Draft not found.');
        companyEl.value = d.company || '';
        roleEl.value = d.role || '';
        textEl.value = d.content || '';
        if (typeof validateContentLength === 'function') validateContentLength();
        alert('Draft loaded.');
      }catch(_){
        alert('Cannot load this draft.');
      }
    }

    function deleteDraftKey(key){
      localStorage.removeItem(key);
      renderDraftList();
    }

    // make functions callable from inline onclick handlers
window.loadDraftByKey = loadDraftByKey;
window.deleteDraftKey = deleteDraftKey;

    function renderDraftList(){
      const host = document.getElementById('draftList');
      if (!host) return;
      const arr = listDraftKeys().slice(0,5); // max 5 ostatnich
      if (!arr.length){
        host.innerHTML = '<small>No drafts yet.</small>';
        return;
      }
      const fmt = (ts)=>{
        try{
          return new Date(ts).toLocaleString(undefined, { hour12:false });
        }catch(_){ return ''; }
      };
      host.innerHTML = arr.map(([key, val, ts])=>{
  const title = (val?.company || val?.role || (val?.content||'').slice(0,18) || '‚Äî').toString();
  const safe = title.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
  return `
    <div style="display:flex;align-items:center;gap:8px;justify-content:space-between;padding:6px 8px;border:1px solid var(--border);border-radius:10px;margin-top:6px;background:var(--input-bg)">
      <div style="display:flex;align-items:center;gap:6px;min-width:0;">
        <span aria-hidden="true">‚Ä¢</span>
        <button type="button"
                style="background:transparent;border:0;color:inherit;cursor:pointer;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:180px;"
                onclick="loadDraftByKey('${key}')"
                title="Load this draft">${safe}</button>
        <small class="muted">(${fmt(ts)})</small>
      </div>
      <div style="display:flex;gap:6px;align-items:center;">
        <button type="button" class="pill" title="Load"
                onclick="loadDraftByKey('${key}')">‚Ü©</button>
        <button type="button" class="pill" title="Delete"
                onclick="deleteDraftKey('${key}')">üóëÔ∏è</button>
      </div>
    </div>`;
}).join('');
}

    function loadDraftIntoForm(){
      const d = readDraft();
      if(!d){ alert('No saved draft.'); return; }
      companyEl.value = d.company || '';
      roleEl.value = d.role || '';
      textEl.value = d.content || '';
      if (typeof validateContentLength === 'function') validateContentLength();
      alert('Draft loaded.');
    }

    function saveDraftFromForm(){
      const payload = {
        company: (companyEl.value||'').trim(),
        role: (roleEl.value||'').trim(),
        content: (textEl.value||'').trim()
      };
      if(!payload.company && !payload.role && !payload.content){
        alert('Draft is empty. Type something first.'); return;
      }
      writeDraft(payload);
      alert('Draft saved locally.');
    }

        /* ------- Mini AI (local helper + notes) ------- */
    const NOTES_KEY = ()=> `wv_notes_${_lastUserId}`;
    function readNotes(){
      try{ return JSON.parse(localStorage.getItem(NOTES_KEY())||'[]'); }catch(e){ return []; }
    }
    function writeNotes(arr){
      localStorage.setItem(NOTES_KEY(), JSON.stringify(arr));
    }
    function renderNotes(){
      const notes = readNotes();
      if(!aiNotesEl) return;
      if(!notes.length){ aiNotesEl.innerHTML = '<small>No notes yet.</small>'; return; }
      aiNotesEl.innerHTML = '<small>Notes:</small><ul>' + notes.map(n=>`<li>${escapeHTML(n)}</li>`).join('') + '</ul>';
    }
    function addNote(text){
      const notes = readNotes();
      notes.unshift(text);
      writeNotes(notes.slice(0,30)); // cap
      renderNotes();
    }

    function buildAIContext(){
      const company = (companyEl.value||'').trim() || '‚Äî';
      const role = (roleEl.value||'').trim() || '‚Äî';
      const content = (textEl.value||'').trim();
      const question = (aiInputEl?.value||'').trim();
      return `WorkVerify context
Company: ${company}
Role: ${role}
Draft:
${content || '(no text yet)'}
---
Task: ${question || 'Review tone/legality, spot red/green flags, suggest neutral wording without personal data.'}`;
    }

    // Lightweight local checker (heuristics ‚Äì no network)
    function reviewDraftLocally(){
      const content = (textEl.value||'').trim();
      const issues = [];

      if(content.length < 40){
        issues.push('Draft is very short. Add more factual detail.');
      }

      // Personal data patterns
      if(/\b\d{2,3}[-\s]?\d{3}[-\s]?\d{3,4}\b/.test(content)) issues.push('Possible phone number detected ‚Äî remove or anonymize.');
      if(/[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}/.test(content)) issues.push('Email detected ‚Äî remove.');
      if(/\b(ul\.|ulica|adres|address|street)\b/i.test(content)) issues.push('Address detected ‚Äî avoid precise locations.');
      if(/\bPESEL\b|\bBSN\b|\bNIP\b|\bVAT\b/i.test(content)) issues.push('Sensitive ID detected ‚Äî remove.');

      // Names (very naive): Capitalized word followed by capitalized
      if(/\b[A-Z≈Å≈ö≈ª≈πƒÜ≈É][a-zƒÖƒáƒô≈Ç≈Ñ√≥≈õ≈∫≈º]+\s+[A-Z≈Å≈ö≈ª≈πƒÜ≈É][a-zƒÖƒáƒô≈Ç≈Ñ√≥≈õ≈∫≈º]+/.test(content)){
        issues.push('Full name found ‚Äî replace with generic role (e.g., ‚Äúshift coordinator‚Äù).');
      }

      // Defamation-prone words (examples, extend as needed)
      const flagged = ['palant','idiota','debil','kasztan','z≈Çodziej','oszust','frajer'];
      const found = flagged.filter(w=> new RegExp(`\\b${w}\\b`, 'i').test(content));
      if(found.length){
        issues.push(`Inflammatory words (${found.join(', ')}) ‚Äî use neutral role-based wording.`);
      }

      // Company names: if mentioned, advise on neutrality
      if(/\b(sp\. z o\.o\.|bv|gmbh|inc|llc)\b/i.test(content)){
        issues.push('If you name a company, stick to verifiable facts and avoid accusations without evidence.');
      }

      // Output as notes + prefill AI input with a policy-friendly question
      if(!issues.length){ addNote('No obvious personal data or slurs detected. Consider dates, shifts, who/what/when/where.'); }
      else issues.forEach(i=> addNote(i));

      aiInputEl.value = 'Please help me rewrite my draft to be factual, neutral, and privacy-safe. Keep details, remove personal data and insults. Suggest red/green flags summary.';
      alert('Draft reviewed. See notes below the dock.');
    }

       async function getSession(){
      const { data:{ session } } = await sb.auth.getSession();
      // cache last seen user id for per-user drafts
      _lastUserId = session?.user?.id || 'anon';
      return session || null;
    }

        async function setFormState(){
      const session = await getSession();
      const authed = !!session?.user;
      const fields = [companyEl, roleEl, textEl];

      if(!authed){
        fields.forEach(el=> el.disabled = true);
        if (submitBtn){
          submitBtn.textContent = 'Login to submit';
          submitBtn.onclick = () => location.href = 'profile.html';
        }
      }else{
        fields.forEach(el=> el.disabled = false);
        if (submitBtn){
          submitBtn.textContent = 'Publish';
          submitBtn.onclick = () => submitExperience();
        }
      }

      // Draft buttons are always usable (local only)
      if(saveDraftBtn) saveDraftBtn.disabled = false;
      if(loadDraftBtn) loadDraftBtn.disabled = false;
      if(clearDraftBtn) clearDraftBtn.disabled = false;
    }

    async function loadRecent(){
      if(!recentList) return;
      recentList.innerHTML = '<span class="muted">Loading‚Ä¶</span>';

      const { data, error } = await sb
  .from('work_experiences')
  .select('id, author, company, role, content, created_at, status')
  .or(`status.eq.approved,author.eq.${_lastUserId}`)
  .order('created_at', { ascending:false })
  .limit(6);

      if(error){
        recentList.innerHTML = `<span class="muted">Failed to load (${escapeHTML(error.message)})</span>`;
        return;
      }
      if(!data || !data.length){
        recentList.innerHTML = `<span class="muted">No approved entries yet.</span>`;
        return;
      }

      recentList.innerHTML = data.map(r=>{
        const meta = [
          r.company ? escapeHTML(r.company) : '‚Äî',
          r.role ? escapeHTML(r.role) : '‚Äî',
          new Date(r.created_at).toLocaleString()
        ].join(' ‚Ä¢ ');
        const content = escapeHTML(r.content.length > 260 ? r.content.slice(0,260)+'‚Ä¶' : r.content);
        return `<article class="recent-card">
  <div class="recent-meta">${meta}</div>
  <p class="recent-content">${content}</p>
  ${r.status !== 'approved' ? '<div class="badge">Awaiting approval</div>' : ''}
  <div class="toolbar" style="justify-content:flex-start; margin-top:8px;">
    <button class="btn secondary" type="button" onclick="location.href='satire.html?exp=${r.id}'">Satire version</button>
  </div>
</article>`;

      }).join('');
    }

// Implementacja wysy≈Çki ‚Äì wo≈Çana przez wrapper w <head>

    window._submitExperienceImpl = async function(){
      // auto-save current form into draft before publishing
      writeDraft({
        company: (companyEl.value||'').trim(),
        role: (roleEl.value||'').trim(),
        content: (textEl.value||'').trim()
      });

      const session = await getSession();
      if(!session){ alert('Please log in first.'); return; }

      const company = (companyEl.value||'').trim();
      const role = (roleEl.value||'').trim();
      const content = (textEl.value||'').trim();

      if(content.length < 40){
        alert('Please provide at least ~40 characters describing the situation.');
        return;
      }
            if (submitBtn){ submitBtn.disabled = true; submitBtn.textContent = 'Saving‚Ä¶'; }
      reviewDraftLocally(); // üîß lokalna walidacja przed wys≈Çaniem

      const payload = {
        author: session.user.id,
        company: company || null,
        role: role || null,
        content
        // status = 'pending' (domy≈õlnie po stronie SQL)
      };

      const { error } = await sb.from('work_experiences').insert(payload);
      if (submitBtn){ submitBtn.disabled = false; submitBtn.textContent = 'Publish'; }

      if(error){
        alert('Save failed: ' + error.message);
        return;
      }

      companyEl.value = ''; roleEl.value = ''; textEl.value = '';
      alert('Thanks! Your experience was submitted and is pending moderation.');
      loadRecent();
    };

        // Init
document.addEventListener('DOMContentLoaded', async ()=>{
      // üîí ZABEZPIECZENIE: przekieruj niezalogowanych na index.html
      const { data:{ session } } = await sb.auth.getSession();
      if(!session || !session.user){
        window.location.href = 'index.html';
        return;
      }

      await setFormState();
      await loadRecent();

      // Wire draft buttons
      if(saveDraftBtn) saveDraftBtn.onclick = saveDraftFromForm;
      if(loadDraftBtn) loadDraftBtn.onclick = loadDraftIntoForm;
      if(clearDraftBtn) clearDraftBtn.onclick = ()=>{
        companyEl.value=''; roleEl.value=''; textEl.value='';
      };

           // AI dock buttons (local)
      if(aiUseDraftBtn) aiUseDraftBtn.onclick = ()=>{
        const ctx = buildAIContext();
        aiInputEl.value = ctx;
      };
      if(aiReviewBtn) aiReviewBtn.onclick = reviewDraftLocally;
      if(aiAddNoteBtn) aiAddNoteBtn.onclick = ()=> {
        const v = (aiInputEl.value||'').trim();
        if(!v) return alert('Type a note first.');
        addNote(v);
        aiInputEl.value = '';
      };
            if(aiClearNotesBtn) aiClearNotesBtn.onclick = ()=> { writeNotes([]); renderNotes(); };

renderDraftList();

      // Simple autosave on input (debounced)
      let t=null;
      [companyEl, roleEl, textEl].forEach(el=>{
  el.addEventListener('input', ()=>{
    clearTimeout(t);
    t = setTimeout(()=> writeDraft({
      company:(companyEl.value||'').trim(),
      role:(roleEl.value||'').trim(),
      content:(textEl.value||'').trim()
    }), 800);

    validateContentLength(); // üîß nowa funkcja walidacji w czasie pisania
  });
});

      sb.auth.onAuthStateChange(async (_ev, session)=> {
  _lastUserId = session?.user?.id || 'anon'; // prze≈ÇƒÖcz klucz draft√≥w na aktywnego usera
  await setFormState();
  await loadRecent();
  renderDraftList(); // od≈õwie≈º listƒô po zmianie sesji
});

    });

  function validateContentLength(){
  const len = (textEl.value || '').trim().length;
  if(charCountEl){
    charCountEl.textContent = `${len} / 8000 characters`;
    if(len < 40){
      charCountEl.style.color = 'orange';
      charCountEl.textContent += ' ‚Äî too short';
    } else if(len > 8000){
      charCountEl.style.color = 'red';
      charCountEl.textContent += ' ‚Äî too long';
    } else {
      charCountEl.style.color = 'inherit';
    }
  }

  // blokuj / odblokuj przycisk Publish
  if(submitBtn){
    submitBtn.disabled = (len < 40 || len > 8000);
  }
}
</script>

</body>
</html>
