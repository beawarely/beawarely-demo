<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Foresight Review — BeAwarely</title>
  <meta name="robots" content="noindex, nofollow"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{ --blue1:#007bff; --blue2:#66b2ff; }
    body{ margin:0; font-family:'Segoe UI',sans-serif; color:#fff;
      background: radial-gradient(ellipse at top, #0d0d2b 0%, #000 100%); }
    .wrap{ max-width:1100px; margin:0 auto; padding:26px }
    .topbar{ display:flex; align-items:center; gap:10px; margin-bottom:16px }
    a.back{ color:#66b2ff; text-decoration:none }
    h1{ margin:0 }

    .card{ background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10);
      border-radius:14px; padding:16px; margin-bottom:14px }
    .filters{ display:grid; gap:10px; grid-template-columns:1fr 160px 160px }
    .filters input, .filters select{
      padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.25); color:#fff; outline:none;
    }

    table{ width:100%; border-collapse:separate; border-spacing:0 8px; font-size:.95rem }
    thead th{ text-align:left; padding:8px 10px; opacity:.9 }
    tbody tr{ background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10) }
    td{ padding:10px; vertical-align:top }
    .nowrap{ white-space:nowrap }
    .muted{ opacity:.8 }
    .badge{ font-size:.8rem; padding:4px 8px; border-radius:999px;
      background:rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.18) }

    .btn{ border:none; border-radius:10px; padding:8px 12px; font-weight:600; cursor:pointer }
    .approve{ background:linear-gradient(135deg,#00c26e,#56e39f); color:#000 }
    .reject{ background:linear-gradient(135deg,#ff6a6a,#ff9a9a); color:#000 }
    .pill{ background:linear-gradient(135deg,var(--blue1),var(--blue2)); color:#fff; padding:8px 12px; border:none; border-radius:10px; font-weight:600; cursor:pointer }

    .stats{ display:grid; grid-template-columns:repeat(4,1fr); gap:10px }
    .stat{ text-align:center; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10); border-radius:12px; padding:12px }
    .stat b{ display:block; font-size:1.3rem; margin-top:4px }
    details{ background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10);
      border-radius:10px; padding:10px; margin-top:10px }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <a class="back" href="index.html">← Back</a>
      <h1>Foresight Review</h1>
    </div>
    <div class="card">
      <div class="filters">
        <input id="q" placeholder="Szukaj w treści / ID…"/>
        <select id="topic">
          <option value="">Temat: wszystkie</option>
          <option>AI</option><option>Economy</option><option>Policy</option><option>Science</option>
        </select>
        <select id="proposed">
          <option value="">Propozycja: wszystkie</option>
          <option value="Correct">Correct</option>
          <option value="Wrong">Wrong</option>
        </select>
      </div>
    </div>

    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
        <div class="muted">Propozycje rozstrzygnięć oczekujące na akceptację</div>
        <button class="pill" id="exportBtn">Export proposals JSON</button>
      </div>
      <table>
        <thead>
          <tr>
            <th class="nowrap">Data</th>
            <th>Prognoza</th>
            <th>Temat</th>
            <th class="nowrap">Propozycja</th>
            <th>Dowody</th>
            <th class="nowrap">Akcja</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
      <details>
        <summary>Szczegóły procesu</summary>
        <div class="muted" style="margin-top:8px">
          Panel pokazuje wpisy z kolejki (np. tabela <code>resolutions_proposed</code>): propozycja statusu
          (<b>Correct</b> / <b>Wrong</b>), krótkie uzasadnienie i linki. <br>
          <b>Approve</b> → zapis do <code>predictions.status</code> + log <code>resolved_by='human'</code>.  
          <b>Reject</b> → propozycja trafia do archiwum odrzuconych (do wglądu).
        </div>
      </details>
    </div>

    <div class="card">
      <div class="stats">
        <div class="stat"><span>W kolejce</span> <b id="s_queue">0</b></div>
        <div class="stat"><span>Approved (sesja)</span> <b id="s_approved">0</b></div>
        <div class="stat"><span>Rejected (sesja)</span> <b id="s_rejected">0</b></div>
        <div class="stat"><span>Ostatnia akcja</span> <b id="s_last">–</b></div>
      </div>
    </div>
  </div>

<script>
/** ⛳️ KONFIG SUPABASE (później podmienisz na swoje stałe globalne) */
const SB_URL = 'https://xzwpqyomqjzmiqsszwkg.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh6d3BxeW9tcWp6bWlxc3N6d2tnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0MjIxMTYsImV4cCI6MjA2OTk5ODExNn0.QbjDO1xifFkDuIAZZ9WHfGomgxwhanP9BQtgMrFqDgg';
const supa = window.supabase.createClient(SB_URL, SB_KEY);

(async () => {
  // Wymagamy zalogowania (jak w chat.html)
  const { data: { session } } = await supa.auth.getSession();
  if (!session) {
    localStorage.setItem('ba_redirect', 'foresight-review.html');
    window.location.href = 'index.html?login=1';
    return;
  }
})();

/** Demo proposals – PODMIENISZ NA loadProposals() z Supabase */
let proposals = [
  {
    id: 'P-004',
    createdAt: '2025-01-05',
    topic: 'Policy',
    text: 'USA wprowadzą ogólnokrajowe wytyczne dot. etykiet AI przy reklamach politycznych do 2025-09-30.',
    resolveBy: '2025-09-30',
    proposedStatus: 'Correct',           // Correct | Wrong
    rationale: 'Ogłoszono federalne wytyczne (link).',
    evidence: [{label: 'Gov docs', url: '#'}]
  },
  {
    id: 'P-003',
    createdAt: '2025-02-01',
    topic: 'Science',
    text: 'Ogłoszenie powtarzalnej syntezy energii z fuzji o dodatnim bilansie w 2025 r.',
    resolveBy: '2025-12-31',
    proposedStatus: 'Wrong',
    rationale: 'Brak publikacji + brak replikacji do terminu.',
    evidence: [{label: 'Journals', url: '#'}]
  }
];

const el = s => document.querySelector(s);
const rows = el('#rows');
const q = el('#q'), topic = el('#topic'), proposed = el('#proposed');

let statApproved = 0, statRejected = 0;

function passFilters(p){
  const qq = q.value.trim().toLowerCase();
  if (qq && !(`${p.text} ${p.id}`.toLowerCase().includes(qq))) return false;
  if (topic.value && p.topic !== topic.value) return false;
  if (proposed.value && p.proposedStatus !== proposed.value) return false;
  return true;
}

function render(){
  rows.innerHTML = '';
  proposals.filter(passFilters).forEach(p=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="nowrap">${p.createdAt}</td>
      <td>
        ${p.text}
        <div class="muted" style="margin-top:6px">
          <span class="badge">ID: ${p.id}</span>
          <span class="badge">Resolve by: ${p.resolveBy}</span>
        </div>
        <div class="muted" style="margin-top:6px">Uzasadnienie: ${p.rationale}</div>
      </td>
      <td>${p.topic}</td>
      <td class="nowrap"><span class="badge">${p.proposedStatus}</span></td>
      <td>
        ${p.evidence?.map(e=>`<a href="${e.url}" target="_blank" rel="noopener" style="color:#66b2ff">${e.label}</a>`).join(', ') || '—'}
      </td>
      <td class="nowrap" style="display:flex; gap:8px;">
        <button class="btn approve" onclick="approve('${p.id}')">Approve</button>
        <button class="btn reject"  onclick="reject('${p.id}')">Reject</button>
      </td>
    `;
    rows.appendChild(tr);
  });

  el('#s_queue').textContent = proposals.length;
}

/** Export kolejki propozycji */
el('#exportBtn').onclick = ()=>{
  const data = JSON.stringify(proposals, null, 2);
  const blob = new Blob([data], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'foresight-proposals.json';
  document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
};

[q, topic, proposed].forEach(ctrl=>ctrl.addEventListener('input', render));
render();

/** APPROVE / REJECT – na razie lokalnie; poniżej zostawiłem hooki pod Supabase */
async function approve(id){
  const p = proposals.find(x=>x.id===id);
  if (!p) return;
  // TODO (Supabase):
  // 1) await supa.from('predictions').update({ status: p.proposedStatus, resolved_at: new Date().toISOString(), resolved_by: 'human' }).eq('id', id);
  // 2) await supa.from('resolutions_proposed').delete().eq('prediction_id', id);
  proposals = proposals.filter(x=>x.id!==id);
  statApproved++;
  el('#s_approved').textContent = statApproved;
  el('#s_last').textContent = `Approved ${id}`;
  render();
}

async function reject(id){
  const p = proposals.find(x=>x.id===id);
  if (!p) return;
  // TODO (Supabase):
  // 1) await supa.from('resolutions_proposed').update({ rejected_at: new Date().toISOString(), rejected_reason: 'manual' }).eq('prediction_id', id);
  proposals = proposals.filter(x=>x.id!==id);
  statRejected++;
  el('#s_rejected').textContent = statRejected;
  el('#s_last').textContent = `Rejected ${id}`;
  render();
}

/** Podmiana na realne dane, gdy będziesz gotów */
async function loadProposals(){
  // Przykład:
  // const { data, error } = await supa.from('resolutions_proposed').select('*').order('created_at', { ascending:false });
  // if (!error) { proposals = data.map(mapper); render(); }
}
</script>
</body>
</html>
