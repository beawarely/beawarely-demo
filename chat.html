<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Chat ‚Äî BeAwarely</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body{margin:0;font-family:'Segoe UI',sans-serif;color:#fff;background:radial-gradient(ellipse at top,#0d0d2b 0%,#000 100%);}
    .wrap{max-width:960px;margin:0 auto;padding:28px}
    .chat-card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:16px;padding:16px}
    .chat-messages{
  overflow:auto;padding:10px;border-radius:12px;
  background:rgba(0,0,0,.18);
  display:flex;flex-direction:column;gap:10px;
}
    .msg{max-width:92%;padding:10px 12px;border-radius:12px;white-space:pre-wrap;word-wrap:break-word;box-shadow:0 4px 14px rgba(0,0,0,.15)}
    .msg.user{align-self:flex-end;background:linear-gradient(135deg,#007bff,#66b2ff);color:#fff;border-bottom-right-radius:6px}
    .msg.ai{align-self:flex-start;background:rgba(255,255,255,.09);color:#eaeaea;border-bottom-left-radius:6px}
    .controls{display:grid;grid-template-columns:1fr auto;gap:10px;margin-top:12px}
    textarea{
  resize:none;border-radius:10px;padding:10px;
  background: rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.18);
  color:#eaeaea;
}
.send{
  border:none;border-radius:10px;padding:10px 14px;
  background:linear-gradient(135deg,#007bff,#66b2ff);
  color:#fff;font-weight:600;cursor:pointer;
  transition: transform .06s ease, opacity .2s ease;
}
.send:hover{ transform: translateY(-1px); }
.send:disabled{ opacity:.45; cursor:not-allowed; transform:none; }

.status-note{
  opacity:.65;margin-top:8px;font-size:.9rem;
}

    .topbar{display:flex;align-items:center;gap:10px;margin-bottom:14px}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.18)}
    a.back{color:#66b2ff;text-decoration:none}

    :root{
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}

/* Chat layout -> kolumna */
.chat-card{
  display: flex;
  flex-direction: column;
  min-height: min(78dvh, 620px); /* dvh lepiej na mobile */
  padding-bottom: calc(12px + var(--safe-bottom));
}

/* Messages -> elastyczne wype≈Çnienie */
.chat-messages{
  flex: 1 1 auto;
  max-height: 60dvh;           /* g√≥rny limit na ma≈Çych ekranach */
  height: auto;                /* zamiast sta≈Çej wysoko≈õci */
  -webkit-overflow-scrolling: touch;
}

/* textarea lepiej ‚Äûtrzyma‚Äù siƒô szeroko≈õci, bez skok√≥w */
.controls textarea{
  width: 100%;
  box-sizing: border-box;
}

/* Focus-visible dla dostƒôpno≈õci */
.send:focus-visible,
textarea:focus-visible {
  outline: 2px solid #66b2ff;
  outline-offset: 2px;
}

  .chat-messages{ overscroll-behavior: contain; }
#chatInput{ line-height: 22px; } /* sp√≥jne z autogrow (22px) */

/* ==== Sidebar / History ==== */
.app{ display:flex; gap:16px; }
.sidebar{
  width:260px; flex:0 0 260px;
  background:rgba(255,255,255,.05);
  border:1px solid rgba(255,255,255,.08);
  border-radius:16px; padding:12px; height:fit-content;
  max-height: min(78dvh, 620px); overflow:auto;
}
.side-head{ display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
.mini{
  padding:6px 10px; border:none; border-radius:8px; cursor:pointer;
  background:rgba(255,255,255,.12); color:#fff;
}
.conv-list{ list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:6px; }
.conv-item{
  display:flex; align-items:center; gap:8px;
  padding:8px 10px; border-radius:10px;
  background:rgba(0,0,0,.18); border:1px solid rgba(255,255,255,.08);
  cursor:pointer;
}
.conv-item[aria-selected="true"]{ outline:2px solid #66b2ff; }
.conv-item .title{ flex:1 1 auto; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.conv-item .del{ background:transparent; border:none; color:#bbb; cursor:pointer; }
.main{ flex:1 1 auto; }
@media (max-width: 880px){
  .app{ flex-direction:column; }
  .sidebar{ width:100%; flex:0 0 auto; order:2; }
}
  
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
  <a href="index.html" class="back">‚Üê Back</a>
  <h2 style="margin:0">BeAwarely AI Chat</h2>
  <span id="modelChip" class="badge" hidden></span>
  <div style="margin-left:auto;display:flex;align-items:center;gap:10px">
    <span id="loginStatus" class="badge" aria-live="polite">Checking session‚Ä¶</span>
    <button id="logoutBtn" class="send" type="button" aria-label="Log out">Log out</button>
  </div>
</div>

<div class="app">
  <aside class="sidebar" aria-label="Conversation history">
    <div class="side-head">
      <strong>Conversations</strong>
      <button id="newConvBtn" class="mini">+ New</button>
    </div>
    <ul id="convList" class="conv-list" role="listbox" aria-label="Saved conversations"></ul>
  </aside>

  <div class="main">
    <div class="chat-card">
      <div id="chatMessages" class="chat-messages" aria-live="polite" aria-atomic="false">
        <div class="msg ai">Hello! You‚Äôre logged in. Ask me anything. üëã</div>
      </div>
      <div class="controls">
        <textarea id="chatInput" aria-label="Message input" rows="2"
  placeholder="Type and press Enter‚Ä¶"
  autocomplete="off"
  autocapitalize="sentences"
  spellcheck="true"
  inputmode="text"></textarea>

<button id="sendBtn" class="send" aria-label="Send message">Send</button>

      </div>
      <div class="status-note" id="backendStatus" aria-live="polite">Not connected to backend yet</div>
    </div>
  </div> <!-- .main -->
</div>   <!-- .app -->

    <script>
    // === Supabase: jeden klient dla ca≈Çego serwisu (sp√≥jnie z index.html) ===
    (function initSupabaseOnce(){
      const SB_URL = 'https://xzwpqyomqjzmiqsszwkg.supabase.co';
      const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh6d3BxeW9tcWp6bWlxc3N6d2tnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0MjIxMTYsImV4cCI6MjA2OTk5ODExNn0.QbjDO1xifFkDuIAZZ9WHfGomgxwhanP9BQtgMrFqDgg';
      if (!window.supabaseClient) {
        window.supabaseClient = window.supabase.createClient(SB_URL, SB_KEY);
      }
    })();

    // Ciche domkniƒôcie ewentualnego loginModal (gdy wr√≥cono z index.html)
    (function closeStrayLoginModal(){
      const lm = document.getElementById('loginModal');
      if (lm) lm.classList.remove('open');
      document.body.style.overflow = '';
    })();

    // === Helper: poczekaj na bie≈ºƒÖcƒÖ sesjƒô ===
    async function waitForInitialSession(){
      const { data: { session }, error } = await window.supabaseClient.auth.getSession();
      if (error) console.warn('getSession error:', error.message || error);
      return session || null;
    }

    // === Brama: wymagaj zalogowania + ustaw redirect po zalogowaniu ===
    (async () => {
      const session = await waitForInitialSession();
      if (!session) {
        localStorage.setItem('ba_redirect', 'chat.html');
        location.replace('index.html?login=1');
        return;
      }
      // UI status
      const st = document.getElementById('loginStatus');
      if (st) st.textContent = 'Logged in';
    })();

    // === Reakcja na wylogowanie z innej karty ===
    window.supabaseClient.auth.onAuthStateChange((event) => {
      if (event === 'SIGNED_OUT') {
        location.replace('index.html');
      }
    });

    // === Log out (sp√≥jny z index.html) ===
    async function logoutUser(){
      try { await window.supabaseClient.auth.signOut(); }
      catch(e){ console.warn('signOut failed:', e?.message || e); }
      finally { location.replace('index.html'); }
    }
    document.addEventListener('DOMContentLoaded', ()=>{
      const btn = document.getElementById('logoutBtn');
      if (btn) btn.addEventListener('click', logoutUser);
    });
  </script>

<script>
// --- Ustaw widoczny ‚Äûprzydomek‚Äù modelu (bez zdradzania konkretu) --- //
(function initModelChip(){
  const MODEL_DISPLAY_NAME = (localStorage.getItem('ba_model_name') || 'BeAwarely Core').trim();
  const chip = document.getElementById('modelChip');
  if (chip && MODEL_DISPLAY_NAME){
    chip.textContent = MODEL_DISPLAY_NAME;
    chip.hidden = false;
  }
})();
</script>

<script>
// ==== Conversation history (localStorage, per-user) ==== //
const STORAGE_KEY = 'ba_chat_history';
const CURRENT_KEY = 'ba_current_conv';

function userScopedKey(base){
  // je≈õli chcesz kiedy≈õ wersjƒô per-user z Supabase: dopisz user.id do klucza
  return base;
}

function loadHistory(){
  try{ return JSON.parse(localStorage.getItem(userScopedKey(STORAGE_KEY))) || []; }
  catch{ return []; }
}
function saveHistory(list){
  localStorage.setItem(userScopedKey(STORAGE_KEY), JSON.stringify(list));
}
function getCurrentId(){ return localStorage.getItem(userScopedKey(CURRENT_KEY)); }
function setCurrentId(id){ localStorage.setItem(userScopedKey(CURRENT_KEY), id); }

function createConversation(title){
  const id = 'c_' + crypto.randomUUID();
  const conv = { id, title: (title||'New conversation'), created: Date.now(), messages: [] };
  const list = loadHistory(); list.unshift(conv); saveHistory(list); setCurrentId(id); return conv;
}
function findConv(id){
  return loadHistory().find(c=>c.id===id) || null;
}
function updateConv(conv){
  const list = loadHistory();
  const idx = list.findIndex(c=>c.id===conv.id);
  if(idx>=0){ list[idx]=conv; saveHistory(list); }
}

function renderHistory(){
  const ul = document.getElementById('convList');
  if(!ul) return;
  const list = loadHistory();
  const current = getCurrentId();
  ul.innerHTML = '';
  list.forEach(c=>{
    const li = document.createElement('li');
    li.className='conv-item';
    li.setAttribute('role','option');
    li.setAttribute('aria-selected', String(c.id===current));
    li.dataset.id = c.id;

    const span = document.createElement('span');
    span.className='title';
    span.textContent = c.title;

    const del = document.createElement('button');
    del.className='del'; del.title='Delete';
    del.textContent='√ó';

    li.appendChild(span); li.appendChild(del);
    ul.appendChild(li);
  });
}

function selectConversation(id){
  const conv = findConv(id);
  if(!conv) return;
  setCurrentId(id);
  renderHistory();
  // za≈Çaduj wiadomo≈õci do czatu
  const msgsBox = document.getElementById('chatMessages');
  msgsBox.innerHTML = '';
  conv.messages.forEach(m=>{
    addMsg(m.content, m.role==='user' ? 'user' : 'ai', /*store*/false);
  });
   // fokus w input + od≈õwie≈ºenie stanu przycisku
  const inputEl = document.getElementById('chatInput');
  inputEl?.focus();
  updateSendDisabled();
}

function ensureConversation(firstMsg){
  let id = getCurrentId();
  let conv = id ? findConv(id) : null;
  if(!conv){
    conv = createConversation(firstMsg?.slice(0,40) || 'New conversation');
    renderHistory();
  }
  return conv;
}

document.addEventListener('DOMContentLoaded', ()=>{
  const newBtn = document.getElementById('newConvBtn');
  const listEl = document.getElementById('convList');

 newBtn?.addEventListener('click', ()=>{
  createConversation('New conversation');
  renderHistory();
  // wyczy≈õƒá okno
  const msgsBox = document.getElementById('chatMessages');
  msgsBox.innerHTML = '<div class="msg ai">Hello! You‚Äôre logged in. Ask me anything. üëã</div>';
  // dopieszczka: od razu fokus i aktualizacja przycisku
  document.getElementById('chatInput')?.focus();
  updateSendDisabled();
});

  listEl?.addEventListener('click', (e)=>{
    const target = e.target;
    const item = target.closest('.conv-item');
    if(!item) return;
    const id = item.dataset.id;

    if(target.classList.contains('del')){
      const list = loadHistory().filter(c=>c.id!==id);
      saveHistory(list);
      if(getCurrentId()===id){ localStorage.removeItem(userScopedKey(CURRENT_KEY)); }
      renderHistory();
      return;
    }
    selectConversation(id);
  });

  // pierwsze renderowanie
  renderHistory();
  // je≈õli co≈õ jest wybrane ‚Äì za≈Çaduj
  const cur = getCurrentId();
  if(cur){ selectConversation(cur); }
});
</script>

<script>
    // Prosty handler UI (na razie bez po≈ÇƒÖczenia do backendu)
    const msgs = document.getElementById('chatMessages');
    const input = document.getElementById('chatInput');
    const send = document.getElementById('sendBtn');

function updateSendDisabled(){ send.disabled = !input.value.trim(); }
input.addEventListener('input', updateSendDisabled);
document.addEventListener('DOMContentLoaded', updateSendDisabled);

    function addMsg(text, who, store = true){
  const role = (who === 'user') ? 'user' : 'ai';
  const el = document.createElement('div');
  el.className = 'msg ' + (role === 'user' ? 'user' : 'ai');
  el.textContent = text;
  msgs.appendChild(el);
  msgs.scrollTop = msgs.scrollHeight;

  if(store){
    const conv = ensureConversation(role==='user' ? text : undefined);
    conv.messages.push({ role, content: text, ts: Date.now() });
    // je≈õli to pierwsza wiadomo≈õƒá u≈ºytkownika ‚Äì ustaw tytu≈Ç
    if(conv.messages.length === 1 && role==='user'){
      conv.title = text.slice(0, 40);
    }
    updateConv(conv);
    renderHistory();
  }
}

    input.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' && !e.shiftKey){
        e.preventDefault(); 
        send.click();
      }
    });

    send.onclick = () => {
  const q = input.value.trim();
  if (!q) return;
  addMsg(q, "user");
  input.value = "";

  (async () => {
    try {
      const st = document.getElementById("backendStatus");
      if (st) st.textContent = "Backend: connecting‚Ä¶";

      const resp = await fetch("https://ai.beawarely.com/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          model: "llama2:7b",
          messages: [{ role: "user", content: q }]
        })
      });

      if (!resp.ok || !resp.body) {
        throw new Error(`HTTP ${resp.status}`);
      }

      const reader = resp.body.getReader();
      const decoder = new TextDecoder();
      let fullText = "";

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        const chunk = decoder.decode(value, { stream: true });
        for (const line of chunk.split("\n")) {
          if (!line.trim()) continue;
          try {
            const obj = JSON.parse(line);
            if (obj.message?.content) {
              fullText += obj.message.content;
            }
          } catch (e) {
            console.warn("Parse error:", e, line);
          }
        }
      }

      addMsg(fullText || "[no response]", "ai");
      if (st) st.textContent = "‚úÖ Connected";
    } catch (err) {
      console.error("Chat error:", err);
      addMsg("‚ö†Ô∏è Backend error, try again later.", "ai");
      const st = document.getElementById("backendStatus");
      if (st) st.textContent = "Backend: error";
    }
  })();
};

    document.addEventListener('DOMContentLoaded', ()=>{ 
      if(msgs) msgs.scrollTop = msgs.scrollHeight; 
    });
  </script>


  <script>
  // --- Autogrow textarea + stabilne przewijanie --- //
  (function(){
    const input = document.getElementById('chatInput');
    const msgs  = document.getElementById('chatMessages');
    const send  = document.getElementById('sendBtn');

    if (!input || !msgs) return;

    function scrollToBottom(){
      // requestAnimationFrame = p≈Çynny scroll po DOM update
      requestAnimationFrame(()=>{ msgs.scrollTop = msgs.scrollHeight; });
    }

    function autoGrow(){
      input.style.height = 'auto';
      const max = 6 * 22; // ok. 6 linii (22px line-height)
      input.style.height = Math.min(input.scrollHeight, max) + 'px';
    }

    input.addEventListener('input', autoGrow);
    // pierwsze wyliczenie
    autoGrow();

    // zabezpieczenie przed wielokrotnym klikaniem
    let sending = false;
    if (send){
      const origHandler = send.onclick;
      send.onclick = async () => {
        if (sending) return;
        sending = true;
        try {
          await origHandler?.();
        } finally {
  sending = false;
  scrollToBottom();
  autoGrow();
  input.focus(); // ‚¨ÖÔ∏è utrzymaj fokus po wys≈Çaniu
}
      };
    }

    // po ka≈ºdych 300ms ‚Äì je≈õli co≈õ dosz≈Ço asynchronicznie, dociƒÖgnij d√≥≈Ç
    // (lekki ‚Äûwatcher‚Äù; mo≈ºesz usunƒÖƒá, je≈õli zbƒôdny)
    let prevCount = 0;
    setInterval(()=>{
      const count = msgs.children.length;
      if (count !== prevCount){
        prevCount = count;
        scrollToBottom();
      }
    }, 300);
  })();
</script>

</body>
</html>
