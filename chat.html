<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Chat ‚Äî BeAwarely</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body{margin:0;font-family:'Segoe UI',sans-serif;color:#fff;background:radial-gradient(ellipse at top,#0d0d2b 0%,#000 100%);}
    .wrap{max-width:960px;margin:0 auto;padding:28px}
    .chat-card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:16px;padding:16px}
    .chat-messages{height:min(60vh,520px);overflow:auto;padding:10px;border-radius:12px;background:rgba(0,0,0,.18);display:flex;flex-direction:column;gap:10px}
    .msg{max-width:92%;padding:10px 12px;border-radius:12px;white-space:pre-wrap;word-wrap:break-word;box-shadow:0 4px 14px rgba(0,0,0,.15)}
    .msg.user{align-self:flex-end;background:linear-gradient(135deg,#007bff,#66b2ff);color:#fff;border-bottom-right-radius:6px}
    .msg.ai{align-self:flex-start;background:rgba(255,255,255,.09);color:#eaeaea;border-bottom-left-radius:6px}
    .controls{display:grid;grid-template-columns:1fr auto;gap:10px;margin-top:12px}
    textarea{resize:none;border-radius:10px;padding:10px}
    .send{border:none;border-radius:10px;padding:10px 14px;background:linear-gradient(135deg,#007bff,#66b2ff);color:#fff;font-weight:600;cursor:pointer}
    .topbar{display:flex;align-items:center;gap:10px;margin-bottom:14px}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.18)}
    a.back{color:#66b2ff;text-decoration:none}

    :root{
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}

/* Chat layout -> kolumna */
.chat-card{
  display: flex;
  flex-direction: column;
  min-height: min(78dvh, 620px); /* dvh lepiej na mobile */
  padding-bottom: calc(12px + var(--safe-bottom));
}

/* Messages -> elastyczne wype≈Çnienie */
.chat-messages{
  flex: 1 1 auto;
  max-height: 60dvh;           /* g√≥rny limit na ma≈Çych ekranach */
  height: auto;                /* zamiast sta≈Çej wysoko≈õci */
  -webkit-overflow-scrolling: touch;
}

/* textarea lepiej ‚Äûtrzyma‚Äù siƒô szeroko≈õci, bez skok√≥w */
.controls textarea{
  width: 100%;
  box-sizing: border-box;
}

/* Focus-visible dla dostƒôpno≈õci */
.send:focus-visible,
textarea:focus-visible {
  outline: 2px solid #66b2ff;
  outline-offset: 2px;
}

  .chat-messages{ overscroll-behavior: contain; }
#chatInput{ line-height: 22px; } /* sp√≥jne z autogrow (22px) */
  
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
  <a href="index.html" class="back">‚Üê Back</a>
  <h2 style="margin:0">BeAwarely AI Chat</h2>
  <span class="badge">Mistral-7B-Instruct-Q6_K</span>
  <div style="margin-left:auto;display:flex;align-items:center;gap:10px">
    <span id="loginStatus" class="badge" aria-live="polite">Checking session‚Ä¶</span>
    <button id="logoutBtn" class="send" type="button" aria-label="Log out">Log out</button>
  </div>
</div>


    <div class="chat-card">
      <div id="chatMessages" class="chat-messages" aria-live="polite" aria-atomic="false">
        <div class="msg ai">Hello! You‚Äôre logged in. Ask me anything. üëã</div>
      </div>
      <div class="controls">
        <textarea id="chatInput" aria-label="Message input" rows="2"
  placeholder="Type and press Enter‚Ä¶"
  autocomplete="off"
  autocapitalize="sentences"
  spellcheck="true"
  inputmode="text"></textarea>

<button id="sendBtn" class="send" aria-label="Send message">Send</button>

      </div>
      <div style="opacity:.7;margin-top:8px;font-size:.9rem">Backend not connected yet</div>
    </div>
  </div>

    <script>
    // === Supabase: jeden klient dla ca≈Çego serwisu (sp√≥jnie z index.html) ===
    (function initSupabaseOnce(){
      const SB_URL = 'https://xzwpqyomqjzmiqsszwkg.supabase.co';
      const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh6d3BxeW9tcWp6bWlxc3N6d2tnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0MjIxMTYsImV4cCI6MjA2OTk5ODExNn0.QbjDO1xifFkDuIAZZ9WHfGomgxwhanP9BQtgMrFqDgg';
      if (!window.supabaseClient) {
        window.supabaseClient = window.supabase.createClient(SB_URL, SB_KEY);
      }
    })();

    // Ciche domkniƒôcie ewentualnego loginModal (gdy wr√≥cono z index.html)
    (function closeStrayLoginModal(){
      const lm = document.getElementById('loginModal');
      if (lm) lm.classList.remove('open');
      document.body.style.overflow = '';
    })();

    // === Helper: poczekaj na bie≈ºƒÖcƒÖ sesjƒô ===
    async function waitForInitialSession(){
      const { data: { session }, error } = await window.supabaseClient.auth.getSession();
      if (error) console.warn('getSession error:', error.message || error);
      return session || null;
    }

    // === Brama: wymagaj zalogowania + ustaw redirect po zalogowaniu ===
    (async () => {
      const session = await waitForInitialSession();
      if (!session) {
        localStorage.setItem('ba_redirect', 'chat.html');
        location.replace('index.html?login=1');
        return;
      }
      // UI status
      const st = document.getElementById('loginStatus');
      if (st) st.textContent = 'Logged in';
    })();

    // === Reakcja na wylogowanie z innej karty ===
    window.supabaseClient.auth.onAuthStateChange((event) => {
      if (event === 'SIGNED_OUT') {
        location.replace('index.html');
      }
    });

    // === Log out (sp√≥jny z index.html) ===
    async function logoutUser(){
      try { await window.supabaseClient.auth.signOut(); }
      catch(e){ console.warn('signOut failed:', e?.message || e); }
      finally { location.replace('index.html'); }
    }
    document.addEventListener('DOMContentLoaded', ()=>{
      const btn = document.getElementById('logoutBtn');
      if (btn) btn.addEventListener('click', logoutUser);
    });
  </script>

  <script>
    // Prosty handler UI (na razie bez po≈ÇƒÖczenia do Mistrala)
    const msgs = document.getElementById('chatMessages');
    const input = document.getElementById('chatInput');
    const send = document.getElementById('sendBtn');

    function addMsg(text, who){
      const el = document.createElement('div');
      el.className = 'msg ' + (who || 'ai');
      el.textContent = text;
      msgs.appendChild(el);
      msgs.scrollTop = msgs.scrollHeight;
    }

    input.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' && !e.shiftKey){
        e.preventDefault(); 
        send.click();
      }
    });

    send.onclick = () => {
      const q = input.value.trim();
      if(!q) return;
      addMsg(q, 'user');
      input.value = '';
      // tu p√≥≈∫niej wstawisz fetch do swojego endpointu Mistrala
      setTimeout(()=>addMsg('This is a placeholder response. Connect your Mistral endpoint to get real answers.'), 400);
    };

    document.addEventListener('DOMContentLoaded', ()=>{ 
      if(msgs) msgs.scrollTop = msgs.scrollHeight; 
    });
  </script>


  <script>
  // --- Autogrow textarea + stabilne przewijanie --- //
  (function(){
    const input = document.getElementById('chatInput');
    const msgs  = document.getElementById('chatMessages');
    const send  = document.getElementById('sendBtn');

    if (!input || !msgs) return;

    function scrollToBottom(){
      // requestAnimationFrame = p≈Çynny scroll po DOM update
      requestAnimationFrame(()=>{ msgs.scrollTop = msgs.scrollHeight; });
    }

    function autoGrow(){
      input.style.height = 'auto';
      const max = 6 * 22; // ok. 6 linii (22px line-height)
      input.style.height = Math.min(input.scrollHeight, max) + 'px';
    }

    input.addEventListener('input', autoGrow);
    // pierwsze wyliczenie
    autoGrow();

    // zabezpieczenie przed wielokrotnym klikaniem
    let sending = false;
    if (send){
      const origHandler = send.onclick;
      send.onclick = async () => {
        if (sending) return;
        sending = true;
        try {
          await origHandler?.();
        } finally {
  sending = false;
  scrollToBottom();
  autoGrow();
  input.focus(); // ‚¨ÖÔ∏è utrzymaj fokus po wys≈Çaniu
}
      };
    }

    // po ka≈ºdych 300ms ‚Äì je≈õli co≈õ dosz≈Ço asynchronicznie, dociƒÖgnij d√≥≈Ç
    // (lekki ‚Äûwatcher‚Äù; mo≈ºesz usunƒÖƒá, je≈õli zbƒôdny)
    let prevCount = 0;
    setInterval(()=>{
      const count = msgs.children.length;
      if (count !== prevCount){
        prevCount = count;
        scrollToBottom();
      }
    }, 300);
  })();
</script>

</body>
</html>
