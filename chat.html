<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Chat ‚Äî BeAwarely</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.44.4/dist/umd/supabase.min.js"></script>
  <script src="js/supabase-client.js"></script>
  <style>
    body{
  margin:0;
  font-family:'Segoe UI',sans-serif;
  color:#fff;
  background:#020617;
  background-image:
    radial-gradient(2px 2px at 20% 30%, rgba(255,255,255,.85), transparent),
    radial-gradient(1.5px 1.5px at 80% 20%, rgba(255,255,255,.7), transparent),
    radial-gradient(1px 1px at 10% 80%, rgba(255,255,255,.5), transparent);
  background-size:260px 260px,320px 320px,400px 400px;
  animation:moveStars 120s linear infinite;
}

@keyframes moveStars{
  from{
    background-position:0 0,0 0,0 0;
  }
  to{
    background-position:600px 800px,-500px 600px,400px -600px;
  }
}

body::before,
body::after{
  content:"";
  position:fixed;
  top:0;
  left:0;
  width:2px;
  height:160px;
  pointer-events:none;
  opacity:0;
  background:linear-gradient(to bottom, rgba(255,255,255,.95), rgba(255,255,255,0));
  filter:drop-shadow(0 0 6px rgba(255,255,255,.9));
}

body::before{
  animation:shootingStar1 14s linear infinite;
}

body::after{
  animation:shootingStar2 18s linear infinite;
  animation-delay:4s;
}

@keyframes shootingStar1{
  0%,65%{
    opacity:0;
    transform:translate3d(-10vw,-10vh,0) rotate(35deg);
  }
  70%{
    opacity:1;
  }
  85%{
    opacity:1;
    transform:translate3d(40vw,40vh,0) rotate(35deg);
  }
  100%{
    opacity:0;
    transform:translate3d(65vw,65vh,0) rotate(35deg);
  }
}

@keyframes shootingStar2{
  0%,60%{
    opacity:0;
    transform:translate3d(100vw,-20vh,0) rotate(35deg);
  }
  65%{
    opacity:1;
  }
  80%{
    opacity:1;
    transform:translate3d(40vw,40vh,0) rotate(35deg);
  }
  100%{
    opacity:0;
    transform:translate3d(10vw,80vh,0) rotate(35deg);
  }
}
    
    .wrap{max-width:960px;margin:0 auto;padding:28px}
    .chat-card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:16px;padding:16px}
    .chat-messages{
  overflow:auto;padding:10px;border-radius:12px;
  background:rgba(0,0,0,.18);
  display:flex;flex-direction:column;gap:10px;
}
    .msg{max-width:92%;padding:10px 12px;border-radius:12px;white-space:pre-wrap;word-wrap:break-word;box-shadow:0 4px 14px rgba(0,0,0,.15)}
    .msg.user{align-self:flex-end;background:linear-gradient(135deg,#007bff,#66b2ff);color:#fff;border-bottom-right-radius:6px}
    .msg.ai{align-self:flex-start;background:rgba(255,255,255,.09);color:#eaeaea;border-bottom-left-radius:6px}
    .controls{display:grid;grid-template-columns:1fr auto;gap:10px;margin-top:12px}
    textarea{
  resize:none;border-radius:10px;padding:10px;
  background: rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.18);
  color:#eaeaea;
}
.send{
  border:none;border-radius:10px;padding:10px 14px;
  background:linear-gradient(135deg,#007bff,#66b2ff);
  color:#fff;font-weight:600;cursor:pointer;
  transition: transform .06s ease, opacity .2s ease;
}
.send:hover{ transform: translateY(-1px); }
.send:disabled{ opacity:.45; cursor:not-allowed; transform:none; }

.status-note{
  opacity:.65;margin-top:8px;font-size:.9rem;
}

    .topbar{display:flex;align-items:center;gap:10px;margin-bottom:14px}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.18)}
    a.back{color:#66b2ff;text-decoration:none}

    :root{
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}

/* Chat layout -> kolumna */
.chat-card{
  display: flex;
  flex-direction: column;
  min-height: min(78dvh, 620px); /* dvh lepiej na mobile */
  padding-bottom: calc(12px + var(--safe-bottom));
}

/* Messages -> elastyczne wype≈Çnienie */
.chat-messages{
  flex: 1 1 auto;
  max-height: 60dvh;           /* g√≥rny limit na ma≈Çych ekranach */
  height: auto;                /* zamiast sta≈Çej wysoko≈õci */
  -webkit-overflow-scrolling: touch;
}

/* textarea lepiej ‚Äûtrzyma‚Äù siƒô szeroko≈õci, bez skok√≥w */
.controls textarea{
  width: 100%;
  box-sizing: border-box;
}

/* Focus-visible dla dostƒôpno≈õci */
.send:focus-visible,
textarea:focus-visible {
  outline: 2px solid #66b2ff;
  outline-offset: 2px;
}

  .chat-messages{ overscroll-behavior: contain; }
#chatInput{ line-height: 22px; } /* sp√≥jne z autogrow (22px) */

/* ==== Sidebar / History ==== */
.app{ display:flex; gap:16px; }
.app.app-sidebar-hidden .sidebar{ display:none; }
.sidebar{
  width:260px; flex:0 0 260px;
  background:rgba(255,255,255,.05);
  border:1px solid rgba(255,255,255,.08);
  border-radius:16px; padding:12px; height:fit-content;
  max-height: min(78dvh, 620px); overflow:auto;
}

.side-head{ display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
.mini{
  padding:6px 10px; border:none; border-radius:8px; cursor:pointer;
  background:rgba(255,255,255,.12); color:#fff;
}
.conv-list{ list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:6px; }
.conv-item{
  display:flex; align-items:center; gap:8px;
  padding:8px 10px; border-radius:10px;
  background:rgba(0,0,0,.18); border:1px solid rgba(255,255,255,.08);
  cursor:pointer;
}
.conv-item[aria-selected="true"]{ outline:2px solid #66b2ff; }
.conv-item .title{ flex:1 1 auto; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.conv-item .del{ background:transparent; border:none; color:#bbb; cursor:pointer; }
.main{ flex:1 1 auto; }
@media (max-width: 880px){
  .app{ flex-direction:column; }
  .sidebar{ width:100%; flex:0 0 auto; order:2; }
}

#historyToggle{
  background:rgba(255,255,255,.14);
  border:1px solid rgba(255,255,255,.32);
  color:#fff;
}

#historyToggle:hover{
  background:rgba(255,255,255,.22);
}

#modelSelect{
  background:rgba(0,0,0,.35) !important;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.18);
  color:#eee;
}
  
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
  <button id="historyToggle" class="badge" aria-label="Toggle chat history" style="margin-right:8px;">‚ò∞</button>
  <a href="index.html" class="back">‚Üê Back</a>
  <h2 style="margin:0">BeAwarely AI Chat</h2>
  <div style="margin-left:auto;display:flex;align-items:center;gap:10px">
  <select id="modelSelect" class="badge" style="background:rgba(...;border:none;border-radius:8px;padding:4px 8px;cursor:pointer;">
        <option value="freerainboxbox/phi4:14b-q6_K">MattFast (freerainboxbox/phi4:14b-q6_K)</option>
    <option value="mixtral:8x7b-instruct-v0.1-q6_K">MattThinker (Mixtral Q6_K)</option>
  </select>
</div>
</div>

<div class="app app-sidebar-hidden">
  <aside class="sidebar" aria-label="Conversation history">
    <div class="side-head">
      <strong>Conversations</strong>
      <button id="newConvBtn" class="mini">+ New</button>
    </div>
    <ul id="convList" class="conv-list" role="listbox" aria-label="Saved conversations"></ul>
  </aside>

  <div class="main">
    <div class="chat-card">
      <div id="chatMessages" class="chat-messages" aria-live="polite" aria-atomic="false" role="log">
        <div class="msg ai">Hello! You‚Äôre logged in. Ask me anything. üëã</div>
      </div>
      <div class="controls">
        <textarea id="chatInput" aria-label="Message input" rows="2"
  placeholder="Type and press Enter‚Ä¶"
  autocomplete="off"
  autocapitalize="sentences"
  spellcheck="true"
  inputmode="text"></textarea>

<button id="sendBtn" class="send" aria-label="Send message">Send</button>

      </div>
      <div class="status-note" id="backendStatus" aria-live="polite">Not connected to backend yet</div>
    </div>
  </div> <!-- .main -->
</div>   <!-- .app -->

    <script>

    // Ciche domkniƒôcie ewentualnego loginModal (gdy wr√≥cono z index.html)
    (function closeStrayLoginModal(){
      const lm = document.getElementById('loginModal');
      if (lm) lm.classList.remove('open');
      document.body.style.overflow = '';
    })();

    // === Helper: poczekaj na bie≈ºƒÖcƒÖ sesjƒô ===
    async function waitForInitialSession(){
      const { data: { session }, error } = await window.supabaseClient.auth.getSession();
      if (error) console.warn('getSession error:', error.message || error);
      return session || null;
    }

    // === Brama: wymagaj zalogowania + ustaw redirect po zalogowaniu ===
    (async () => {
      const session = await waitForInitialSession();
      if (!session) {
        localStorage.setItem('ba_redirect', 'chat.html');
        location.replace('index.html?login=1');
        return;
      }
      // UI status
      const st = document.getElementById('loginStatus');
      if (st) st.textContent = 'Logged in';
    })();

    // === Reakcja na wylogowanie z innej karty ===
    window.supabaseClient.auth.onAuthStateChange((event) => {
  if (event === 'SIGNED_OUT') {
    try {
      // wyczy≈õƒá stan rozmowy (po ponownym logowaniu zaczniemy nowy czat)
      sessionStorage.removeItem('ba_current_conv');
      localStorage.removeItem('ba_current_conv');   // cleanup starego podej≈õcia
      localStorage.removeItem('ba_chat_history');   // legacy local cache
      localStorage.removeItem('ba_last_user');
    } catch {}
    location.replace('index.html');
  }
});

   // === Model selector (MattFast / MattThinker) ===
document.addEventListener('DOMContentLoaded', ()=>{
  const select = document.getElementById('modelSelect');
  const saved = localStorage.getItem('ba_model_id') || "freerainboxbox/phi4:14b-q6_K";

  select.value = saved;
  select.addEventListener('change', ()=>{
    const val = select.value;
    localStorage.setItem('ba_model_id', val);
  });
});
   
  </script>

<script>
// --- Ustaw widoczny ‚Äûprzydomek‚Äù modelu (bez zdradzania konkretu) --- //
(function initModelChip(){
  const MODEL_DISPLAY_NAME = (localStorage.getItem('ba_model_name') || 'BeAwarely Core').trim();
  const chip = document.getElementById('modelChip');
  if (chip && MODEL_DISPLAY_NAME){
    chip.textContent = MODEL_DISPLAY_NAME;
    chip.hidden = false;
  }
})();
</script>

<script>
// Toggle chat history sidebar (hamburger in topbar)
document.addEventListener('DOMContentLoaded', ()=>{
  const app = document.querySelector('.app');
  const btn  = document.getElementById('historyToggle');
  if (!app || !btn) return;
  btn.addEventListener('click', ()=>{
    app.classList.toggle('app-sidebar-hidden');
  });
});
</script>

<script>
// ==== Conversation history in Supabase (per-user) ==== //
const sb = window.supabaseClient;
const CURRENT_KEY = 'ba_current_conv';
let USER_ID = null;

// sessionStorage = dzia≈Ça po od≈õwie≈ºeniu, znika po zamkniƒôciu karty/okna
function getCurrentId(){ return sessionStorage.getItem(CURRENT_KEY); }
function setCurrentId(id){ sessionStorage.setItem(CURRENT_KEY, id); }

async function ensureSession(){
  const { data: { session } } = await sb.auth.getSession();
  USER_ID = session?.user?.id || null;

  // nowy czat po zmianie u≈ºytkownika
  try {
    const last = localStorage.getItem('ba_last_user');
    if (USER_ID && last && last !== USER_ID){
      localStorage.removeItem('ba_current_conv');
    }
    if (USER_ID) localStorage.setItem('ba_last_user', USER_ID);
  } catch {}
}

async function ensureCurrentConversationValid(){
  const id = getCurrentId();
  if (!id || !USER_ID) return;
  const { data, error } = await sb
    .from('chat_conversations')
    .select('id')
    .eq('id', id)
    .eq('user_id', USER_ID)
    .maybeSingle();
  if (error || !data){
    localStorage.removeItem('ba_current_conv');
  }
}

function resetChatUI(){
  const msgsBox = document.getElementById('chatMessages');
  if (msgsBox){
    msgsBox.innerHTML = '<div class="msg ai">Hello! You‚Äôre logged in. Ask me anything. üëã</div>';
  }
  document.getElementById('chatInput')?.focus();
  updateSendDisabled?.();
}

async function newConversation(title='New conversation'){
  const { data, error } = await sb
    .from('chat_conversations')
    // startujemy z NULL, tytu≈Ç nadamy po 1. wiadomo≈õci usera
    .insert({ title: null, user_id: USER_ID })
    .select('id')
    .single();

  if (error) { console.warn('create conv error:', error); return null; }
  const convId = data.id;
  setCurrentId(convId);
  await renderServerHistory(convId);
  resetChatUI();
  return convId;
}

async function renderServerHistory(selectedId){
  const ul = document.getElementById('convList');
  if(!ul || !USER_ID) return;
  const { data, error } = await sb
    .from('chat_conversations')
    .select('id,title,updated_at')
    .eq('user_id', USER_ID)
    .order('updated_at', { ascending: false })
    .limit(100);
  if (error) { console.warn('list conv error:', error); return; }

  const current = selectedId || getCurrentId();
  ul.innerHTML = '';
  (data||[]).forEach(c=>{
    const li = document.createElement('li');
    li.className='conv-item';
    li.setAttribute('role','option');
    li.setAttribute('aria-selected', String(c.id===current));
    li.dataset.id = c.id;

    const span = document.createElement('span');
    span.className='title';
    span.textContent = (c.title && c.title.trim()) ? c.title : 'New conversation';

    const del = document.createElement('button');
    del.className='del'; del.title='Delete'; del.textContent='√ó';

    li.appendChild(span); li.appendChild(del);
    ul.appendChild(li);
  });
}

async function selectConversation(id){
  if(!id) return;
  setCurrentId(id);
  await renderServerHistory(id);

  const { data, error } = await sb
    .from('chat_messages')
    .select('role,content,created_at')
    .eq('conversation_id', id)
    .order('created_at', { ascending: true });
  if (error) { console.warn('load msgs error:', error); return; }

  const msgsBox = document.getElementById('chatMessages');
  msgsBox.innerHTML = '';
  (data||[]).forEach(m=>{
    addMsg(m.content, m.role==='user' ? 'user' : 'ai', /*store*/false);
  });

  document.getElementById('chatInput')?.focus();
  updateSendDisabled?.();
}

document.addEventListener('DOMContentLoaded', ()=>{
  const newBtn = document.getElementById('newConvBtn');
  const listEl = document.getElementById('convList');

  newBtn?.addEventListener('click', async ()=>{
  // nie tw√≥rz rekordu dop√≥ki user nie wy≈õle 1. wiadomo≈õci
  try { sessionStorage.removeItem(CURRENT_KEY); } catch {}
  resetChatUI();
  await renderServerHistory();
});

  listEl?.addEventListener('click', async (e)=>{
    const target = e.target;
    const item = target.closest('.conv-item');
    if(!item) return;
    const id = item.dataset.id;

    if (target.classList.contains('del')){
      const { error } = await sb
        .from('chat_conversations')
        .delete()
        .eq('id', id)
        .eq('user_id', USER_ID);
      if (error) { console.warn('delete conv error:', error); return; }
      if (getCurrentId()===id){ localStorage.removeItem('ba_current_conv'); }
      await renderServerHistory();
      resetChatUI();
      return;
    }
    await selectConversation(id);
  });

  (async ()=>{
  await ensureSession();
  await ensureCurrentConversationValid();
  await renderServerHistory();
  const cur = getCurrentId();
  if (cur){ await selectConversation(cur); }
  else { resetChatUI(); } // nie zapisujemy pustych czat√≥w
})();
});
</script>

<script>
       // Prosty handler UI
    const msgs = document.getElementById('chatMessages');
    const input = document.getElementById('chatInput');
    const send = document.getElementById('sendBtn');

    let isStreaming = false;
    let abortController = null;

    function setStatus(state){
  const st = document.getElementById('backendStatus');
  if (!st) return;

  switch(state){
    case 'offline':
      st.textContent = 'üõë Offline';
      break;
    case 'connected':
      st.textContent = 'üü¢ Connected';
      break;
    case 'connecting':
      st.textContent = 'üü° Connecting‚Ä¶';
      break;
    case 'generating':
      st.textContent = 'üü† Generating‚Ä¶';
      break;
    case 'error':
      st.textContent = 'üî¥ Error';
      break;
    default:
      st.textContent = state;
  }
}

function setBusyUI(){
  isStreaming = true;
  send.disabled = false;
  send.textContent = 'Stop';
  send.setAttribute('aria-label','Stop generating');
  send.dataset.mode = 'stop';
  setStatus('generating');
}

function setIdleUI(){
  isStreaming = false;
  send.dataset.mode = 'send';
  send.textContent = 'Send';
  setStatus('connected');
  updateSendDisabled();
}

window.addEventListener('offline', () => setStatus('offline'));
window.addEventListener('online',  () => setStatus('connected'));

    function updateSendDisabled(){
      // gdy trwa generowanie ‚Äì przycisk jest aktywny jako STOP
      send.disabled = isStreaming ? false : !input.value.trim();
    }
    input.addEventListener('input', updateSendDisabled);
    document.addEventListener('DOMContentLoaded', updateSendDisabled);

    function addMsg(text, who, store = true){
  const role = (who === 'user') ? 'user' : 'assistant';
  const el = document.createElement('div');
  el.className = 'msg ' + (role === 'user' ? 'user' : 'ai');
  el.textContent = text;
  msgs.appendChild(el);
  msgs.scrollTop = msgs.scrollHeight;

  if (store){
    (async ()=>{
      // Upewnij siƒô, ≈ºe mamy aktywnƒÖ sesjƒô i rozmowƒô
      if (!USER_ID) {
        await ensureSession();
        if (!USER_ID) {
          console.warn('Brak USER_ID ‚Äî nie zapisano wiadomo≈õci.');
          return;
        }
      }

      let convId = getCurrentId();
      if (!convId) {
        convId = await newConversation(role === 'user' ? text.slice(0, 40) : 'New conversation');
      }
      if (!convId) return;

      // Insert wiadomo≈õci do Supabase
      const { error: insErr } = await window.supabaseClient
        .from('chat_messages')
        .insert({
          conversation_id: convId,
          user_id: USER_ID,
          role,
          content: text
        });
      if (insErr){ console.warn('insert msg error:', insErr); }

      // Ustaw tytu≈Ç przy pierwszej wiadomo≈õci usera (gdy title jest NULL)
      if (role === 'user'){
        await window.supabaseClient
          .from('chat_conversations')
          .update({ title: text.slice(0,40) })
          .eq('id', convId)
          .eq('user_id', USER_ID)
          .is('title', null);
      }

      // Bump updated_at dla sortowania listy
      await window.supabaseClient
        .from('chat_conversations')
        .update({ updated_at: new Date().toISOString() })
        .eq('id', convId)
        .eq('user_id', USER_ID);

      // Od≈õwie≈º sidebar (zachowaj zaznaczenie)
      await renderServerHistory(convId);
    })();
  }
}

        input.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' && !e.shiftKey){
        e.preventDefault();
        if (isStreaming) return; // blokada wysy≈Çki podczas generowania
        send.click();
      }
    });

        send.onclick = async () => {
      // tryb STOP: przerwij generowanie
      if (isStreaming && abortController){
        try { abortController.abort(); } catch {}
        return;
      }

      // --- Prompt Injection Sanitizer ---
function sanitizePrompt(p) {
  const blockedPatterns = [
    /ignore previous/gi,
    /disregard previous/gi,
    /system:/gi,
    /assistant:/gi,
    /jailbreak/gi,
    /show.*key/gi,
    /print.*secret/gi,
    /reveal.*data/gi,
    /delete.*data/gi,
    /give me.*password/gi
  ];
  let safe = p;
  blockedPatterns.forEach(r => { safe = safe.replace(r, '[blocked]'); });
  return safe;
}
const q = sanitizePrompt(input.value.trim());

      if (!q) return;
      addMsg(q, "user");
      input.value = "";
      updateSendDisabled();

      const st = document.getElementById("backendStatus");
      if (st) st.textContent = "Backend: connecting‚Ä¶";
      setBusyUI();

            try {
        if (abortController) {
          try { abortController.abort(); } catch {}
        }
        abortController = new AbortController();

  // --- Minimalne pobranie kontekstu RAG (bez heurystyk, bez kreatywno≈õci, bez internetu) ---
const API_BASE = "https://ai.beawarely.com";
const RAG_SEARCH = `${API_BASE}/api/rag/search`;
let enrichedPrompt = q;

try {
  const ragRes = await fetch(`${RAG_SEARCH}?q=${encodeURIComponent(q)}`, {
    method: "GET",
    headers: { "Accept": "application/json" }
  });

  if (ragRes.ok) {
    const ragData = await ragRes.json();
    if (ragData?.context && ragData.context.trim().length > 0) {
      enrichedPrompt = `${q}\n\n${ragData.context}`;
      console.log("üìö RAG context used");
    } else {
      console.log("üìö RAG empty ‚Äî using raw prompt");
    }
  } else {
    console.warn("‚ö†Ô∏è RAG HTTP error:", ragRes.status);
  }
} catch (e) {
  console.warn("‚ö†Ô∏è RAG fetch error:", e);
}
// === W≈Ça≈õciwe zapytanie do AI (Ollama/BeAwarely Core) ===
// Zbuduj kontekst z ostatnich 10 wiadomo≈õci (AI + user)
const allMsgs = Array.from(document.querySelectorAll('.msg'))
  .slice(-6)
  .map(m => (m.classList.contains('user') ? 'User: ' : 'Assistant: ') + m.textContent)
  .join('\n');

        const resp = await fetch("https://ai.beawarely.com/api/generate", {

  method: "POST",
  headers: { "Content-Type": "application/json" },
  signal: abortController.signal,
    body: JSON.stringify({
    model: localStorage.getItem('ba_model_id') || "freerainboxbox/phi4:14b-q6_K",
    prompt: (() => {
      const m = localStorage.getItem('ba_model_id') || "freerainboxbox/phi4:14b-q6_K";
      if (m.startsWith("mixtral")) {
        return `You are MattThinker ‚Äî the analytical, calm, and insightful AI of BeAwarely.
BeAwarely is an experimental AI-powered awareness platform created by Mateusz. It combines AI chat, a knowledge tree, work verification tools and social features to help users better understand themselves, others and the world.
You live inside BeAwarely and you can talk about it as "our platform" or "this BeAwarely app" when it makes sense.

Always answer in English unless the user clearly writes in another language.
Your style is thoughtful, structured, and intelligent without sounding robotic or overly formal.

If a RAG context is provided, use it as your main source of factual grounding.
Do not reference RAG, context, sources, documents, or retrieval in your response.
Integrate the information naturally into your explanation.

If no context is available, rely on your own reasoning and general knowledge.
You may write longer explanations, but avoid rambling.
Focus on clarity, reasoning, and teaching the user how things work.

If the user asks "What is BeAwarely?" explain it as the AI-driven awareness platform you live in, with modules like AI Chat, Knowledge Tree and WorkVerify, focused on personal growth, reflection and experimenting with AI.

${allMsgs}
User: ${enrichedPrompt}
MattThinker:`;

      }
      return `You are MattFast ‚Äî the fast, precise, and minimalistic assistant of BeAwarely.
BeAwarely is an experimental AI-powered awareness platform created by Mateusz, with modules like AI Chat, a knowledge tree and social tools to help people stay more aware of themselves, others and the world.
You live inside this BeAwarely app, so you can describe it briefly when users ask about it.

Always answer in English unless the user clearly writes in another language.
Keep your responses short, natural and to the point ‚Äî maximum 5 sentences.
Avoid bullet points, lists, enumerations or long structures.

If a RAG context is provided, treat it as the primary factual source.
Never mention RAG, documents, context, backend, retrieval or any internal mechanism.
Simply deliver the final answer as if you already knew the information.

If no context is provided, answer using your own general knowledge in the same concise style.

Do not repeat the user‚Äôs prompt.
Do not add closing remarks or unnecessary commentary.
Speak naturally, clearly and directly.

${allMsgs}
User: ${enrichedPrompt}
MattFast:`;
    })(),

        stream: true,
      options: (() => {

        const m = localStorage.getItem('ba_model_id') || "freerainboxbox/phi4:14b-q6_K";
        if (m.startsWith("mixtral")) {
          // === MattThinker (Mixtral Q6_K) ===
          return {
            temperature: 0.25,       
            top_p: 0.9,             
            num_predict: 512,       
            repeat_penalty: 1.2,    
          };
        }
        // === MattFast (qwen2.5) ===
        return {
          temperature: 0.5,         
          top_p: 0.8,               
          num_predict: 160,          
          repeat_penalty: 1.4,      
        };
      })(),
})
});

if (!resp.ok) throw new Error(`HTTP ${resp.status}`);

// --- STREAM RESPONSE poprawione ---
const reader = resp.body.getReader();
const decoder = new TextDecoder();
let buffer = "";
let fullText = "";

while (true) {
  const { done, value } = await reader.read();
  if (done) break;
  buffer += decoder.decode(value, { stream: true });
  const lines = buffer.split("\n");
  buffer = lines.pop(); // zostaje niedoko≈Ñczona linia
  for (const line of lines) {
    if (!line.trim()) continue;
    try {
      const obj = JSON.parse(line);
      if (obj.response) {
  fullText += obj.response;
  // je≈õli nie ma jeszcze aktywnego dymka AI ‚Äî utw√≥rz go raz
  if (!window._currentAIbubble) {
    const el = document.createElement("div");
    el.className = "msg ai";
    el.textContent = "";
    document.getElementById("chatMessages").appendChild(el);
    window._currentAIbubble = el;
  }
  // dopisuj kolejne tokeny do istniejƒÖcego bƒÖbelka
  window._currentAIbubble.textContent = fullText;
  window._currentAIbubble.scrollIntoView({ behavior: "smooth", block: "end" });
}

    } catch (e) {
      console.warn("Parse error:", e, line);
    }
  }
}
// po zako≈Ñczeniu ‚Äî usu≈Ñ tymczasowy bƒÖbelek (unikaj duplikatu)
if (window._currentAIbubble) {
  window._currentAIbubble.remove();
  window._currentAIbubble = null;
}

// zapisz pe≈ÇnƒÖ wiadomo≈õƒá AI do bazy tylko raz
if (fullText.trim()) {
  addMsg(fullText, "ai", true);
} else {
  addMsg("[no response]", "ai", true);
}

      } catch (err) {
        if (err?.name === 'AbortError'){
          addMsg("[stopped]", "ai");
          const st2 = document.getElementById("backendStatus");
          if (st2) st2.textContent = "Generation stopped";
        } else {
          console.error("Chat error:", err);
          addMsg("‚ö†Ô∏è Backend error, try again later.", "ai");
          const st2 = document.getElementById("backendStatus");
          if (st2) st2.textContent = "Backend: error";
        }
      } finally {
        abortController = null;
        setIdleUI();
      }
    };

    document.addEventListener('DOMContentLoaded', ()=>{ 
      if(msgs) msgs.scrollTop = msgs.scrollHeight; 
    });
  </script>


  <script>
  // --- Autogrow textarea + stabilne przewijanie --- //
  (function(){
    const input = document.getElementById('chatInput');
    const msgs  = document.getElementById('chatMessages');
    const send  = document.getElementById('sendBtn');

    if (!input || !msgs) return;

    function scrollToBottom(){
      // requestAnimationFrame = p≈Çynny scroll po DOM update
      requestAnimationFrame(()=>{ msgs.scrollTop = msgs.scrollHeight; });
    }

    function autoGrow(){
      input.style.height = 'auto';
      const max = 6 * 22; // ok. 6 linii (22px line-height)
      input.style.height = Math.min(input.scrollHeight, max) + 'px';
    }

    input.addEventListener('input', autoGrow);
    // pierwsze wyliczenie
    autoGrow();

    // po ka≈ºdych 300ms ‚Äì je≈õli co≈õ dosz≈Ço asynchronicznie, dociƒÖgnij d√≥≈Ç
    // (lekki ‚Äûwatcher‚Äù; mo≈ºesz usunƒÖƒá, je≈õli zbƒôdny)
    let prevCount = 0;
    setInterval(()=>{
      const count = msgs.children.length;
      if (count !== prevCount){
        prevCount = count;
        scrollToBottom();
      }
    }, 300);
  })();
</script>

</body>
</html>
