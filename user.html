<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Profil użytkownika – BeAwarely</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
  :root{
    --bg1:#0b1220;
    --bg2:#060912;
    --panel: rgba(20,24,38,.85);
    --card: rgba(18,22,35,.9);
    --text:#eaf2ff;
    --muted:#a7b4d9;
    --accent:#6aa8ff;
    --accent-strong:#3f86ff;
    --border:rgba(122,149,202,.18);
    --shadow: 0 10px 30px rgba(3,8,20,.45), inset 0 1px 0 rgba(255,255,255,.04);
  }

  *{box-sizing:border-box}

  body{
    font-family:'Segoe UI',system-ui,-apple-system,Roboto,Arial,sans-serif;
    margin:0;
    padding:64px 16px 100px;
    min-height:100vh;
    color:var(--text);
    background:
      radial-gradient(1200px 600px at 20% -10%, rgba(88,130,255,.18), transparent 60%),
      radial-gradient(1000px 700px at 120% 0%, rgba(0,204,153,.10), transparent 55%),
      linear-gradient(180deg, var(--bg1), var(--bg2));
    display:flex;flex-direction:column;align-items:center;
  }

  .back-btn{
    position:fixed;top:14px;left:14px;z-index:10;
    background:linear-gradient(180deg, var(--accent), var(--accent-strong));
    color:#fff;border:0;border-radius:10px;padding:10px 14px;font-size:.95rem;cursor:pointer;
    box-shadow:0 6px 18px rgba(63,134,255,.35);
    transition:transform .15s ease, box-shadow .2s ease, filter .2s ease;
  }
  .back-btn:hover{ transform:translateY(-1px); filter:saturate(1.08); box-shadow:0 10px 24px rgba(63,134,255,.4) }

  .profile-box{
    width:100%;
    max-width:760px;
    margin-top:80px;
    text-align:center;
    background:linear-gradient(180deg, rgba(18,22,35,.92), rgba(14,18,30,.86));
    border:1px solid var(--border);
    border-radius:18px;
    padding:40px 28px 36px;
    box-shadow: var(--shadow);
    backdrop-filter: blur(6px);
  }

  .profile-pic{
  width:132px;
  height:132px;
  border-radius:50%;
  object-fit:cover;
  margin-bottom:12px;
  display:inline-block;
  border:2px solid rgba(255,255,255,.08);
  box-shadow:0 10px 28px rgba(0,0,0,.55), 0 0 0 6px rgba(84,132,255,.12);
  transition:transform .18s ease, box-shadow .25s ease;
}
.profile-pic:hover{
  transform:translateY(-2px);
  box-shadow:0 14px 34px rgba(0,0,0,.6), 0 0 0 8px rgba(84,132,255,.16);
}

  h2{font-size:2rem;margin:10px 0 4px}
  .username{color:var(--muted);font-size:.95rem;margin-bottom:18px}

  .friend-btn{
    appearance:none;border:0;border-radius:12px;min-width:160px;
    padding:11px 18px;cursor:pointer;font-size:.95rem;
    color:#fff;background:linear-gradient(180deg, #8ab6ff, #3f86ff);
    box-shadow:0 10px 22px rgba(63,134,255,.32), inset 0 1px 0 rgba(255,255,255,.2);
    transition:transform .12s ease, box-shadow .2s ease;
  }
  .friend-btn:hover{transform:translateY(-1px);box-shadow:0 14px 28px rgba(63,134,255,.38)}
  .friend-btn:disabled{opacity:.6;cursor:default}

  .posts{
    margin-top:28px;
    display:flex;flex-direction:column;gap:12px;text-align:left;
  }

  .post{
    background:var(--card);border:1px solid var(--border);border-radius:12px;
    padding:14px 16px;
    box-shadow:inset 0 0 0 1px rgba(255,255,255,.02), 0 8px 18px rgba(0,0,0,.25);
  }

  .post time{
    display:block;font-size:.82rem;color:var(--muted);margin-top:4px;
  }
  </style>
</head>

<body>
  <button class="back-btn" onclick="window.location.href='index.html'">← Powrót do strony głównej</button>

  <div class="profile-box">
    <img id="avatar" src="" alt="Avatar" class="profile-pic" />
    <h2 id="fullname">User</h2>
    <div id="username" class="username">@user</div>
    <button id="friend-btn" class="friend-btn" style="display:none;">Dodaj do znajomych</button>

    <div class="posts" id="posts"></div>
  </div>

  <script>
  const SUPABASE_URL = "https://xzwpqyomqjzmiqsszwkg.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh6d3BxeW9tcWp6bWlxc3N6d2tnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0MjIxMTYsImV4cCI6MjA2OTk5ODExNn0.QbjDO1xifFkDuIAZZ9WHfGomgxwhanP9BQtgMrFqDgg";
  const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  document.addEventListener("DOMContentLoaded", async () => {
    const { data } = await supabaseClient.auth.getUser();
    const currentUser = data?.user || null;
    const viewedId = new URLSearchParams(location.search).get("id");

    if (!viewedId) return;

    if (currentUser && viewedId === currentUser.id) {
      location.href = "profile.html";
      return;
    }

    const { data: profile } = await supabaseClient
      .from("profiles")
      .select("*")
      .eq("id", viewedId)
      .maybeSingle();

    if (!profile) {
      document.getElementById("fullname").textContent = "Nie znaleziono użytkownika";
      document.getElementById("username").textContent = "";
      return;
    }

    document.getElementById("fullname").textContent =
      (profile.first_name || "") + " " + (profile.last_name || "");
    document.getElementById("username").textContent = "@" + (profile.username || "user");
    let avatar = profile.avatar_url;
if (avatar) {
  if (!avatar.startsWith("https")) {
    avatar = `${SUPABASE_URL}/storage/v1/object/public${avatar.startsWith('/') ? '' : '/'}${avatar}`;
  }
  document.getElementById("avatar").src = avatar;
} else {
  document.getElementById("avatar").src = "img/avatar-default.png";
}
    // Relacja znajomości
const { data: rel } = await supabaseClient
  .from("friendships")
  .select("*")
  .or(`and(requester_id.eq.${currentUser.id},addressee_id.eq.${viewedId}),and(requester_id.eq.${viewedId},addressee_id.eq.${currentUser.id})`)
  .maybeSingle();

const btn = document.getElementById("friend-btn");
btn.style.display = "inline-block";

if (!rel) {
  btn.textContent = "Dodaj do znajomych";
  btn.onclick = async () => {
    btn.disabled = true;
    const { error } = await supabaseClient.from("friendships").insert({
      requester_id: currentUser.id,
      addressee_id: viewedId,
      status: "pending"
    });
    if (error) {
      btn.textContent = "Błąd";
      console.warn(error.message);
    } else {
      btn.textContent = "Wysłano zaproszenie";
    }
  };
} else if (rel.status === "pending") {
  if (rel.addressee_id === currentUser.id) {
    btn.textContent = "Akceptuj zaproszenie";
    btn.onclick = async () => {
      const { error } = await supabaseClient
        .from("friendships")
        .update({ status: "accepted" })
        .eq("id", rel.id);
      if (error) {
        btn.textContent = "Błąd";
      } else {
        btn.textContent = "Znajomi";
        btn.disabled = true;
      }
    };
  } else {
    btn.textContent = "Wysłano zaproszenie";
    btn.disabled = true;
  }
} else if (rel.status === "accepted") {
  btn.textContent = "Znajomi";
  btn.disabled = true;
}

    const { data: posts } = await supabaseClient
      .from("user_posts")
      .select("*")
      .eq("author_id", viewedId)
      .order("created_at", { ascending: false });

    const list = document.getElementById("posts");
    if (!posts?.length) {
      list.innerHTML = "<div style='opacity:.6;'>Brak postów</div>";
      return;
    }

    for (const p of posts) {
  const visible =
    p.visibility === "public" ||
    (p.visibility === "friends" && rel?.status === "accepted") ||
    viewedId === currentUser.id;

  if (!visible) continue;

  const div = document.createElement("div");
  div.className = "post";
  div.innerHTML = `<div>${p.content}</div><time>${new Date(p.created_at).toLocaleString()}</time>`;
  list.appendChild(div);
}
  });
  </script>
</body>
</html>
