<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Profile ‚Äì BeAwarely</title>
  <link rel="stylesheet" href="css/style.css"/>
  <style>
:root{
  --bg1:#0b1220;
  --bg2:#060912;
  --panel: rgba(20,24,38,.85);
  --card: rgba(18,22,35,.9);
  --text:#eaf2ff;
  --muted:#a7b4d9;
  --accent:#6aa8ff;
  --accent-strong:#3f86ff;
  --border:rgba(122,149,202,.18);
  --shadow: 0 10px 30px rgba(3,8,20,.45), inset 0 1px 0 rgba(255,255,255,.04);
}

*{box-sizing:border-box}
body{
  font-family:'Segoe UI',system-ui,-apple-system,Roboto,Arial,sans-serif;
  margin:0;
  padding:56px 16px 80px;
  min-height:100vh;
  color:var(--text);
  text-align:center;
  background:
    radial-gradient(1200px 600px at 20% -10%, rgba(88,130,255,.18), transparent 60%),
    radial-gradient(1000px 700px at 120% 0%, rgba(0,204,153,.10), transparent 55%),
    linear-gradient(180deg, var(--bg1), var(--bg2));
}

.profile-box{
  max-width:760px;margin:68px auto 0;
  background:linear-gradient(180deg, rgba(18,22,35,.92), rgba(14,18,30,.86));
  border:1px solid var(--border);
  border-radius:18px;padding:32px 26px;
  box-shadow: var(--shadow);
  backdrop-filter: blur(6px);
  text-align:center;
}

.profile-pic{
  width:132px;height:132px;border-radius:50%;object-fit:cover;
  border:2px solid rgba(255,255,255,.08);
  box-shadow:0 10px 28px rgba(0,0,0,.55), 0 0 0 6px rgba(84,132,255,.12);
}
h2{font-size:2rem;margin:12px 0 6px}
.username{color:var(--muted);font-size:.95rem;margin-bottom:12px}
.friend-btn{
  appearance:none;border:0;border-radius:12px;min-width:140px;
  padding:10px 18px;cursor:pointer;font-size:.95rem;
  color:#0b1020;background:linear-gradient(180deg, #8ab6ff, #3f86ff);color:white;
  box-shadow:0 10px 22px rgba(63,134,255,.32), inset 0 1px 0 rgba(255,255,255,.2);
}
.friend-btn:disabled{opacity:.6;cursor:default}
.posts{margin-top:24px;display:flex;flex-direction:column;gap:12px;text-align:left}
.post{
  background:var(--card);border:1px solid var(--border);border-radius:12px;
  padding:12px 14px;box-shadow:inset 0 0 0 1px rgba(255,255,255,.02),
  0 8px 18px rgba(0,0,0,.25)
}
</style>
</head>
<body>
  <div class="profile-box">
  <img id="avatar" src="" alt="Avatar" class="profile-pic" />
  <h2 id="fullname">User</h2>
  <div id="username" class="username">@user</div>
  <button id="friend-btn" class="friend-btn" style="display:none;">Dodaj do znajomych</button>

  <div class="posts" id="posts"></div>
</div>

    <!-- Supabase init -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.44.4/dist/umd/supabase.min.js"></script>
  <script>
    const SUPABASE_URL = "https://xzwpqyomqjzmiqsszwkg.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh6d3BxeW9tcWp6bWlxc3N6d2tnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0MjIxMTYsImV4cCI6MjA2OTk5ODExNn0.QbjDO1xifFkDuIAZZ9WHfGomgxwhanP9BQtgMrFqDgg";
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    document.addEventListener("DOMContentLoaded", async () => {
      let { data, error } = await supabaseClient.auth.getUser();
let user = data?.user || null;

// Pobierz ID z URL
const params = new URLSearchParams(location.search);
const viewedId = params.get("id");

// Je≈õli brak parametru ‚Äì tylko komunikat, bez przekierowania
if (!viewedId) {
  document.getElementById("fullname").textContent = "Nie znaleziono u≈ºytkownika";
  document.getElementById("username").textContent = "";
  document.getElementById("friend-btn").style.display = "none";
  return;
}

// üö´ Zostawiamy tylko blokadƒô wej≈õcia na w≈Çasny profil
if (user && viewedId === user.id) {
  window.location.href = "profile.html";
  return;
}

      // fetch profile data
      const { data: profile, error: profErr } = await supabaseClient
        .from("profiles")
        .select("*")
        .eq("id", viewedId)
        .maybeSingle();

      if (profErr || !profile) {
        console.warn("Profil nie znaleziony:", profErr?.message || "brak danych");
        document.getElementById("fullname").textContent = "Nie znaleziono u≈ºytkownika";
        document.getElementById("username").textContent = "";
        document.getElementById("friend-btn").style.display = "none";
        return;
      }

      document.getElementById("fullname").textContent = (profile.first_name || "") + " " + (profile.last_name || "");
      document.getElementById("username").textContent = "@" + (profile.username || "");
      if (profile.avatar_url) {
  let avatar = profile.avatar_url;
  if (!avatar.startsWith("https")) {
    avatar = `${SUPABASE_URL}/storage/v1/object/public${avatar.startsWith('/') ? '' : '/'}${avatar}`;
  }
  document.getElementById("avatar").src = avatar;
}
      // friendship status
      const { data: rel } = await supabaseClient
        .from("friendships")
        .select("*")
        .or(`and(requester_id.eq.${user.id},addressee_id.eq.${viewedId}),and(requester_id.eq.${viewedId},addressee_id.eq.${user.id})`)
        .maybeSingle();

      const btn = document.getElementById("friend-btn");
      btn.style.display = "inline-block";

      if (!rel) {
        btn.textContent = "Dodaj do znajomych";
        btn.onclick = async () => {
          btn.disabled = true;
          await supabaseClient.from("friendships").insert({
            requester_id: user.id,
            addressee_id: viewedId,
            status: "pending"
          });
          btn.textContent = "Wys≈Çano zaproszenie";
        };
      } else if (rel.status === "pending") {
        if (rel.addressee_id === user.id) {
          btn.textContent = "Akceptuj zaproszenie";
          btn.onclick = async () => {
            await supabaseClient.from("friendships").update({ status: "accepted" }).eq("id", rel.id);
            btn.textContent = "Znajomi";
            btn.disabled = true;
          };
        } else {
          btn.textContent = "Wys≈Çano zaproszenie";
          btn.disabled = true;
        }
      } else if (rel.status === "accepted") {
        btn.textContent = "Znajomi";
        btn.disabled = true;
            } else if (rel.status === "rejected") {
        btn.textContent = "Dodaj do znajomych";
        btn.disabled = false;
        btn.onclick = async () => {
          btn.disabled = true;
          await supabaseClient.from("friendships").insert({
            requester_id: user.id,
            addressee_id: viewedId,
            status: "pending"
          });
          btn.textContent = "Wys≈Çano zaproszenie";
        };
      }

      // load posts
      const { data: posts } = await supabaseClient
        .from("user_posts")
        .select("*")
        .eq("author_id", viewedId)
        .order("created_at", { ascending: false });

      const list = document.getElementById("posts");
      if (!posts?.length) {
        list.innerHTML = "<div style='opacity:.6;'>Brak post√≥w</div>";
      } else {
        for (const p of posts) {
          if (p.visibility === "public" || (p.visibility === "friends" && rel?.status === "accepted") || viewedId === user.id) {
            const div = document.createElement("div");
            div.className = "post";
            div.textContent = p.content;
            list.appendChild(div);
          }
        }
      }
    });
  </script>
</body>
</html>
