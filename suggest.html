<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="robots" content="noindex, nofollow"/>
  <title>Suggest a Tool ‚Äî BeAwarely</title>
  <link rel="stylesheet" href="css/style.css"/>
    <style>
  /* Theme tokens ‚Äî Dark default (matches BeAwarely), Light via .light on <html> */
  :root{
    /* dark */
    --bg:#0b0d14;
    --panel:#121625;
    --surface:#0f1424;
    --text:#eaf0ff;
    --muted:#b9c2e6;
    --accent:#5aa8ff;
    --accent-2:#9ad0ff;
    --ring:rgba(90,168,255,.45);
    --border:rgba(234,240,255,.14);
    --bg-gradient: linear-gradient(180deg, #060b14 0%, #133e86 100%);
    
    --shadow:0 4px 12px rgba(0,0,0,.4);
  }
  /* light overrides */
  .light{
    --bg:#f6f8ff;
    --panel:#ffffff;
    --surface:#f0f3ff;
    --text:#0c1222;
    --muted:#51608b;
    --accent:#0b67ff;
    --accent-2:#3fa0ff;
    --ring:rgba(11,103,255,.35);
    --border:rgba(12,18,34,.12);
    --bg-gradient: linear-gradient(180deg, #b5e0ff 0%, #ffffff 100%);
    
    --shadow:0 4px 12px rgba(0,0,0,.08);
  }

  body{
    margin:0;
    background: var(--bg-gradient);
    color:var(--text);
    font-family:'Segoe UI',sans-serif;
  }
  a{color:var(--accent);text-decoration:none}

  /* Fix: prevent inputs from overflowing containers */
  *,*::before,*::after{ box-sizing:border-box }

  .container{max-width:900px;margin:0 auto;padding:40px}
  .back{display:inline-block;margin-bottom:16px;font-size:.9rem;color:var(--muted)}

  /* Hero header */
    .hero{
    display:flex;flex-direction:column;align-items:center;justify-content:center;
    gap:12px;margin-bottom:28px;text-align:center;padding:20px 0;
    background:transparent; /* nie wybiela t≈Ça ‚Äì widaƒá wyra≈∫nie dwukolor */
    border-radius:18px;
  }

  .hero h1{
    margin:0;font-size:3rem;letter-spacing:.4px;display:flex;align-items:center;gap:10px;
    background: linear-gradient(90deg, var(--accent), var(--accent-2));
    -webkit-background-clip:text;background-clip:text;color:transparent
  }
  .sub{color:var(--muted);margin:.25rem 0 0;font-size:1.1rem}
  .hero-controls{display:flex;gap:10px;align-items:center;margin-top:6px}
  .btn.ghost{background:transparent;border:1px solid var(--border);padding:8px 12px;border-radius:10px}
  .btn.ghost:hover{background:rgba(234,240,255,.06)}
  .btn.ghost:focus-visible{outline:2px solid var(--ring);outline-offset:2px}

  /* Stats */
  .stats{display:grid;grid-template-columns:repeat(3,minmax(140px,1fr));gap:18px;margin:22px 0 12px}
  .stat{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:18px;text-align:center;box-shadow:var(--shadow);transition:transform .2s}
  .stat:hover{transform:translateY(-3px)}
  .stat .k{font-size:1.6rem;font-weight:700;margin-bottom:4px}
  .stat .muted{font-size:.9rem}

  .stats{display:grid;grid-template-columns:repeat(3,minmax(140px,1fr));gap:14px;margin:18px 0 8px}
  .stat{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:12px;color:var(--text)}
  .stat .k{font-size:1.25rem;font-weight:600}

  .row{display:flex;gap:14px;flex-wrap:wrap;align-items:center}
  .grow{flex:1 1 280px}

    .seg{
    display:inline-flex;
    border:1px solid var(--border);
    border-radius:999px;
    padding:4px;
    background:var(--surface);
    box-shadow:var(--shadow);
  }
  .seg button{
    padding:8px 16px;
    background:transparent;
    border:0;
    border-radius:999px;
    color:var(--muted);
    cursor:pointer;
    font-weight:500;
    transition:background .2s,color .2s;
  }
  .seg button:hover{background:rgba(234,240,255,.08)}
  .seg button.active{
    background:linear-gradient(90deg, var(--accent), var(--accent-2));
    color:#fff;
  }
  .seg button:focus-visible{outline:2px solid var(--ring);outline-offset:2px}

    /* Inputs take full width including borders (no overflow) */
        .input{
    width:100%;
    box-sizing:border-box;
    display:block;
    padding:12px 14px;
    border-radius:12px;
    background:var(--surface);
    color:var(--text);
    border:1px solid var(--border);
    font-size:1rem;
  }

  .input::placeholder{color:color-mix(in oklab, var(--muted) 70%, transparent)}
  textarea.input{
    resize:vertical;
    min-height:120px;
  }

     #search{
    padding-left:38px; /* miejsce na ikonƒô */
    background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23b9c2e6' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001l3.85 3.85a1 1 0 0 0 1.415-1.415l-3.85-3.85zm-5.242.656a5 5 0 1 1 0-10 5 5 0 0 1 0 10z'/%3E%3C/svg%3E");
    background-repeat:no-repeat;
    background-position:12px center;
    background-size:16px;
  }
   
  /* Cards & form */
  .card{background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:20px;color:var(--text);box-shadow:var(--shadow)}
  #ideaForm::before{
    content:"Propose your idea ‚ú®";
    display:block;
    font-size:1.2rem;
    font-weight:600;
    margin-bottom:12px;
    color:var(--accent);
  }

  .ideas{display:flex;flex-direction:column;gap:14px;margin-top:16px}
  .idea{
    border:1px solid var(--border);
    border-radius:16px;
    padding:18px;
    background:var(--surface);
    color:var(--text);
    box-shadow:var(--shadow);
    transition:transform .2s, box-shadow .2s;
  }
  .idea:hover{transform:translateY(-4px);box-shadow:0 6px 18px rgba(0,0,0,.5)}
  .idea h3{margin:0 0 8px 0;font-size:1.2rem;display:flex;align-items:center;gap:6px}
  .idea h3::before{content:"üí°"}

  .muted{color:var(--muted)}
  .tags{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
  .tag{font-size:.8rem;border:1px solid var(--border);padding:2px 8px;border-radius:999px;color:var(--text)}

  .actions{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-top:14px}
  .btn{
    padding:9px 14px;
    border-radius:12px;
    border:1px solid var(--border);
    background:var(--surface);
    color:var(--text);
    cursor:pointer;
    transition:background .2s, transform .2s;
  }
  .btn:hover{background:color-mix(in oklab, var(--accent) 15%, var(--surface));transform:translateY(-1px)}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .btn:focus-visible{outline:2px solid var(--ring);outline-offset:2px}

  .vote{display:inline-flex;align-items:center;gap:8px}
  .vote .btn{font-weight:600}
  .vote .btn[aria-pressed="true"]{background:var(--accent);color:#fff;border-color:var(--accent)}

  .pill{padding:6px 10px;border-radius:999px;background:rgba(234,240,255,.08);border:1px solid var(--border);color:var(--text)}
  .empty{padding:20px;border:1px dashed var(--border);border-radius:16px;text-align:center;color:var(--muted)}
  .note{margin-top:12px;color:var(--muted)}
  .hide{display:none !important}

  /* Form actions */
  .form-actions{display:flex;justify-content:flex-end;align-items:center;gap:12px;margin-top:14px}
  .form-actions .btn{background:linear-gradient(90deg, var(--accent), var(--accent-2));color:#fff;border:none}
  .form-actions .btn:hover{opacity:.9}

  /* Smooth theme switch */
  .anim-theme *{ transition: color .25s, background-color .25s, border-color .25s }

  /* Idea highlight */
  .idea.highlight{ outline:2px solid var(--accent); box-shadow:0 0 0 6px color-mix(in oklab, var(--accent) 20%, transparent); }

</style>

</head>
<body>
  <div class="container">
    <a href="index.html" class="back">‚Üê Back to Home</a>

    <div class="hero">
      <h1>Suggest a Tool</h1>
      <p class="sub">Propose ideas, vote, and get updates.</p>
      <div class="hero-controls">
  <button id="themeToggle" class="btn ghost" type="button" aria-pressed="false" aria-label="Toggle theme">üåô</button>
</div>

    </div>

    <div class="stats">
      <div class="stat"><div class="k" id="statIdeas">0</div><div class="muted">Ideas</div></div>
      <div class="stat"><div class="k" id="statVotes">0</div><div class="muted">Votes</div></div>
      <div class="stat"><div class="k" id="statFollowers">0</div><div class="muted">Followers</div></div>
    </div>

    <!-- Sign-in prompt -->
    <div id="guestCard" class="card hide">
      <div class="row">
        <div class="grow">
          <div class="muted">Sign in to propose an idea and vote.</div>
        </div>
        <button id="signInBtn" class="btn" type="button">Sign in</button>
      </div>
    </div>

    <!-- Submit form -->
    <div id="userCard" class="card hide" aria-hidden="true">
      <form id="ideaForm">
        <div class="row" style="margin-bottom:12px">
          <input id="title" class="input grow" type="text" maxlength="80" placeholder="Title (max 80 chars)" required/>
          <input id="tags" class="input" type="text" placeholder="Tags (comma separated)"/>
        </div>
        <textarea id="details" class="input" rows="4" maxlength="500" placeholder="Describe the problem/use-case (max 500 chars)"></textarea>
        <div class="form-actions">
          <span id="formMsg" class="muted" aria-live="polite"></span>
          <button id="submitBtn" class="btn" type="submit">Submit idea</button>
        </div>
      </form>
    </div>

    <!-- List & controls -->
    <div class="card">
      <div class="row" style="justify-content:space-between;margin-bottom:var(--gap)">
        <input id="search" class="input grow" type="search" placeholder="Search ideas‚Ä¶"/>
        <div class="seg" role="tablist" aria-label="Sort">
          <button data-sort="top" class="active" role="tab" aria-selected="true">Top</button>
          <button data-sort="new" role="tab" aria-selected="false">New</button>
          <button data-sort="trending" role="tab" aria-selected="false">Trending</button>
        </div>
      </div>

      <div id="ideasWrap" class="ideas">
        <div class="empty muted" id="emptyState">Ideas will appear here soon.</div>
      </div>

      <p class="note" id="modeNote"></p>
    </div>
  </div>

      <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.44.4/dist/umd/supabase.min.js"></script>
  <script src="js/supabase-client.js"></script>

  <script>
    // ===== Setup / client detection =====
    let supabaseClient = window.supabaseClient || null;
    if (!supabaseClient && window.supabase && window.SUPABASE_URL && window.SUPABASE_ANON_KEY) {
      try { supabaseClient = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY); } catch(e) {}
    }

    const els = {
      guest: document.getElementById('guestCard'),
      user: document.getElementById('userCard'),
      signIn: document.getElementById('signInBtn'),
      form: document.getElementById('ideaForm'),
      submit: document.getElementById('submitBtn'),
      msg: document.getElementById('formMsg'),
      ideasWrap: document.getElementById('ideasWrap'),
      empty: document.getElementById('emptyState'),
      search: document.getElementById('search'),
      sortTabs: document.querySelectorAll('.seg button'),
      statIdeas: document.getElementById('statIdeas'),
      statVotes: document.getElementById('statVotes'),
      statFollowers: document.getElementById('statFollowers'),
      modeNote: document.getElementById('modeNote'),
      themeToggle: document.getElementById('themeToggle')
    };

    /* ===== LocalStorage helpers for demo vote/follow persistence ===== */
    const LS_VOTES = 'ba_votes';
    const LS_FOLLOWS = 'ba_follows';
    const readSet = (k)=>{ try{ return new Set(JSON.parse(localStorage.getItem(k)||'[]')); }catch(_){ return new Set(); } };
    const writeSet = (k,set)=>{ try{ localStorage.setItem(k, JSON.stringify([...set])); }catch(_){} };

    /* ===== Theme (Light/Dark with prefers-color-scheme + localStorage) ===== */
    const THEME_KEY = 'ba_theme';
    function getPreferredTheme(){
      try{
        const saved = localStorage.getItem(THEME_KEY);
        if (saved === 'light' || saved === 'dark') return saved;
      }catch(_){}
      return (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) ? 'light' : 'dark';
    }
        function applyTheme(t){
      // brief animation class for smooth change
      document.documentElement.classList.add('anim-theme');
      document.documentElement.classList.toggle('light', t === 'light');
      if (els.themeToggle){
        els.themeToggle.setAttribute('aria-pressed', String(t === 'light'));
        els.themeToggle.textContent = (t === 'light') ? 'üåû' : 'üåô';
        els.themeToggle.title = (t === 'light') ? 'Switch to dark' : 'Switch to light';
      }
      setTimeout(()=>document.documentElement.classList.remove('anim-theme'), 280);
    }

    let currentTheme = getPreferredTheme();
    applyTheme(currentTheme);
    els.themeToggle?.addEventListener('click', ()=>{
      currentTheme = (currentTheme === 'light') ? 'dark' : 'light';
      try{ localStorage.setItem(THEME_KEY, currentTheme); }catch(_){}
      applyTheme(currentTheme);
    });
    function show(el){ el.classList.remove('hide'); el.setAttribute('aria-hidden','false'); }
    function hide(el){ el.classList.add('hide'); el.setAttribute('aria-hidden','true'); }

    function gotoLogin(){
      try { localStorage.setItem('ba_redirect','suggest.html'); } catch(_) {}
      location.href = 'index.html?login=1';
    }
    els.signIn.addEventListener('click', gotoLogin);

    // ===== Rendering =====
    function renderStats(list){
      els.statIdeas.textContent = list.length.toString();
      els.statVotes.textContent = list.reduce((a,i)=>a+(i.votes||0),0);
      els.statFollowers.textContent = list.reduce((a,i)=>a+(i.followers||0),0);
    }

        function ideaItem(i, loggedIn){
      const voted = readSet(LS_VOTES);
      const followed = readSet(LS_FOLLOWS);

      const li = document.createElement('div');
      li.className = 'idea';
      li.id = i.id;

      const isVoted = voted.has(i.id);
      const voteCount = (i.votes||0) + (isVoted ? 1 : 0);

      const isFollow = followed.has(i.id);

      li.innerHTML = `
        <h3>${escapeHtml(i.title)}</h3>
        ${i.details ? `<div class="muted">${escapeHtml(i.details)}</div>` : ''}
        <div class="tags">${(i.tags||[]).map(t=>`<span class="tag">#${escapeHtml(t)}</span>`).join('')}</div>
        <div class="actions">
          <div class="vote">
            <button class="btn voteBtn" ${loggedIn?'':'disabled'} aria-pressed="${isVoted?'true':'false'}">‚ñ≤ Vote</button>
            <span class="muted count">${voteCount}</span>
          </div>
          <div class="row" style="gap:8px">
            <button class="btn followBtn" ${loggedIn?'':'disabled'} aria-pressed="${isFollow?'true':'false'}">${isFollow?'Following':'Follow'}</button>
            <button class="btn shareBtn" type="button" aria-label="Copy link">Share</button>
          </div>
        </div>
      `;

      const voteBtn = li.querySelector('.voteBtn');
      const countEl = li.querySelector('.count');
      voteBtn?.addEventListener('click', ()=>{
        if (!loggedIn) return;
        const pressed = voteBtn.getAttribute('aria-pressed') === 'true';
        if (pressed){ voted.delete(i.id); } else { voted.add(i.id); }
        writeSet(LS_VOTES, voted);
        voteBtn.setAttribute('aria-pressed', String(!pressed));
        const delta = pressed ? -1 : 1;
        const val = Math.max(0, (parseInt(countEl.textContent||'0',10)+delta));
        countEl.textContent = String(val);
      });

      const followBtn = li.querySelector('.followBtn');
      followBtn?.addEventListener('click', ()=>{
        if (!loggedIn) return;
        const pressed = followBtn.getAttribute('aria-pressed') === 'true';
        if (pressed){ followed.delete(i.id); } else { followed.add(i.id); }
        writeSet(LS_FOLLOWS, followed);
        followBtn.setAttribute('aria-pressed', String(!pressed));
        followBtn.textContent = pressed ? 'Follow' : 'Following';
      });

      const shareBtn = li.querySelector('.shareBtn');
      shareBtn?.addEventListener('click', async ()=>{
        const url = new URL(location.href);
        url.searchParams.set('id', i.id);
        try{
          await navigator.clipboard.writeText(url.toString());
          shareBtn.textContent = 'Copied!';
          setTimeout(()=>shareBtn.textContent='Share', 1000);
        }catch(_){
          location.hash = i.id; // fallback
        }
      });

      return li;
    }


    function renderIdeas(list, loggedIn){
      els.ideasWrap.innerHTML = '';
      if(!list.length){ show(els.empty); return; }
      hide(els.empty);
      list.forEach(i => els.ideasWrap.appendChild(ideaItem(i, loggedIn)));
      renderStats(list);
    }

    function escapeHtml(s){ return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    // ===== Sorting & Search (front-only) =====
    let currentSort = 'top';
    let baseIdeas = [];

    els.sortTabs.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        els.sortTabs.forEach(b=>{b.classList.remove('active'); b.setAttribute('aria-selected','false');});
        btn.classList.add('active'); btn.setAttribute('aria-selected','true');
        currentSort = btn.dataset.sort;
        updateURLState();
        applyFilters();
      });
    });
    els.search.addEventListener('input', ()=>{ updateURLState(); applyFilters(); });

    // "/" focuses search
    window.addEventListener('keydown', (e)=>{
      if (e.key === '/' && document.activeElement && !/^(input|textarea)$/i.test(document.activeElement.tagName)){
        e.preventDefault(); els.search.focus();
      }
    });

    function updateURLState(){
      const url = new URL(location.href);
      const q = els.search.value.trim();
      if (q) url.searchParams.set('q', q); else url.searchParams.delete('q');
      url.searchParams.set('sort', currentSort);
      history.replaceState(null, '', url.toString());
    }

        function applyFilters(){
      const q = els.search.value.trim().toLowerCase();
      let data = [...baseIdeas];
      if(q){
        data = data.filter(i => (i.title+i.details+(i.tags||[]).join(' ')).toLowerCase().includes(q));
      }
      if(currentSort==='new') data.sort((a,b)=>b.created_at - a.created_at);
      else if(currentSort==='trending') data.sort((a,b)=>(b.votes/(Date.now()-b.created_at+1)) - (a.votes/(Date.now()-a.created_at+1)));
      else data.sort((a,b)=>b.votes - a.votes); // top
      renderIdeas(data, state.loggedIn);

      // highlight deep-linked idea (?id=...)
      const url = new URL(location.href);
      const targetId = url.searchParams.get('id');
      if (targetId){
        const el = document.getElementById(targetId);
        if (el){
          el.classList.add('highlight');
          el.scrollIntoView({behavior:'smooth', block:'center'});
          setTimeout(()=>el.classList.remove('highlight'), 1400);
        }
      }
    }


    // ===== State & Init =====
    const state = { loggedIn:false, demo:true };

    async function init(){
      // read URL state
      const url = new URL(location.href);
      const qParam = url.searchParams.get('q') || '';
      const sortParam = url.searchParams.get('sort');
      if (qParam) els.search.value = qParam;
      if (sortParam && ['top','new','trending'].includes(sortParam)){
        currentSort = sortParam;
        els.sortTabs.forEach(b=>{
          b.classList.toggle('active', b.dataset.sort===currentSort);
          b.setAttribute('aria-selected', b.dataset.sort===currentSort ? 'true':'false');
        });
      }

      if (!supabaseClient) {
        state.demo = true;
        els.modeNote.textContent = 'Note: Backend not connected yet. This is an interactive demo preview.';
        show(els.guest); hide(els.user);
        applyFilters();
        return;
      }

      try {
        const { data:{ session } } = await supabaseClient.auth.getSession();
        state.loggedIn = !!session;
        state.demo = false;
        els.modeNote.textContent = state.loggedIn
          ? 'You can propose ideas and vote.'
          : 'Sign in to propose ideas and vote.';
        if(state.loggedIn){
  hide(els.guest); show(els.user);
} else {
  // üîí Redirect if user not logged in (direct access protection)
  window.location.href = "index.html";
  return;
}

        // Pobierz zaakceptowane pomys≈Çy z Supabase
const { data, error } = await supabaseClient
  .from('tool_ideas')
  .select('id, title, details, tags, author, created_at')
  .eq('status','approved')
  .order('created_at',{ ascending:false });

if (error) {
  console.error('Error loading ideas:', error);
  els.modeNote.textContent = 'Could not load ideas from backend.';
  baseIdeas = [];
} else {
  baseIdeas = data || [];
}
applyFilters();

      } catch (e) {
        state.demo = true;
        els.modeNote.textContent = 'Could not connect to backend. Showing demo.';
        show(els.guest); hide(els.user);
        applyFilters();
      }
    }

    // Submit (backend)
els.form?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  if (!supabaseClient) { els.msg.textContent = 'Backend not configured yet.'; return; }
  els.submit.disabled = true; els.msg.textContent = 'Saving‚Ä¶';
  try {
    const { data:{ session } } = await supabaseClient.auth.getSession();
    if(!session){ els.msg.textContent='Please sign in first.'; els.submit.disabled=false; return; }

    const payload = {
      title: document.getElementById('title').value.trim(),
      details: document.getElementById('details').value.trim(),
      tags: (document.getElementById('tags').value||'').split(/[\s,]+/).map(t=>t.trim()).filter(Boolean),
      author: session.user.id, // FK -> profiles.id
      status: 'pending'
    };

    const { data: inserted, error } = await supabaseClient
  .from('tool_ideas')
  .insert(payload)
  .select('id, title')
  .maybeSingle();

    if (error) {
      els.msg.textContent = 'Save error: ' + (error.message || error);
    } else {
      // üîπ Rejestruj aktywno≈õƒá w globalnym feedzie
try {
  const { data: { session } } = await supabaseClient.auth.getSession();
  if (session?.user?.id && inserted?.id) {
    await supabaseClient.from('activity_events').insert({
      actor_id: session.user.id,
      verb: 'suggested',
      subject_type: 'tool_idea',
      summary: `Suggested a new tool: "${inserted.title || payload.title || 'Unnamed idea'}"`
    });
  } else {
    console.warn('Skipped activity_events insert ‚Äî missing user or idea ID.');
  }
} catch (e) {
  console.warn('activity_events insert failed', e);
}

      els.msg.textContent = 'Idea submitted!'; 
      els.form.reset();
      if (typeof applyFilters === 'function') applyFilters();
    }
  } catch(err){
    els.msg.textContent = 'Error: '+(err?.message||'unknown');
  } finally {
    els.submit.disabled = false;
  }
});

    init();
  </script>
</body>
</html>
