<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="robots" content="noindex, nofollow"/>
  <title>Suggest a Tool ‚Äî BeAwarely</title>
  <link rel="stylesheet" href="css/style.css"/>
    <style>
  /* Suggest a Tool ‚Äî Idea Lab (distinct look vs the rest of BeAwarely) */

  :root{
    --gap:14px;

    /* dark */
    --bg0:#050717;
    --bg1:#0b1233;
    --text:#eaf2ff;
    --muted:rgba(234,242,255,.72);

    --accent:#7c5cff;   /* violet */
    --accent2:#37d6ff;  /* cyan */
    --accent3:#54ffa3;  /* mint */

    --panel:rgba(255,255,255,.06);
    --surface:rgba(10,14,34,.55);
    --border:rgba(234,242,255,.14);
    --ring:rgba(55,214,255,.42);

    --shadow:0 18px 60px rgba(0,0,0,.45);
    --shadow2:0 10px 26px rgba(0,0,0,.28);

    --r:18px;
    --r2:24px;
  }

  html.light{
    --bg0:#f7f8ff;
    --bg1:#e9edff;
    --text:#0b1020;
    --muted:rgba(11,16,32,.62);

    --accent:#5b2cff;
    --accent2:#0077ff;
    --accent3:#00b86a;

    --panel:rgba(255,255,255,.78);
    --surface:rgba(255,255,255,.62);
    --border:rgba(11,16,32,.12);
    --ring:rgba(0,119,255,.28);

    --shadow:0 18px 60px rgba(12,18,34,.14);
    --shadow2:0 10px 26px rgba(12,18,34,.10);
  }

  *,*::before,*::after{ box-sizing:border-box; }

  body{
    margin:0;
    min-height:100vh;
    font-family:ui-sans-serif, system-ui, "Segoe UI", Arial, sans-serif;
    color:var(--text);
    background:
      radial-gradient(900px 520px at 18% 10%, color-mix(in oklab, var(--accent2) 28%, transparent), transparent 60%),
      radial-gradient(820px 520px at 90% 18%, color-mix(in oklab, var(--accent) 26%, transparent), transparent 62%),
      radial-gradient(900px 620px at 50% 120%, color-mix(in oklab, var(--accent3) 18%, transparent), transparent 60%),
      linear-gradient(180deg, var(--bg0), var(--bg1));
    background-attachment:fixed;
    overflow-x:hidden;
  }

  /* grid + haze */
  body::before{
    content:"";
    position:fixed; inset:0;
    pointer-events:none;
    opacity:.22;
    background:
      repeating-linear-gradient(0deg, rgba(255,255,255,.08) 0 1px, transparent 1px 28px),
      repeating-linear-gradient(90deg, rgba(255,255,255,.06) 0 1px, transparent 1px 32px);
    mix-blend-mode:overlay;
  }

  /* slow moving aurora sheet */
  body::after{
    content:"";
    position:fixed; inset:-20%;
    pointer-events:none;
    opacity:.35;
    filter: blur(18px) saturate(135%);
    background:
      conic-gradient(from 210deg at 40% 40%,
        transparent 0 18%,
        color-mix(in oklab, var(--accent2) 55%, transparent) 18% 30%,
        transparent 30% 52%,
        color-mix(in oklab, var(--accent) 55%, transparent) 52% 64%,
        transparent 64% 78%,
        color-mix(in oklab, var(--accent3) 45%, transparent) 78% 92%,
        transparent 92% 100%);
    animation: labAurora 18s ease-in-out infinite alternate;
    transform: rotate(6deg);
  }

  @keyframes labAurora{
    0%{ transform: translate3d(-2%, -2%, 0) rotate(4deg) scale(1.02); }
    100%{ transform: translate3d(2%, 1%, 0) rotate(10deg) scale(1.05); }
  }

  @media (prefers-reduced-motion: reduce){
    body::after{ animation:none; }
    .btn, .idea, .stat{ transition:none !important; }
  }

  a{ color:inherit; text-decoration:none; }
  a:hover{ text-decoration:underline; text-decoration-color: color-mix(in oklab, var(--accent2) 45%, transparent); }

  .container{
    max-width:980px;
    margin:0 auto;
    padding:clamp(18px, 4vw, 44px);
    position:relative;
    z-index:1;
  }

  .back{
    display:inline-flex;
    align-items:center;
    gap:10px;
    margin-bottom:16px;
    font-size:.95rem;
    color:var(--muted);
    padding:10px 12px;
    border-radius:999px;
    background:color-mix(in oklab, var(--panel) 65%, transparent);
    border:1px solid color-mix(in oklab, var(--border) 85%, transparent);
    backdrop-filter: blur(10px);
  }
  .back:hover{
    color:var(--text);
    border-color: color-mix(in oklab, var(--accent2) 30%, var(--border));
  }

  /* Hero */
  .hero{
    text-align:center;
    padding:22px 14px 6px;
    border-radius:var(--r2);
    margin-bottom:18px;
  }

  .hero h1{
    margin:0;
    font-size:clamp(2.2rem, 4.2vw, 3.2rem);
    letter-spacing:.2px;
    line-height:1.05;
    background: linear-gradient(90deg, var(--accent2), var(--accent), var(--accent3));
    -webkit-background-clip:text; background-clip:text; color:transparent;
    text-shadow: 0 10px 35px color-mix(in oklab, var(--accent2) 18%, transparent);
  }
  .sub{
    margin:.35rem 0 0;
    font-size:1.05rem;
    color:var(--muted);
  }

  .hero-controls{
    display:flex;
    justify-content:center;
    gap:10px;
    margin-top:10px;
  }

  /* Generic row */
  .row{display:flex; gap:14px; flex-wrap:wrap; align-items:center;}
  .grow{flex:1 1 280px;}

  /* Glass card with gradient edge */
  .card{
    border-radius:var(--r2);
    padding:18px;
    color:var(--text);
    border:1px solid transparent;
    background:
      linear-gradient(var(--surface), var(--surface)) padding-box,
      linear-gradient(135deg,
        color-mix(in oklab, var(--accent2) 40%, transparent),
        color-mix(in oklab, var(--accent) 40%, transparent),
        color-mix(in oklab, var(--accent3) 30%, transparent)
      ) border-box;
    box-shadow:var(--shadow2);
    backdrop-filter: blur(12px);
  }

  /* Stats */
  .stats{
    display:grid;
    grid-template-columns:repeat(3, minmax(140px, 1fr));
    gap:var(--gap);
    margin:14px 0 14px;
  }

  .stat{
    border-radius:var(--r2);
    padding:14px 12px;
    text-align:center;
    position:relative;
    overflow:hidden;
    background: color-mix(in oklab, var(--panel) 75%, transparent);
    border:1px solid color-mix(in oklab, var(--border) 90%, transparent);
    box-shadow:var(--shadow2);
    backdrop-filter: blur(10px);
    transition: transform .18s ease, box-shadow .18s ease;
  }

  .stat::after{
    content:"";
    position:absolute; inset:-40% -30%;
    background: radial-gradient(circle at 30% 30%,
      color-mix(in oklab, var(--accent2) 22%, transparent),
      transparent 58%);
    transform: rotate(12deg);
    opacity:.55;
    pointer-events:none;
  }

  .stat:hover{ transform: translateY(-2px); box-shadow:var(--shadow); }
  .stat .k{ font-size:1.35rem; font-weight:800; letter-spacing:.2px; }
  .stat .muted{ font-size:.9rem; color:var(--muted); }

  @media (max-width:760px){
    .stats{ grid-template-columns:1fr; }
  }

  /* Segmented sort */
  .seg{
    display:inline-flex;
    padding:4px;
    border-radius:999px;
    border:1px solid color-mix(in oklab, var(--border) 95%, transparent);
    background: color-mix(in oklab, var(--panel) 65%, transparent);
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
    backdrop-filter: blur(10px);
  }

  .seg button{
    appearance:none;
    border:0;
    cursor:pointer;
    padding:9px 14px;
    border-radius:999px;
    color:var(--muted);
    background:transparent;
    font-weight:650;
    letter-spacing:.2px;
    transition: transform .14s ease, background-color .18s ease, color .18s ease, box-shadow .18s ease;
  }

  .seg button:hover{ color:var(--text); background: rgba(255,255,255,.06); }
  .seg button.active{
    color:#fff;
    background: linear-gradient(135deg, var(--accent2), var(--accent));
    box-shadow: 0 10px 22px color-mix(in oklab, var(--accent2) 18%, transparent);
  }

  /* Inputs */
  .input{
    width:100%;
    display:block;
    padding:12px 14px;
    border-radius:16px;
    border:1px solid color-mix(in oklab, var(--border) 95%, transparent);
    background: color-mix(in oklab, var(--surface) 88%, transparent);
    color:var(--text);
    outline:none;
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
    transition: box-shadow .18s ease, border-color .18s ease, transform .12s ease;
  }
  .input::placeholder{ color: color-mix(in oklab, var(--muted) 80%, transparent); }
  .input:focus-visible{
    border-color: color-mix(in oklab, var(--accent2) 55%, var(--border));
    box-shadow: 0 0 0 3px var(--ring), inset 0 0 0 1px rgba(255,255,255,.05);
  }
  textarea.input{ resize:vertical; min-height:120px; }

  #search{
    padding-left:40px;
    background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%239aa7d6' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001l3.85 3.85a1 1 0 0 0 1.415-1.415l-3.85-3.85zm-5.242.656a5 5 0 1 1 0-10 5 5 0 0 1 0 10z'/%3E%3C/svg%3E");
    background-repeat:no-repeat;
    background-position:13px center;
    background-size:16px;
  }

  /* Form heading */
  #ideaForm::before{
    content:"Idea submission ‚Äî keep it simple";
    display:block;
    font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    font-size:.92rem;
    letter-spacing:.6px;
    text-transform:uppercase;
    color: color-mix(in oklab, var(--accent2) 55%, var(--muted));
    margin-bottom:12px;
  }

  /* Buttons */
  .btn{
    appearance:none;
    border:1px solid color-mix(in oklab, var(--border) 95%, transparent);
    background: color-mix(in oklab, var(--panel) 70%, transparent);
    color:var(--text);
    border-radius:14px;
    padding:10px 14px;
    cursor:pointer;
    font-weight:700;
    letter-spacing:.2px;
    box-shadow: 0 10px 22px rgba(0,0,0,.18);
    transition: transform .14s ease, box-shadow .18s ease, border-color .18s ease, background-color .18s ease;
    backdrop-filter: blur(10px);
  }
  .btn:hover{
    transform: translateY(-1px);
    border-color: color-mix(in oklab, var(--accent2) 28%, var(--border));
    box-shadow: 0 16px 36px rgba(0,0,0,.26);
  }
  .btn:active{ transform: translateY(0px) scale(.99); }
  .btn:focus-visible{ outline: 2px solid var(--ring); outline-offset: 2px; }
  .btn[disabled]{ opacity:.55; cursor:not-allowed; transform:none; box-shadow:none; }

  .btn.ghost{
    background:transparent;
    box-shadow:none;
  }

  /* pressed state for Vote/Follow */
  .btn[aria-pressed="true"]{
    border-color:transparent;
    color:#fff;
    background: linear-gradient(135deg, var(--accent2), var(--accent));
    box-shadow: 0 14px 30px color-mix(in oklab, var(--accent2) 18%, transparent);
  }

  /* Form actions */
  .form-actions{
    display:flex;
    justify-content:flex-end;
    align-items:center;
    gap:12px;
    margin-top:14px;
  }
  .form-actions .btn{
    border-color:transparent;
    color:#fff;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
  }

  /* Ideas list */
  .ideas{ display:flex; flex-direction:column; gap:14px; margin-top:16px; }

  .idea{
    position:relative;
    padding:18px;
    border-radius:var(--r2);
    border:1px solid color-mix(in oklab, var(--border) 92%, transparent);
    background: color-mix(in oklab, var(--surface) 92%, transparent);
    box-shadow:var(--shadow2);
    overflow:hidden;
    transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
    backdrop-filter: blur(12px);
  }

  .idea::before{
    content:"";
    position:absolute; inset:-1px;
    background: linear-gradient(135deg,
      color-mix(in oklab, var(--accent2) 30%, transparent),
      transparent 40%,
      color-mix(in oklab, var(--accent) 24%, transparent));
    opacity:.55;
    pointer-events:none;
  }

  .idea::after{
    content:"";
    position:absolute; top:-60px; right:-80px;
    width:220px; height:220px;
    background: radial-gradient(circle at 30% 30%,
      color-mix(in oklab, var(--accent3) 26%, transparent),
      transparent 62%);
    opacity:.6;
    pointer-events:none;
  }

  .idea:hover{
    transform: translateY(-2px);
    border-color: color-mix(in oklab, var(--accent2) 20%, var(--border));
    box-shadow:var(--shadow);
  }

  .idea h3{
    margin:0 0 8px 0;
    font-size:1.18rem;
    display:flex;
    align-items:center;
    gap:10px;
    position:relative;
    z-index:1;
  }

  .idea h3::before{
    content:"";
    width:10px;
    height:10px;
    border-radius:50%;
    background: linear-gradient(135deg, var(--accent2), var(--accent));
    box-shadow: 0 0 0 3px color-mix(in oklab, var(--accent2) 18%, transparent);
    flex:0 0 10px;
  }

  .muted{ color:var(--muted); }
  .idea .muted{ position:relative; z-index:1; }

  .tags{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    margin-top:10px;
    position:relative;
    z-index:1;
  }

  .tag{
    font-size:.82rem;
    padding:5px 10px;
    border-radius:999px;
    border:1px solid color-mix(in oklab, var(--border) 95%, transparent);
    background: color-mix(in oklab, var(--panel) 70%, transparent);
    color:var(--text);
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.03);
  }

  .actions{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:12px;
    margin-top:14px;
    position:relative;
    z-index:1;
  }

  .vote{ display:inline-flex; align-items:center; gap:10px; }
  .count{ font-weight:800; letter-spacing:.2px; }

  .pill{
    padding:6px 10px;
    border-radius:999px;
    background: color-mix(in oklab, var(--panel) 70%, transparent);
    border:1px solid color-mix(in oklab, var(--border) 95%, transparent);
    color:var(--text);
  }

  .empty{
    padding:20px;
    border:1px dashed color-mix(in oklab, var(--border) 95%, transparent);
    border-radius:var(--r2);
    text-align:center;
    color:var(--muted);
    background: color-mix(in oklab, var(--panel) 55%, transparent);
  }

  .note{ margin-top:12px; color:var(--muted); }
  .hide{ display:none !important; }

  /* Smooth theme switch */
  .anim-theme *{ transition: color .25s, background-color .25s, border-color .25s, box-shadow .25s; }

  /* Idea highlight */
  .idea.highlight{
    outline: 2px solid color-mix(in oklab, var(--accent2) 65%, var(--accent));
    box-shadow: 0 0 0 6px color-mix(in oklab, var(--accent2) 18%, transparent), var(--shadow);
  }
</style>

</head>
<body>
  <div class="container">
    <a href="index.html" class="back">‚Üê Back to Home</a>

    <div class="hero">
      <h1>Suggest a Tool</h1>
      <p class="sub">Propose ideas, vote, and get updates.</p>
      <div class="hero-controls">
  <button id="themeToggle" class="btn ghost" type="button" aria-pressed="false" aria-label="Toggle theme">üåô</button>
</div>

    </div>

    <div class="stats">
      <div class="stat"><div class="k" id="statIdeas">0</div><div class="muted">Ideas</div></div>
      <div class="stat"><div class="k" id="statVotes">0</div><div class="muted">Votes</div></div>
      <div class="stat"><div class="k" id="statFollowers">0</div><div class="muted">Followers</div></div>
    </div>

    <!-- Sign-in prompt -->
    <div id="guestCard" class="card hide">
      <div class="row">
        <div class="grow">
          <div class="muted">Sign in to propose an idea and vote.</div>
        </div>
        <button id="signInBtn" class="btn" type="button">Sign in</button>
      </div>
    </div>

    <!-- Submit form -->
    <div id="userCard" class="card hide" aria-hidden="true">
      <form id="ideaForm">
        <div class="row" style="margin-bottom:12px">
          <input id="title" class="input grow" type="text" maxlength="80" placeholder="Title (max 80 chars)" required/>
          <input id="tags" class="input" type="text" placeholder="Tags (comma separated)"/>
        </div>
        <textarea id="details" class="input" rows="4" maxlength="500" placeholder="Describe the problem/use-case (max 500 chars)"></textarea>
        <div class="form-actions">
          <span id="formMsg" class="muted" aria-live="polite"></span>
          <button id="submitBtn" class="btn" type="submit">Submit idea</button>
        </div>
      </form>
    </div>

    <!-- List & controls -->
    <div class="card">
      <div class="row" style="justify-content:space-between;margin-bottom:var(--gap)">
        <input id="search" class="input grow" type="search" placeholder="Search ideas‚Ä¶"/>
        <div class="seg" role="tablist" aria-label="Sort">
          <button data-sort="top" class="active" role="tab" aria-selected="true">Top</button>
          <button data-sort="new" role="tab" aria-selected="false">New</button>
          <button data-sort="trending" role="tab" aria-selected="false">Trending</button>
        </div>
      </div>

      <div id="ideasWrap" class="ideas">
        <div class="empty muted" id="emptyState">Ideas will appear here soon.</div>
      </div>

      <p class="note" id="modeNote"></p>
    </div>
  </div>

      <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.44.4/dist/umd/supabase.min.js"></script>
  <script src="js/supabase-client.js"></script>

  <script>
    // ===== Setup / client detection =====
    let supabaseClient = window.supabaseClient || null;
    if (!supabaseClient && window.supabase && window.SUPABASE_URL && window.SUPABASE_ANON_KEY) {
      try { supabaseClient = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY); } catch(e) {}
    }

    const els = {
      guest: document.getElementById('guestCard'),
      user: document.getElementById('userCard'),
      signIn: document.getElementById('signInBtn'),
      form: document.getElementById('ideaForm'),
      submit: document.getElementById('submitBtn'),
      msg: document.getElementById('formMsg'),
      ideasWrap: document.getElementById('ideasWrap'),
      empty: document.getElementById('emptyState'),
      search: document.getElementById('search'),
      sortTabs: document.querySelectorAll('.seg button'),
      statIdeas: document.getElementById('statIdeas'),
      statVotes: document.getElementById('statVotes'),
      statFollowers: document.getElementById('statFollowers'),
      modeNote: document.getElementById('modeNote'),
      themeToggle: document.getElementById('themeToggle')
    };

    /* ===== LocalStorage helpers for demo vote/follow persistence ===== */
    const LS_VOTES = 'ba_votes';
    const LS_FOLLOWS = 'ba_follows';
    const readSet = (k)=>{ try{ return new Set(JSON.parse(localStorage.getItem(k)||'[]')); }catch(_){ return new Set(); } };
    const writeSet = (k,set)=>{ try{ localStorage.setItem(k, JSON.stringify([...set])); }catch(_){} };

    /* ===== Theme (Light/Dark with prefers-color-scheme + localStorage) ===== */
    const THEME_KEY = 'ba_theme';
    function getPreferredTheme(){
      try{
        const saved = localStorage.getItem(THEME_KEY);
        if (saved === 'light' || saved === 'dark') return saved;
      }catch(_){}
      return (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) ? 'light' : 'dark';
    }
        function applyTheme(t){
      // brief animation class for smooth change
      document.documentElement.classList.add('anim-theme');
      document.documentElement.classList.toggle('light', t === 'light');
      if (els.themeToggle){
        els.themeToggle.setAttribute('aria-pressed', String(t === 'light'));
        els.themeToggle.textContent = (t === 'light') ? 'üåû' : 'üåô';
        els.themeToggle.title = (t === 'light') ? 'Switch to dark' : 'Switch to light';
      }
      setTimeout(()=>document.documentElement.classList.remove('anim-theme'), 280);
    }

    let currentTheme = getPreferredTheme();
    applyTheme(currentTheme);
    els.themeToggle?.addEventListener('click', ()=>{
      currentTheme = (currentTheme === 'light') ? 'dark' : 'light';
      try{ localStorage.setItem(THEME_KEY, currentTheme); }catch(_){}
      applyTheme(currentTheme);
    });
    function show(el){ el.classList.remove('hide'); el.setAttribute('aria-hidden','false'); }
    function hide(el){ el.classList.add('hide'); el.setAttribute('aria-hidden','true'); }

    function gotoLogin(){
      try { localStorage.setItem('ba_redirect','suggest.html'); } catch(_) {}
      location.href = 'index.html?login=1';
    }
    els.signIn.addEventListener('click', gotoLogin);

    // ===== Rendering =====
    function renderStats(list){
      els.statIdeas.textContent = list.length.toString();
      els.statVotes.textContent = list.reduce((a,i)=>a+(i.votes||0),0);
      els.statFollowers.textContent = list.reduce((a,i)=>a+(i.followers||0),0);
    }

        function ideaItem(i, loggedIn){
      const voted = readSet(LS_VOTES);
      const followed = readSet(LS_FOLLOWS);

      const li = document.createElement('div');
      li.className = 'idea';
      li.id = i.id;

      const isVoted = voted.has(i.id);
      const voteCount = (i.votes||0) + (isVoted ? 1 : 0);

      const isFollow = followed.has(i.id);

      li.innerHTML = `
        <h3>${escapeHtml(i.title)}</h3>
        ${i.details ? `<div class="muted">${escapeHtml(i.details)}</div>` : ''}
        <div class="tags">${(i.tags||[]).map(t=>`<span class="tag">#${escapeHtml(t)}</span>`).join('')}</div>
        <div class="actions">
          <div class="vote">
            <button class="btn voteBtn" ${loggedIn?'':'disabled'} aria-pressed="${isVoted?'true':'false'}">‚ñ≤ Vote</button>
            <span class="muted count">${voteCount}</span>
          </div>
          <div class="row" style="gap:8px">
            <button class="btn followBtn" ${loggedIn?'':'disabled'} aria-pressed="${isFollow?'true':'false'}">${isFollow?'Following':'Follow'}</button>
            <button class="btn shareBtn" type="button" aria-label="Copy link">Share</button>
          </div>
        </div>
      `;

      const voteBtn = li.querySelector('.voteBtn');
      const countEl = li.querySelector('.count');
      voteBtn?.addEventListener('click', ()=>{
        if (!loggedIn) return;
        const pressed = voteBtn.getAttribute('aria-pressed') === 'true';
        if (pressed){ voted.delete(i.id); } else { voted.add(i.id); }
        writeSet(LS_VOTES, voted);
        voteBtn.setAttribute('aria-pressed', String(!pressed));
        const delta = pressed ? -1 : 1;
        const val = Math.max(0, (parseInt(countEl.textContent||'0',10)+delta));
        countEl.textContent = String(val);
      });

      const followBtn = li.querySelector('.followBtn');
      followBtn?.addEventListener('click', ()=>{
        if (!loggedIn) return;
        const pressed = followBtn.getAttribute('aria-pressed') === 'true';
        if (pressed){ followed.delete(i.id); } else { followed.add(i.id); }
        writeSet(LS_FOLLOWS, followed);
        followBtn.setAttribute('aria-pressed', String(!pressed));
        followBtn.textContent = pressed ? 'Follow' : 'Following';
      });

      const shareBtn = li.querySelector('.shareBtn');
      shareBtn?.addEventListener('click', async ()=>{
        const url = new URL(location.href);
        url.searchParams.set('id', i.id);
        try{
          await navigator.clipboard.writeText(url.toString());
          shareBtn.textContent = 'Copied!';
          setTimeout(()=>shareBtn.textContent='Share', 1000);
        }catch(_){
          location.hash = i.id; // fallback
        }
      });

      return li;
    }


    function renderIdeas(list, loggedIn){
      els.ideasWrap.innerHTML = '';
      if(!list.length){ show(els.empty); return; }
      hide(els.empty);
      list.forEach(i => els.ideasWrap.appendChild(ideaItem(i, loggedIn)));
      renderStats(list);
    }

    function escapeHtml(s){ return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    // ===== Sorting & Search (front-only) =====
    let currentSort = 'top';
    let baseIdeas = [];

    els.sortTabs.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        els.sortTabs.forEach(b=>{b.classList.remove('active'); b.setAttribute('aria-selected','false');});
        btn.classList.add('active'); btn.setAttribute('aria-selected','true');
        currentSort = btn.dataset.sort;
        updateURLState();
        applyFilters();
      });
    });
    els.search.addEventListener('input', ()=>{ updateURLState(); applyFilters(); });

    // "/" focuses search
    window.addEventListener('keydown', (e)=>{
      if (e.key === '/' && document.activeElement && !/^(input|textarea)$/i.test(document.activeElement.tagName)){
        e.preventDefault(); els.search.focus();
      }
    });

    function updateURLState(){
      const url = new URL(location.href);
      const q = els.search.value.trim();
      if (q) url.searchParams.set('q', q); else url.searchParams.delete('q');
      url.searchParams.set('sort', currentSort);
      history.replaceState(null, '', url.toString());
    }

        function applyFilters(){
      const q = els.search.value.trim().toLowerCase();
      let data = [...baseIdeas];
      if(q){
        data = data.filter(i => (i.title+i.details+(i.tags||[]).join(' ')).toLowerCase().includes(q));
      }
      if(currentSort==='new') data.sort((a,b)=>b.created_at - a.created_at);
      else if(currentSort==='trending') data.sort((a,b)=>(b.votes/(Date.now()-b.created_at+1)) - (a.votes/(Date.now()-a.created_at+1)));
      else data.sort((a,b)=>b.votes - a.votes); // top
      renderIdeas(data, state.loggedIn);

      // highlight deep-linked idea (?id=...)
      const url = new URL(location.href);
      const targetId = url.searchParams.get('id');
      if (targetId){
        const el = document.getElementById(targetId);
        if (el){
          el.classList.add('highlight');
          el.scrollIntoView({behavior:'smooth', block:'center'});
          setTimeout(()=>el.classList.remove('highlight'), 1400);
        }
      }
    }


    // ===== State & Init =====
    const state = { loggedIn:false, demo:true };

    async function init(){
      // read URL state
      const url = new URL(location.href);
      const qParam = url.searchParams.get('q') || '';
      const sortParam = url.searchParams.get('sort');
      if (qParam) els.search.value = qParam;
      if (sortParam && ['top','new','trending'].includes(sortParam)){
        currentSort = sortParam;
        els.sortTabs.forEach(b=>{
          b.classList.toggle('active', b.dataset.sort===currentSort);
          b.setAttribute('aria-selected', b.dataset.sort===currentSort ? 'true':'false');
        });
      }

      if (!supabaseClient) {
        state.demo = true;
        els.modeNote.textContent = 'Note: Backend not connected yet. This is an interactive demo preview.';
        show(els.guest); hide(els.user);
        applyFilters();
        return;
      }

      try {
        const { data:{ session } } = await supabaseClient.auth.getSession();
        state.loggedIn = !!session;
        state.demo = false;
        els.modeNote.textContent = state.loggedIn
          ? 'You can propose ideas and vote.'
          : 'Sign in to propose ideas and vote.';
        if(state.loggedIn){
  hide(els.guest); show(els.user);
} else {
  // üîí Redirect if user not logged in (direct access protection)
  window.location.href = "index.html";
  return;
}

        // Pobierz zaakceptowane pomys≈Çy z Supabase
const { data, error } = await supabaseClient
  .from('tool_ideas')
  .select('id, title, details, tags, author, created_at')
  .eq('status','approved')
  .order('created_at',{ ascending:false });

if (error) {
  console.error('Error loading ideas:', error);
  els.modeNote.textContent = 'Could not load ideas from backend.';
  baseIdeas = [];
} else {
  baseIdeas = data || [];
}
applyFilters();

      } catch (e) {
        state.demo = true;
        els.modeNote.textContent = 'Could not connect to backend. Showing demo.';
        show(els.guest); hide(els.user);
        applyFilters();
      }
    }

    // Submit (backend)
els.form?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  if (!supabaseClient) { els.msg.textContent = 'Backend not configured yet.'; return; }
  els.submit.disabled = true; els.msg.textContent = 'Saving‚Ä¶';
  try {
    const { data:{ session } } = await supabaseClient.auth.getSession();
    if(!session){ els.msg.textContent='Please sign in first.'; els.submit.disabled=false; return; }

    const payload = {
      title: document.getElementById('title').value.trim(),
      details: document.getElementById('details').value.trim(),
      tags: (document.getElementById('tags').value||'').split(/[\s,]+/).map(t=>t.trim()).filter(Boolean),
      author: session.user.id, // FK -> profiles.id
      status: 'pending'
    };

    const { data: inserted, error } = await supabaseClient
  .from('tool_ideas')
  .insert(payload)
  .select('id, title')
  .maybeSingle();

    if (error) {
      els.msg.textContent = 'Save error: ' + (error.message || error);
    } else {
      // üîπ Rejestruj aktywno≈õƒá w globalnym feedzie
try {
  const { data: { session } } = await supabaseClient.auth.getSession();
  if (session?.user?.id && inserted?.id) {
    await supabaseClient.from('activity_events').insert({
      actor_id: session.user.id,
      verb: 'suggested',
      subject_type: 'tool_idea',
      summary: `Suggested a new tool: "${inserted.title || payload.title || 'Unnamed idea'}"`
    });
  } else {
    console.warn('Skipped activity_events insert ‚Äî missing user or idea ID.');
  }
} catch (e) {
  console.warn('activity_events insert failed', e);
}

      els.msg.textContent = 'Idea submitted!'; 
      els.form.reset();
      if (typeof applyFilters === 'function') applyFilters();
    }
  } catch(err){
    els.msg.textContent = 'Error: '+(err?.message||'unknown');
  } finally {
    els.submit.disabled = false;
  }
});

    init();
  </script>
</body>
</html>
