<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="robots" content="noindex, nofollow"/>
  <title>Suggest a Tool ‚Äî BeAwarely</title>
  <link rel="stylesheet" href="css/style.css"/>
  <style>
  /* Theme tokens ‚Äî Dark default (matches BeAwarely), Light via .light on <html> */
  :root{
    /* dark */
    --bg:#0b0d14;
    --panel:#121625;
    --surface:#0f1424;
    --text:#eaf0ff;
    --muted:#b9c2e6;
    --accent:#5aa8ff;
    --accent-2:#9ad0ff;
    --ring:rgba(90,168,255,.45);
    --border:rgba(234,240,255,.14);
    --bg-gradient: radial-gradient(1200px 800px at 10% -10%, #10162a 0%, #070a12 40%, #050811 100%);
  }
  /* light overrides */
  .light{
    --bg:#f6f8ff;
    --panel:#ffffff;
    --surface:#f0f3ff;
    --text:#0c1222;
    --muted:#51608b;
    --accent:#0b67ff;
    --accent-2:#3fa0ff;
    --ring:rgba(11,103,255,.35);
    --border:rgba(12,18,34,.12);
    --bg-gradient: radial-gradient(1200px 800px at 10% -10%, #ffffff 0%, #eef3ff 45%, #e9f0ff 100%);
  }

  body{
    margin:0;
    background: var(--bg-gradient);
    color:var(--text);
  }
  a{color:var(--accent)}

  .container{max-width:1000px;margin:0 auto;padding:28px}
  .back{display:inline-block;margin-bottom:10px}

  /* Centered, prominent header */
  .hero{
    display:flex;flex-direction:column;align-items:center;justify-content:center;
    gap:10px;margin-bottom:18px;text-align:center
  }
  .hero h1{
    margin:0;font-size:2.2rem;letter-spacing:.3px;
    background: linear-gradient(90deg, var(--accent), var(--accent-2));
    -webkit-background-clip:text;background-clip:text;color:transparent
  }
  .sub{color:var(--muted);margin:.25rem 0 0}
  .hero-controls{display:flex;gap:10px;align-items:center}
  .btn.ghost{background:transparent;border:1px solid var(--border)}
  .btn.ghost:focus-visible{outline:2px solid var(--ring);outline-offset:2px}


  .stats{display:grid;grid-template-columns:repeat(3,minmax(140px,1fr));gap:14px;margin:18px 0 8px}
  .stat{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:12px;color:var(--text)}
  .stat .k{font-size:1.25rem;font-weight:600}

  .row{display:flex;gap:14px;flex-wrap:wrap;align-items:center}
  .grow{flex:1 1 280px}

  .seg{display:flex;border:1px solid var(--border);border-radius:12px;overflow:hidden}
  .seg button{padding:8px 12px;background:transparent;border:0;color:var(--text);cursor:pointer}
  .seg button.active{background:rgba(234,240,255,.08)}
  .seg button:focus-visible{outline:2px solid var(--ring);outline-offset:2px}

  .input{width:100%;padding:10px 12px;border-radius:12px;background:var(--surface);color:var(--text);
         border:1px solid var(--border)}
  .input::placeholder{color:color-mix(in oklab, var(--muted) 70%, transparent)}
  textarea.input{resize:vertical}

  .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;color:var(--text)}
  .ideas{display:flex;flex-direction:column;gap:12px;margin-top:12px}
  .idea{border:1px solid var(--border);border-radius:14px;padding:14px;background:var(--surface);color:var(--text)}
  .idea h3{margin:0 0 6px 0;font-size:1.05rem}

  .muted{color:var(--muted)}
  .tags{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
  .tag{font-size:.8rem;border:1px solid var(--border);padding:2px 8px;border-radius:999px;color:var(--text)}

  .actions{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-top:10px}
  .btn{padding:9px 12px;border-radius:12px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .btn:focus-visible{outline:2px solid var(--ring);outline-offset:2px}

  .vote{display:inline-flex;align-items:center;gap:6px}
  .pill{padding:6px 10px;border-radius:999px;background:rgba(234,240,255,.08);border:1px solid var(--border);color:var(--text)}
  .empty{padding:16px;border:1px dashed var(--border);border-radius:14px;text-align:center;color:var(--muted)}
  .note{margin-top:10px;color:var(--muted)}
  .hide{display:none !important}

  /* Smooth theme switch */
  .anim-theme *{ transition: color .25s, background-color .25s, border-color .25s }

  /* Idea highlight from deep-link (?id=...) */
  .idea.highlight{ outline:2px solid var(--accent); box-shadow:0 0 0 6px color-mix(in oklab, var(--accent) 20%, transparent); }
</style>

</head>
<body>
  <div class="container">
    <a href="index.html" class="back">‚Üê Back to Home</a>

    <div class="hero">
      <h1>Suggest a Tool</h1>
      <p class="sub">Propose ideas, vote, and get updates.</p>
      <div class="hero-controls">
        <button id="themeToggle" class="btn ghost" type="button" aria-pressed="false" aria-label="Toggle theme">üåô</button>
        <div class="pill" id="modePill" aria-live="polite">Loading‚Ä¶</div>
      </div>
    </div>

    <div class="stats">
      <div class="stat"><div class="k" id="statIdeas">0</div><div class="muted">Ideas</div></div>
      <div class="stat"><div class="k" id="statVotes">0</div><div class="muted">Votes</div></div>
      <div class="stat"><div class="k" id="statFollowers">0</div><div class="muted">Followers</div></div>
    </div>

    <!-- Sign-in prompt -->
    <div id="guestCard" class="card hide">
      <div class="row">
        <div class="grow">
          <div class="muted">Sign in to propose an idea and vote.</div>
        </div>
        <button id="signInBtn" class="btn" type="button">Sign in</button>
      </div>
    </div>

    <!-- Submit form -->
    <div id="userCard" class="card hide" aria-hidden="true">
      <form id="ideaForm">
        <div class="row" style="margin-bottom:var(--gap)">
          <input id="title" class="input grow" type="text" maxlength="80" placeholder="Title (max 80 chars)" required/>
          <input id="tags" class="input" type="text" placeholder="Tags (comma separated)"/>
        </div>
        <textarea id="details" class="input" rows="4" maxlength="500" placeholder="Describe the problem/use-case (max 500 chars)"></textarea>
        <div class="row" style="margin-top:var(--gap)">
          <button id="submitBtn" class="btn" type="submit">Submit idea</button>
          <span id="formMsg" class="muted" aria-live="polite"></span>
        </div>
      </form>
    </div>

    <!-- List & controls -->
    <div class="card">
      <div class="row" style="justify-content:space-between;margin-bottom:var(--gap)">
        <input id="search" class="input grow" type="search" placeholder="Search ideas‚Ä¶"/>
        <div class="seg" role="tablist" aria-label="Sort">
          <button data-sort="top" class="active" role="tab" aria-selected="true">Top</button>
          <button data-sort="new" role="tab" aria-selected="false">New</button>
          <button data-sort="trending" role="tab" aria-selected="false">Trending</button>
        </div>
      </div>

      <div id="ideasWrap" class="ideas">
        <div class="empty muted" id="emptyState">Ideas will appear here soon.</div>
      </div>

      <p class="note" id="modeNote"></p>
    </div>
  </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Ensure globals are present on this page as well (same as index.html) -->
  <script>
    window.SUPABASE_URL = window.SUPABASE_URL || "https://xzwpqyomqjzmiqsszwkg.supabase.co";
    window.SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh6d3BxeW9tcWp6bWlxc3N6d2tnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0MjIxMTYsImV4cCI6MjA2OTk5ODExNn0.QbjDO1xifFkDuIAZZ9WHfGomgxwhanP9BQtgMrFqDgg";
  </script>

  <script>
    // ===== Setup / client detection =====
    let supabaseClient = window.supabaseClient || null;
    if (!supabaseClient && window.supabase && window.SUPABASE_URL && window.SUPABASE_ANON_KEY) {
      try { supabaseClient = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY); } catch(e) {}
    }
    const demoIdeas = [
      { id:'d1', title:'Health Claims checker', details:'Verify supplements or therapy claims with sources.', tags:['health','claims'], votes:42, followers:19, created_at: Date.now()-86400000*2 },
      { id:'d2', title:'Consent Auditor', details:'Explain terms & privacy policies in plain English.', tags:['privacy','law'], votes:31, followers:15, created_at: Date.now()-86400000*4 },
      { id:'d3', title:'WorkVerify', details:'Confirm job ads and offers to reduce scams.', tags:['work','safety'], votes:27, followers:11, created_at: Date.now()-86400000*1 }
    ];

    const els = {
      guest: document.getElementById('guestCard'),
      user: document.getElementById('userCard'),
      signIn: document.getElementById('signInBtn'),
      form: document.getElementById('ideaForm'),
      submit: document.getElementById('submitBtn'),
      msg: document.getElementById('formMsg'),
      ideasWrap: document.getElementById('ideasWrap'),
      empty: document.getElementById('emptyState'),
      search: document.getElementById('search'),
      sortTabs: document.querySelectorAll('.seg button'),
      statIdeas: document.getElementById('statIdeas'),
      statVotes: document.getElementById('statVotes'),
      statFollowers: document.getElementById('statFollowers'),
      modePill: document.getElementById('modePill'),
      modeNote: document.getElementById('modeNote'),
      themeToggle: document.getElementById('themeToggle')
    };

    function setMode(text){ els.modePill.textContent = text; }

    /* ===== LocalStorage helpers for demo vote/follow persistence ===== */
    const LS_VOTES = 'ba_votes';
    const LS_FOLLOWS = 'ba_follows';
    const readSet = (k)=>{ try{ return new Set(JSON.parse(localStorage.getItem(k)||'[]')); }catch(_){ return new Set(); } };
    const writeSet = (k,set)=>{ try{ localStorage.setItem(k, JSON.stringify([...set])); }catch(_){} };

    /* ===== Theme (Light/Dark with prefers-color-scheme + localStorage) ===== */
    const THEME_KEY = 'ba_theme';
    function getPreferredTheme(){
      try{
        const saved = localStorage.getItem(THEME_KEY);
        if (saved === 'light' || saved === 'dark') return saved;
      }catch(_){}
      return (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) ? 'light' : 'dark';
    }
        function applyTheme(t){
      // brief animation class for smooth change
      document.documentElement.classList.add('anim-theme');
      document.documentElement.classList.toggle('light', t === 'light');
      if (els.themeToggle){
        els.themeToggle.setAttribute('aria-pressed', String(t === 'light'));
        els.themeToggle.textContent = (t === 'light') ? 'üåû' : 'üåô';
        els.themeToggle.title = (t === 'light') ? 'Switch to dark' : 'Switch to light';
      }
      setTimeout(()=>document.documentElement.classList.remove('anim-theme'), 280);
    }

    let currentTheme = getPreferredTheme();
    applyTheme(currentTheme);
    els.themeToggle?.addEventListener('click', ()=>{
      currentTheme = (currentTheme === 'light') ? 'dark' : 'light';
      try{ localStorage.setItem(THEME_KEY, currentTheme); }catch(_){}
      applyTheme(currentTheme);
    });
    function show(el){ el.classList.remove('hide'); el.setAttribute('aria-hidden','false'); }
    function hide(el){ el.classList.add('hide'); el.setAttribute('aria-hidden','true'); }

    function gotoLogin(){
      try { localStorage.setItem('ba_redirect','suggest.html'); } catch(_) {}
      location.href = 'index.html?login=1';
    }
    els.signIn.addEventListener('click', gotoLogin);

    // ===== Rendering =====
    function renderStats(list){
      els.statIdeas.textContent = list.length.toString();
      els.statVotes.textContent = list.reduce((a,i)=>a+(i.votes||0),0);
      els.statFollowers.textContent = list.reduce((a,i)=>a+(i.followers||0),0);
    }

        function ideaItem(i, loggedIn){
      const voted = readSet(LS_VOTES);
      const followed = readSet(LS_FOLLOWS);

      const li = document.createElement('div');
      li.className = 'idea';
      li.id = i.id;

      const isVoted = voted.has(i.id);
      const voteCount = (i.votes||0) + (isVoted ? 1 : 0);

      const isFollow = followed.has(i.id);

      li.innerHTML = `
        <h3>${escapeHtml(i.title)}</h3>
        ${i.details ? `<div class="muted">${escapeHtml(i.details)}</div>` : ''}
        <div class="tags">${(i.tags||[]).map(t=>`<span class="tag">#${escapeHtml(t)}</span>`).join('')}</div>
        <div class="actions">
          <div class="vote">
            <button class="btn voteBtn" ${loggedIn?'':'disabled'} aria-pressed="${isVoted?'true':'false'}">‚ñ≤ Vote</button>
            <span class="muted count">${voteCount}</span>
          </div>
          <div class="row" style="gap:8px">
            <button class="btn followBtn" ${loggedIn?'':'disabled'} aria-pressed="${isFollow?'true':'false'}">${isFollow?'Following':'Follow'}</button>
            <button class="btn shareBtn" type="button" aria-label="Copy link">Share</button>
          </div>
        </div>
      `;

      const voteBtn = li.querySelector('.voteBtn');
      const countEl = li.querySelector('.count');
      voteBtn?.addEventListener('click', ()=>{
        if (!loggedIn) return;
        const pressed = voteBtn.getAttribute('aria-pressed') === 'true';
        if (pressed){ voted.delete(i.id); } else { voted.add(i.id); }
        writeSet(LS_VOTES, voted);
        voteBtn.setAttribute('aria-pressed', String(!pressed));
        const delta = pressed ? -1 : 1;
        const val = Math.max(0, (parseInt(countEl.textContent||'0',10)+delta));
        countEl.textContent = String(val);
      });

      const followBtn = li.querySelector('.followBtn');
      followBtn?.addEventListener('click', ()=>{
        if (!loggedIn) return;
        const pressed = followBtn.getAttribute('aria-pressed') === 'true';
        if (pressed){ followed.delete(i.id); } else { followed.add(i.id); }
        writeSet(LS_FOLLOWS, followed);
        followBtn.setAttribute('aria-pressed', String(!pressed));
        followBtn.textContent = pressed ? 'Follow' : 'Following';
      });

      const shareBtn = li.querySelector('.shareBtn');
      shareBtn?.addEventListener('click', async ()=>{
        const url = new URL(location.href);
        url.searchParams.set('id', i.id);
        try{
          await navigator.clipboard.writeText(url.toString());
          shareBtn.textContent = 'Copied!';
          setTimeout(()=>shareBtn.textContent='Share', 1000);
        }catch(_){
          location.hash = i.id; // fallback
        }
      });

      return li;
    }


    function renderIdeas(list, loggedIn){
      els.ideasWrap.innerHTML = '';
      if(!list.length){ show(els.empty); return; }
      hide(els.empty);
      list.forEach(i => els.ideasWrap.appendChild(ideaItem(i, loggedIn)));
      renderStats(list);
    }

    function escapeHtml(s){ return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    // ===== Sorting & Search (front-only) =====
    let currentSort = 'top';
    let baseIdeas = [...demoIdeas];

    els.sortTabs.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        els.sortTabs.forEach(b=>{b.classList.remove('active'); b.setAttribute('aria-selected','false');});
        btn.classList.add('active'); btn.setAttribute('aria-selected','true');
        currentSort = btn.dataset.sort;
        updateURLState();
        applyFilters();
      });
    });
    els.search.addEventListener('input', ()=>{ updateURLState(); applyFilters(); });

    // "/" focuses search
    window.addEventListener('keydown', (e)=>{
      if (e.key === '/' && document.activeElement && !/^(input|textarea)$/i.test(document.activeElement.tagName)){
        e.preventDefault(); els.search.focus();
      }
    });

    function updateURLState(){
      const url = new URL(location.href);
      const q = els.search.value.trim();
      if (q) url.searchParams.set('q', q); else url.searchParams.delete('q');
      url.searchParams.set('sort', currentSort);
      history.replaceState(null, '', url.toString());
    }

        function applyFilters(){
      const q = els.search.value.trim().toLowerCase();
      let data = [...baseIdeas];
      if(q){
        data = data.filter(i => (i.title+i.details+(i.tags||[]).join(' ')).toLowerCase().includes(q));
      }
      if(currentSort==='new') data.sort((a,b)=>b.created_at - a.created_at);
      else if(currentSort==='trending') data.sort((a,b)=>(b.votes/(Date.now()-b.created_at+1)) - (a.votes/(Date.now()-a.created_at+1)));
      else data.sort((a,b)=>b.votes - a.votes); // top
      renderIdeas(data, state.loggedIn);

      // highlight deep-linked idea (?id=...)
      const url = new URL(location.href);
      const targetId = url.searchParams.get('id');
      if (targetId){
        const el = document.getElementById(targetId);
        if (el){
          el.classList.add('highlight');
          el.scrollIntoView({behavior:'smooth', block:'center'});
          setTimeout(()=>el.classList.remove('highlight'), 1400);
        }
      }
    }


    // ===== State & Init =====
    const state = { loggedIn:false, demo:true };

    async function init(){
      // read URL state
      const url = new URL(location.href);
      const qParam = url.searchParams.get('q') || '';
      const sortParam = url.searchParams.get('sort');
      if (qParam) els.search.value = qParam;
      if (sortParam && ['top','new','trending'].includes(sortParam)){
        currentSort = sortParam;
        els.sortTabs.forEach(b=>{
          b.classList.toggle('active', b.dataset.sort===currentSort);
          b.setAttribute('aria-selected', b.dataset.sort===currentSort ? 'true':'false');
        });
      }

      if (!supabaseClient) {
        state.demo = true;
        setMode('Demo mode');
        els.modeNote.textContent = 'Note: Backend not connected yet. This is an interactive demo preview.';
        show(els.guest); hide(els.user);
        applyFilters();
        return;
      }

      try {
        const { data:{ session } } = await supabaseClient.auth.getSession();
        state.loggedIn = !!session;
        state.demo = false;
        setMode(state.loggedIn ? 'Connected' : 'Guest');
        els.modeNote.textContent = state.loggedIn
          ? 'You can propose ideas and vote.'
          : 'Sign in to propose ideas and vote.';
        if(state.loggedIn){ hide(els.guest); show(els.user); } else { show(els.guest); hide(els.user); }

        // TODO: Replace with real fetch from Supabase when tables are ready
        baseIdeas = [...demoIdeas];
        applyFilters();

      } catch (e) {
        state.demo = true;
        setMode('Demo mode');
        els.modeNote.textContent = 'Could not connect to backend. Showing demo.';
        show(els.guest); hide(els.user);
        applyFilters();
      }
    }

    // Submit (no backend yet)
    els.form?.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if (!supabaseClient) { els.msg.textContent = 'Backend not configured yet.'; return; }
      els.submit.disabled = true; els.msg.textContent = 'Saving‚Ä¶';
      try {
        const { data:{ session } } = await supabaseClient.auth.getSession();
        if(!session){ els.msg.textContent='Please sign in first.'; els.submit.disabled=false; return; }
        // Placeholder insert ‚Äì will work once table exists + RLS set
        const payload = {
          title: document.getElementById('title').value.trim(),
          details: document.getElementById('details').value.trim(),
          tags: (document.getElementById('tags').value||'').split(',').map(t=>t.trim()).filter(Boolean),
          author: session.user.id, status:'proposed'
        };
        const { error } = await supabaseClient.from('tool_ideas').insert(payload);
        if (error) els.msg.textContent = 'Cannot save yet (backend not set up).';
        else { els.msg.textContent='Idea submitted!'; els.form.reset(); }
      } catch(err){
        els.msg.textContent = 'Error: '+(err?.message||'unknown');
      } finally {
        els.submit.disabled = false;
      }
    });

    init();
  </script>
</body>
</html>
