<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <meta name="robots" content="noindex, nofollow"/>
  <title>WorkVerify ‚Äî Satire Version</title>
  <link rel="stylesheet" href="css/style.css"/>

    <style>
    :root{ --safe-top: env(safe-area-inset-top, 0px); }

    /* DARK (default) */
    body{
      --bg: radial-gradient(1200px 800px at 30% -10%, #0c0a22 0%, #05010f 100%);
      --bg-elev: #18122e;
      --card: rgba(20,16,36,0.85);
      --text: #e0e6ff;
      --muted: #8aa4c8;
      --border: rgba(255,255,255,0.12);
      --accent: #3af2d9;
      --accent-2: #a24dff;
      --pill: rgba(255,255,255,.08);
      --pill-hover: rgba(255,255,255,.14);
      --input-bg: rgba(255,255,255,.02);
      --shadow: 0 6px 16px rgba(12,20,40,.32);

      /* AI dock (DARK): deep greens */
      --ai-bg: #0d1f14;
      --ai-bg-2:#12361f;
      --ai-border: rgba(88,196,140,.25);
      --ai-text:#DFF7EA;
      --ai-muted:#9DD7B8;

      margin:0; font-family:'Segoe UI', system-ui, Arial, sans-serif;
      background: var(--bg); color: var(--text);
    }

    /* LIGHT */
    body.light-mode{
      --bg: #F4F7FB;
      --bg-elev: #ECF2FA;
      --card: #FFFFFF;
      --text: #0E1730;
      --muted: #5A6B89;
      --border: rgba(14,23,48,0.12);
      --accent: #2F54EB;
      --accent-2: #69A1FF;
      --pill: rgba(14,23,48,.06);
      --pill-hover: rgba(14,23,48,.10);
      --input-bg: rgba(14,23,48,.025);
      --shadow: 0 6px 14px rgba(18,30,60,.08);

      /* AI dock (LIGHT): soft grey-greens */
      --ai-bg:#ECF5EF;
      --ai-bg-2:#E3F0E8;
      --ai-border: rgba(29,105,76,.18);
      --ai-text:#103322;
      --ai-muted:#3a6a52;

      color: var(--text);
      background: linear-gradient(0deg, var(--bg), var(--bg));
    }
    body.dark-mode{ background: var(--bg); }


    #topbar{
      position:fixed; top:calc(14px + var(--safe-top)); left:20px; right:20px; z-index:10000;
      display:flex; justify-content:space-between; align-items:center; pointer-events:none;
    }
    #topbar .grp{ display:flex; gap:12px; align-items:center; pointer-events:auto; }
    .pill{
      background:var(--pill); color:inherit; font-weight:700; text-decoration:none;
      padding:6px 14px; border-radius:12px; border:1px solid var(--border);
      display:inline-flex; align-items:center; gap:8px; cursor:pointer;
      backdrop-filter:saturate(160%) blur(4px);
      transition:background .2s ease, transform .15s ease, border-color .2s ease;
    }
    .pill:hover{ background:var(--pill-hover); transform:translateY(-1px); }

    header{ text-align:center; padding: calc(120px + var(--safe-top)) 16px 12px; }
    header h1{
      font-family:'Sriracha',cursive; font-size:56px; margin:0 0 8px; letter-spacing:.3px;
      background:linear-gradient(90deg,
        color-mix(in oklab,var(--text) 85%,var(--accent) 15%),
        color-mix(in oklab,var(--accent) 60%,var(--text) 40%));
      -webkit-background-clip:text; background-clip:text; color:transparent;
      text-shadow:0 2px 12px color-mix(in oklab,var(--accent) 22%, transparent);
    }
    header p.sub{ color:var(--muted); margin:0; }

    main{ max-width:1100px; margin:0 auto; padding:24px 16px 60px; display:grid; gap:16px; }
    .panel{
      background:linear-gradient(180deg,var(--card),var(--card));
      border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow:var(--shadow);
    }
    .panel h2{ margin:0 0 8px; font-size:20px; letter-spacing:.2px; }
    .muted{ color:var(--muted); }
    .grid{ display:grid; grid-template-columns:repeat(2, minmax(260px,1fr)); gap:16px; }
    @media (max-width:900px){ .grid{ grid-template-columns:1fr; } }
    .btn{
      border:none; padding:10px 14px; border-radius:10px;
      background:linear-gradient(135deg,var(--accent),var(--accent-2));
      color:#fff; font-weight:800; cursor:pointer;
      transition: transform .12s ease, filter .2s ease, box-shadow .2s ease;
      box-shadow:0 6px 16px rgba(48,92,255,.35);
    }
    .btn.secondary{ background:transparent; color:inherit; border:1px solid var(--border); box-shadow:none; }
    .toolbar{ display:flex; flex-wrap:wrap; gap:8px; justify-content:flex-end; margin-top:10px; }
    textarea, input[type="text"]{
      width:100%; box-sizing:border-box; padding:10px 12px; border-radius:10px;
      border:1px solid var(--border); background:var(--input-bg); color:inherit; outline:none;
      transition:border-color .15s ease, box-shadow .15s ease, background .15s ease;
    }
    textarea::placeholder, input::placeholder{ color: color-mix(in oklab,var(--muted) 65%, transparent); }
    textarea:focus, input[type="text"]:focus{
      border-color: color-mix(in oklab,var(--accent) 70%, white 30%);
      box-shadow: 0 0 0 3px color-mix(in oklab,var(--accent) 22%, transparent);
      background: color-mix(in oklab,var(--input-bg) 70%, white 30%);
    }

    .badge{ font-size:12px; padding:4px 8px; border-radius:999px;
      background:color-mix(in oklab,var(--accent) 16%, transparent);
      border:1px solid var(--border); color:inherit; display:inline-block; }

    .preview{
      border:1px solid var(--border); border-radius:12px; padding:12px;
      background:color-mix(in oklab,var(--card) 92%, transparent);
      min-height:90px; white-space:pre-wrap;
    }
    .warn{
      border:1px solid color-mix(in oklab, #ffb6b6 40%, var(--border));
      background:color-mix(in oklab, #ffb6b6 10%, transparent);
      color:inherit; border-radius:12px; padding:10px; font-size:14px; margin-top:10px;
    }
    .warn ul{ margin:6px 0 0 18px; }
  </style>

  <script>
    // light/dark
    document.addEventListener('DOMContentLoaded', ()=>{
      const saved = localStorage.getItem('mode');
      const prefersLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
      const isLight = saved ? (saved === 'light') : prefersLight;
      document.body.classList.toggle('light-mode', isLight);
      document.body.classList.toggle('dark-mode', !isLight);
    });
    function toggleLightDarkMode(){
      document.body.classList.add('theme-anim');
      const isLight = document.body.classList.toggle('light-mode');
      document.body.classList.toggle('dark-mode', !isLight);
      localStorage.setItem('mode', isLight ? 'light' : 'dark');
      setTimeout(()=> document.body.classList.remove('theme-anim'), 280);
    }
  </script>
</head>
<body>
  <!-- Topbar -->
  <div id="topbar">
    <div class="grp">
      <a href="workverify.html" class="pill">‚Üê Fakty</a>
    </div>
    <div class="grp">
      <button class="pill" onclick="toggleLightDarkMode()">üåì</button>
      <a href="profile.html" class="pill">Your Profile</a>
    </div>
  </div>

  <header>
    <h1>Satire Version</h1>
    <p class="sub">Ta sekcja to forma artystyczna tej samej historii. Zero nazw firm, zero imion i nazwisk.</p>
  </header>

    <main>
    <!-- AI Assist -->
    <section class="panel ai-panel">
      <h2>AI Assist ‚Äî Satire</h2>
      <textarea id="aiInput" rows="3" placeholder="Ask about tone, style, or red/green flags‚Ä¶"></textarea>
      <div class="toolbar">
        <button id="aiUseDraftBtn" class="btn secondary" type="button">Use my draft</button>
        <button id="aiReviewBtn" class="btn" type="button">Review draft</button>
        <button id="aiAddNoteBtn" class="btn secondary" type="button">Add note</button>
        <button id="aiClearNotesBtn" class="btn secondary" type="button">Clear notes</button>
      </div>
      <div id="aiNotes" class="muted" style="font-size:13px; margin-top:8px;"></div>
    </section>

    <!-- Fakty (podglƒÖd tylko do weryfikacji sp√≥jno≈õci rdzenia) -->

    <section class="panel">
      <h2>Rdze≈Ñ zdarze≈Ñ ‚Äî <span class="muted">FAKTY (read-only)</span></h2>
      <div class="grid">
        <div>
          <label class="muted">Company</label>
          <input id="factsCompany" type="text" readonly/>
        </div>
        <div>
          <label class="muted">Role</label>
          <input id="factsRole" type="text" readonly/>
        </div>
      </div>
      <div class="grid" style="margin-top:10px;">
        <div>
          <label class="muted">From</label>
          <input id="factsFrom" type="text" readonly/>
        </div>
        <div>
          <label class="muted">To</label>
          <input id="factsTo" type="text" readonly/>
        </div>
      </div>
      <div style="margin-top:10px;">
        <label class="muted">Facts text</label>
        <div id="factsPreview" class="preview"></div>
      </div>
    </section>

        <!-- Dodawanie satyry (widoczne tylko dla autora i przy ?exp=...) -->
    <section id="addSatireBox" class="panel" style="display:none;">
      <h2>BEZ CENZURY (satyra)</h2>
      <p class="muted" style="margin:0 0 8px;">
        ‚ÄûTo wersja satyryczna o tych samych zdarzeniach; forma artystyczna bez wskazania os√≥b/firm.‚Äù
      </p>
            <textarea id="satireText" rows="8" placeholder="Te same zdarzenia, ale ostrym/sarkastycznym jƒôzykiem. Nie u≈ºywaj nazw w≈Çasnych, danych osobowych, NIP/KvK, adres√≥w ani link√≥w."></textarea>
      <div id="satireCharCount" class="muted" style="font-size:13px; margin-top:4px;">0 / 8000 characters</div>

      <div id="lintWarnings" class="warn" style="display:none;">
        <strong>Uwaga:</strong>
        <ul id="lintList"></ul>
      </div>

      <div class="toolbar">
        <button id="lintBtn" class="btn secondary" type="button">Lint (sprawd≈∫ identyfikatory)</button>
        <button id="toggleFactsBtn" class="btn secondary" type="button">üëÅÔ∏è Fakty</button>
        <button id="toggleSatireBtn" class="btn secondary" type="button">üëÅÔ∏è Bez cenzury</button>
        <button id="exportJsonBtn" class="btn secondary" type="button">Eksport JSON</button>
        <button id="publishBtn" class="btn" type="button">Publikuj</button>
      </div>

      <div style="margin-top:10px;">
        <label class="muted">PodglƒÖd</label>
        <div id="livePreview" class="preview"></div>
      </div>
    </section>

    <!-- Lista istniejƒÖcych satyr (zawsze widoczna) -->
    <section class="panel">
      <h2>Existing satires</h2>
      <div id="satireList" class="recent-list muted">No satires yet.</div>
    </section>

  </main>

    <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = window.__SUPABASE_URL || "https://xzwpqyomqjzmiqsszwkg.supabase.co";
    const SUPABASE_ANON_KEY = window.__SUPABASE_ANON_KEY || "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh6d3BxeW9tcWp6bWlxc3N6d2tnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0MjIxMTYsImV4cCI6MjA2OTk5ODExNn0.QbjDO1xifFkDuIAZZ9WHfGomgxwhanP9BQtgMrFqDgg";
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const $ = sel => document.querySelector(sel);
    function escapeHTML(s){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

    const url = new URL(location.href);
    const expId = url.searchParams.get("exp");
    const hostFacts = {
      company: $("#factsCompany"),
      role: $("#factsRole"),
      from: $("#factsFrom"),
      to: $("#factsTo"),
      text: $("#factsPreview")
    };
        const satireBox = $("#satireText");
        const previewBox = $("#livePreview");
    const charCountEl = $("#satireCharCount");


    // AI Assist elements
    const aiInputEl = $("#aiInput");
    const aiUseDraftBtn = $("#aiUseDraftBtn");
    const aiReviewBtn = $("#aiReviewBtn");
    const aiAddNoteBtn = $("#aiAddNoteBtn");
    const aiClearNotesBtn = $("#aiClearNotesBtn");
    const aiNotesEl = $("#aiNotes");

    // helper: per-user notes
    let _lastUserId = "anon";
    const NOTES_KEY = () => `satire_notes_${_lastUserId}`;
    function readNotes(){
      try{ return JSON.parse(localStorage.getItem(NOTES_KEY())||'[]'); }catch(e){ return []; }
    }
    function writeNotes(arr){
      localStorage.setItem(NOTES_KEY(), JSON.stringify(arr));
    }
    function renderNotes(){
      const notes = readNotes();
      if(!aiNotesEl) return;
      if(!notes.length){ aiNotesEl.innerHTML = '<small>No notes yet.</small>'; return; }
      aiNotesEl.innerHTML = '<small>Notes:</small><ul>' + notes.map(n=>`<li>${escapeHTML(n)}</li>`).join('') + '</ul>';
    }
    function addNote(text){
      const notes = readNotes();
      notes.unshift(text);
      writeNotes(notes.slice(0,30)); // cap
      renderNotes();
    }
    function buildAIContext(){
      const content = (satireBox.value||"").trim();
      const question = (aiInputEl?.value||"").trim();
      return `Satire context
Draft:
${content || '(no text yet)'}
---
Task: ${question || 'Review tone/legality, spot red/green flags, suggest neutral satirical wording without personal data.'}`;
    }
    function reviewDraftLocally(){
      const content = (satireBox.value||"").trim();
      const issues = [];

      if(content.length < 20){
        issues.push("Satire draft is very short. Add more detail.");
      }
      if(/\b\d{2,3}[-\s]?\d{3}[-\s]?\d{3,4}\b/.test(content)) issues.push("Possible phone number detected ‚Äî remove or anonymize.");
      if(/[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}/.test(content)) issues.push("Email detected ‚Äî remove.");
      if(/\b(ul\.|ulica|adres|address|street)\b/i.test(content)) issues.push("Address detected ‚Äî avoid precise locations.");
      if(/\bPESEL\b|\bBSN\b|\bNIP\b|\bVAT\b/i.test(content)) issues.push("Sensitive ID detected ‚Äî remove.");
      if(/\b[A-Z≈Å≈ö≈ª≈πƒÜ≈É][a-zƒÖƒáƒô≈Ç≈Ñ√≥≈õ≈∫≈º]+\s+[A-Z≈Å≈ö≈ª≈πƒÜ≈É][a-zƒÖƒáƒô≈Ç≈Ñ√≥≈õ≈∫≈º]+/.test(content)){
        issues.push("Full name found ‚Äî replace with generic role.");
      }
      const flagged = ["palant","idiota","debil","kasztan","z≈Çodziej","oszust","frajer"];
      const found = flagged.filter(w=> new RegExp(`\\b${w}\\b`, "i").test(content));
      if(found.length){
        issues.push(`Inflammatory words (${found.join(", ")}) ‚Äî use neutral tone.`);
      }
      if(/\b(sp\. z o\.o\.|bv|gmbh|inc|llc)\b/i.test(content)){
        issues.push("If you name a company, stick to verifiable facts and avoid accusations.");
      }

      if(!issues.length){ addNote("No obvious personal data or slurs detected."); }
      else issues.forEach(i=> addNote(i));

      aiInputEl.value = "Please help me rewrite my satire draft to be privacy-safe, but keep style sharp.";
      alert("Satire draft reviewed. See notes below.");
    }


    async function init(){
      if(!expId){ previewBox.textContent = "No experience selected."; return; }

            const { data: { session } } = await sb.auth.getSession();
      const user = session?.user;
      _lastUserId = user?.id || "anon";
      renderNotes();

      // AI Assist buttons
      if(aiReviewBtn) aiReviewBtn.addEventListener("click", reviewDraftLocally);
      if(aiAddNoteBtn) aiAddNoteBtn.addEventListener("click", () => {
        const note = prompt("Add a note:");
        if(note && note.trim()) addNote(note.trim());
      });
      if(aiClearNotesBtn) aiClearNotesBtn.addEventListener("click", () => {
        localStorage.removeItem(NOTES_KEY());
        renderNotes();
      });
      if(aiUseDraftBtn) aiUseDraftBtn.addEventListener("click", () => {
        aiInputEl.value = buildAIContext();
      });


      // pobierz fakty
      const { data: fact, error: err1 } = await sb
        .from("work_experiences")
        .select("id, author, company, role, period_from, period_to, content")
        .eq("id", expId)
        .maybeSingle();

      if(err1 || !fact){ previewBox.textContent = "Experience not found."; return; }

      // poka≈º fakty (readonly)
      hostFacts.company.value = fact.company || "";
      hostFacts.role.value = fact.role || "";
      hostFacts.from.value = fact.period_from || "";
      hostFacts.to.value = fact.period_to || "";
      hostFacts.text.textContent = fact.content || "(brak tre≈õci)";

      // pobierz satyrƒô
      const { data: satire } = await sb
        .from("work_experiences_satire")
        .select("id, author, content, created_at")
        .eq("original_id", fact.id)
        .maybeSingle();

            // === Warunki wy≈õwietlania formularza satyry ===
      const addBox = document.getElementById("addSatireBox");
      const listBox = document.getElementById("satireList");

      if (satire) {
        // istniejƒÖca satyra ‚Üí poka≈º w li≈õcie
        listBox.innerHTML = `<article class="recent-card"><p>${escapeHTML(satire.content)}</p></article>`;
      }

      if (user && String(user.id).trim() === String(fact.author).trim() && !satire) {

        // autor + brak satyry ‚Üí odblokuj formularz
        addBox.style.display = "block";
        satireBox.disabled = false;
        previewBox.textContent = "";
        $("#publishBtn").disabled = false;
        $("#publishBtn").onclick = async () => {

          const txt = (satireBox.value || "").trim();
          if (txt.length < 20) { alert("Satyra jest za kr√≥tka (min 20 znak√≥w)."); return; }
          const { error } = await sb.from("work_experiences_satire").insert({
            original_id: fact.id,
            author: user.id,
            content: txt
          });
          if (error) { alert("‚ùå Zapis nie powi√≥d≈Ç siƒô: " + (error.message || error)); return; }
          alert("‚úÖ Satyra zapisana.");
          location.reload();
        };
      } else {
        // 3) brak satyry + user ‚â† autor ‚Üí komunikat
        satireBox.value = "";
        satireBox.disabled = true;
        $("#publishBtn").disabled = true;
        previewBox.textContent = "Brak wersji satyrycznej.";
      }
            // live char counter
      satireBox.addEventListener("input", () => {
        const len = (satireBox.value || "").length;
        charCountEl.textContent = `${len} / 8000 characters`;
      });

    }

    document.addEventListener("DOMContentLoaded", init);
  </script>

</body>
</html>
